<!-- å¯¼èˆªæ ç»„ä»¶ -->
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="#">
            ğŸ¥ åŒ»é™¢é—¨è¯Šç®¡ç†ç³»ç»Ÿ
        </a>
        
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        
        <div class="collapse navbar-collapse" id="navbarNav">
            <!-- å¯¼èˆªèœå•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            <ul class="navbar-nav me-auto" id="main-nav">
                <!-- è¿™é‡Œçš„å†…å®¹å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </ul>
            
            <!-- ç”¨æˆ·ä¿¡æ¯éƒ¨åˆ† -->
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        ğŸ‘¤ <span id="user-name">ç”¨æˆ·</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="showMessage('ä¸ªäººè®¾ç½®åŠŸèƒ½å¼€å‘ä¸­', 'info')">ä¸ªäººè®¾ç½®</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="../patient/login.html" onclick="handleLogout()">é€€å‡ºç™»å½•</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<script>
    // å®šä¹‰å„è§’è‰²çš„èœå•é¡¹
    const roleMenus = {
        'patient': [
            { text: 'æ‚£è€…é¦–é¡µ', href: '../patient/dashboard.html', icon: 'ğŸ ' },
            { text: 'æŒ‚å·é¢„çº¦', href: '../patient/appointment.html', icon: 'ğŸ“…' },
            { text: 'å°±è¯Šè®°å½•', href: '../patient/medical-records.html', icon: 'ğŸ“‹' },
            { text: 'æˆ‘çš„å¤„æ–¹', href: '../patient/prescriptions.html', icon: 'ğŸ’Š' },
            { text: 'ä¸ªäººä¿¡æ¯', href: '../patient/profile.html', icon: 'ğŸ‘¤' }
        ],
        'admin': [
            { text: 'ç®¡ç†é¦–é¡µ', href: '../admin/dashboard.html', icon: 'âš™ï¸' },
            { text: 'èŒå·¥ç®¡ç†', href: '../admin/staff-management.html', icon: 'ğŸ‘¥' },
            { text: 'ç§‘å®¤ç®¡ç†', href: '../admin/department-management.html', icon: 'ğŸ¢' },
            { text: 'è¯å“ç®¡ç†', href: '../admin/medicine-management.html', icon: 'ğŸ’Š' },
            { text: 'è´¢åŠ¡ä¸­å¿ƒ', href: '../admin/finance-center.html', icon: 'ğŸ’°' },
            { text: 'ç°åœºæŒ‚å·', href: '../admin/on-site-registration.html', icon: 'ğŸ“' },
            { text: 'è¯å“å…¥åº“', href: '../admin/medicine-stock.html', icon: 'ğŸ“¦' },
            { text: 'æ’ç­ç®¡ç†', href: '../admin/schedule-management.html', icon: 'ğŸ“…' }
        ],
        'doctor': [
            { text: 'åŒ»ç”Ÿé¦–é¡µ', href: '../doctor/dashboard.html', icon: 'ğŸ©º' },
            { text: 'ç”µå­ç—…å†', href: '../doctor/medical-record.html', icon: 'ğŸ“„' },
            { text: 'å¼€å…·å¤„æ–¹', href: '../doctor/prescription.html', icon: 'ğŸ“' }
        ],
        'pharmacist': [
            { text: 'è¯æˆ¿é¦–é¡µ', href: '../pharmacist/dashboard.html', icon: 'ğŸª' },
            { text: 'åº“å­˜ç®¡ç†', href: '../pharmacist/inventory.html', icon: 'ğŸ“¦' },
            { text: 'å¤„æ–¹å‘è¯', href: '../pharmacist/prescriptions.html', icon: 'ğŸ’Š' }
        ]
    };

    // è§’è‰²æ˜¾ç¤ºåç§°
    const roleDisplayNames = {
        'patient': 'æ‚£è€…',
        'admin': 'ç®¡ç†å‘˜',
        'doctor': 'åŒ»ç”Ÿ',
        'pharmacist': 'è¯å‰‚å¸ˆ'
    };

    // ç”Ÿæˆå¯¼èˆªèœå•
    function generateNavigation() {
        console.log('å¼€å§‹ç”Ÿæˆå¯¼èˆªèœå•...');
        
        // 1. è·å–å½“å‰è§’è‰²ï¼ˆå¤šç§æ–¹å¼å°è¯•ï¼‰
        let currentRole = null;
        
        // æ–¹å¼1ï¼šä»URLè·¯å¾„åˆ¤æ–­
        const path = window.location.pathname;
        console.log('å½“å‰è·¯å¾„:', path);
        
        if (path.includes('/admin/')) {
            currentRole = 'admin';
            console.log('ä»è·¯å¾„åˆ¤æ–­ä¸º: ç®¡ç†å‘˜');
        } else if (path.includes('/doctor/')) {
            currentRole = 'doctor';
            console.log('ä»è·¯å¾„åˆ¤æ–­ä¸º: åŒ»ç”Ÿ');
        } else if (path.includes('/pharmacist/')) {
            currentRole = 'pharmacist';
            console.log('ä»è·¯å¾„åˆ¤æ–­ä¸º: è¯å‰‚å¸ˆ');
        } else if (path.includes('/patient/')) {
            currentRole = 'patient';
            console.log('ä»è·¯å¾„åˆ¤æ–­ä¸º: æ‚£è€…');
        }
        
        // æ–¹å¼2ï¼šä»localStorageè·å–ï¼ˆå¦‚æœç™»å½•æ—¶å·²ä¿å­˜ï¼‰
        const savedRole = localStorage.getItem('userRole');
        if (savedRole) {
            currentRole = savedRole;
            console.log('ä»localStorageè·å–è§’è‰²:', savedRole);
        }
        
        // æ–¹å¼3ï¼šä»é¡µé¢æ ‡é¢˜åˆ¤æ–­
        if (!currentRole) {
            const title = document.title;
            if (title.includes('ç®¡ç†å‘˜')) currentRole = 'admin';
            else if (title.includes('åŒ»ç”Ÿ')) currentRole = 'doctor';
            else if (title.includes('è¯å‰‚å¸ˆ')) currentRole = 'pharmacist';
            else if (title.includes('æ‚£è€…')) currentRole = 'patient';
        }
        
        // é»˜è®¤è§’è‰²
        if (!currentRole) {
            currentRole = 'patient';
            console.log('ä½¿ç”¨é»˜è®¤è§’è‰²: æ‚£è€…');
        }
        
        console.log('æœ€ç»ˆç¡®å®šè§’è‰²:', currentRole);
        
        // 2. ç”Ÿæˆèœå•HTML
        const menuItems = roleMenus[currentRole] || roleMenus.patient;
        let menuHTML = '';
        
        menuItems.forEach(item => {
            menuHTML += `
                <li class="nav-item">
                    <a class="nav-link" href="${item.href}">
                        ${item.icon} ${item.text}
                    </a>
                </li>
            `;
        });
        
        // 3. æ›´æ–°DOM
        const mainNav = document.getElementById('main-nav');
        if (mainNav) {
            mainNav.innerHTML = menuHTML;
            console.log('èœå•å·²æ›´æ–°ï¼Œé¡¹ç›®æ•°:', menuItems.length);
        }
        
        // 4. æ›´æ–°è§’è‰²æŒ‡ç¤ºå™¨ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
        const roleIndicator = document.getElementById('role-indicator');
        if (roleIndicator) {
            roleIndicator.textContent = `[${roleDisplayNames[currentRole]}]`;
        }
        
        // 5. æ›´æ–°ç”¨æˆ·å
        const userNameElement = document.getElementById('user-name');
        if (userNameElement) {
            // å°è¯•ä»å„ç§å¯èƒ½çš„å­˜å‚¨ä½ç½®è·å–ç”¨æˆ·å
            let userName = 'ç”¨æˆ·';
            
            // æ‚£è€…
            try {
                const userInfo = JSON.parse(localStorage.getItem('userInfo'));
                if (userInfo && userInfo.patientName) userName = userInfo.patientName;
            } catch(e) {}
            
            // åŒ»ç”Ÿã€ç®¡ç†å‘˜ã€è¯å‰‚å¸ˆ
            try {
                const staffInfo = JSON.parse(localStorage.getItem('staffInfo'));
                if (staffInfo && staffInfo.staffName) userName = staffInfo.staffName;
            } catch(e) {}
            
            try {
                const doctorInfo = JSON.parse(localStorage.getItem('doctorInfo'));
                if (doctorInfo && doctorInfo.staffName) userName = doctorInfo.staffName;
            } catch(e) {}
            
            try {
                const pharmacistInfo = JSON.parse(localStorage.getItem('pharmacistInfo'));
                if (pharmacistInfo && pharmacistInfo.staffName) userName = pharmacistInfo.staffName;
            } catch(e) {}
            
            userNameElement.textContent = userName;
        }
        
        return currentRole;
    }

    // é€€å‡ºç™»å½•å¤„ç†
    function handleLogout() {
        console.log('é€€å‡ºç™»å½•');
        
        // æ¸…é™¤æ‰€æœ‰ç™»å½•ä¿¡æ¯
        localStorage.removeItem('token');
        localStorage.removeItem('userRole');
        localStorage.removeItem('userInfo');
        localStorage.removeItem('staffInfo');
        localStorage.removeItem('doctorInfo');
        localStorage.removeItem('pharmacistInfo');
        
        // è·³è½¬åˆ°ç™»å½•é¡µé¢
        window.location.href = '../patient/login.html';
        
        // é˜»æ­¢é»˜è®¤é“¾æ¥è¡Œä¸º
        return false;
    }

    // é¡µé¢åŠ è½½æ—¶ç«‹å³ç”Ÿæˆå¯¼èˆª
    console.log('é¡µé¢åŠ è½½ï¼Œå¼€å§‹åˆå§‹åŒ–å¯¼èˆª...');
    
    // ç«‹å³æ‰§è¡Œä¸€æ¬¡
    setTimeout(() => {
        generateNavigation();
    }, 10);
    
    // DOMåŠ è½½å®Œæˆåå†æ¬¡æ‰§è¡Œç¡®ä¿æ­£ç¡®
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMåŠ è½½å®Œæˆï¼Œé‡æ–°ç”Ÿæˆå¯¼èˆª...');
        generateNavigation();
    });
    
    // å¦‚æœæ˜¯å¼‚æ­¥åŠ è½½ï¼Œæ·»åŠ ä¸€ä¸ªç›‘å¬å™¨
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', generateNavigation);
    } else {
        generateNavigation();
    }
</script>