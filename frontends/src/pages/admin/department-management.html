<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘å®¤ç®¡ç† - åŒ»é™¢é—¨è¯Šç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../../styles/common.css">
    <style>
        :root {
            --sidebar-bg: #2c3e50;
            --main-bg: #f0f4f7;
            --primary-color: #4CA1AF;
            --accent-color: #C4E0E5;
            --text-main: #2c3e50;
            --white: #ffffff;
        }

        body {
            background-color: var(--main-bg);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, sans-serif;
            margin: 0;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 220px;
            background: var(--sidebar-bg);
            color: rgba(255,255,255,0.8);
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .sidebar-brand {
            padding: 25px 20px;
            font-weight: 700;
            color: var(--white);
            background: rgba(0,0,0,0.15);
            font-size: 1.1rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .nav-link {
            padding: 14px 22px;
            color: inherit;
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: 0.2s;
            font-size: 0.9rem;
        }

        .nav-link i { width: 28px; font-size: 1.1rem; }
        .nav-link:hover, .nav-link.active {
            background: var(--primary-color);
            color: white;
        }

        .main-content {
            flex: 1;
            margin-left: 220px;
            padding: 25px 35px;
        }

        .dept-card {
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
        }
        .dept-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        }
        .stats-card {
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body>
<div class="app-container">
    <aside class="sidebar">
        <div class="sidebar-brand">HOSPITAL ADMIN</div>
        <nav class="mt-3">
            <a href="dashboard.html" class="nav-link"><i class="fa-solid fa-chart-pie"></i> å·¥ä½œå°æ¦‚è§ˆ</a>
            <a href="staff-management.html" class="nav-link"><i class="fa-solid fa-user-doctor"></i> èŒå·¥ç®¡ç†</a>
            <a href="department-management.html" class="nav-link active"><i class="fa-solid fa-hospital-user"></i> ç§‘å®¤é…ç½®</a>
            <a href="medicine-management.html" class="nav-link"><i class="fa-solid fa-pills"></i> è¯å“ç®¡ç†</a>
            <a href="medicine-stock.html" class="nav-link"><i class="fa-solid fa-box-open"></i> è¯å“å…¥åº“</a>
            <a href="finance-center.html" class="nav-link"><i class="fa-solid fa-file-invoice-dollar"></i> è´¢åŠ¡ç»“ç®—</a>
            <a href="on-site-registration.html" class="nav-link"><i class="fa-solid fa-id-card"></i> ç°åœºæŒ‚å·</a>
        </nav>
    </aside>

    <main class="main-content">
        <div class="container mt-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <a href="dashboard.html" class="btn btn-outline-secondary me-2">ğŸ  é¦–é¡µ</a>
                <h2>ğŸ¢ ç§‘å®¤ç®¡ç†</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDeptModal">
                    <i class="bi bi-plus-lg"></i> æ·»åŠ ç§‘å®¤
                </button>
            </div>

            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center stats-card">
                        <div class="card-body">
                            <div class="h4 text-primary" id="stat-dept-count">-</div>
                            <div class="text-muted">ç§‘å®¤æ€»æ•°</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center stats-card">
                        <div class="card-body">
                            <div class="h4 text-success" id="stat-doc-count">-</div>
                            <div class="text-muted">åœ¨èŒåŒ»ç”Ÿ</div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h5 class="card-title mb-0">ç§‘å®¤åˆ—è¡¨</h5>
                    <div class="input-group" style="width: 300px;">
                        <input type="text" class="form-control" placeholder="æœç´¢ç§‘å®¤åç§°..." id="searchDept">
                        <button class="btn btn-outline-secondary" type="button"><i class="bi bi-search"></i></button>
                    </div>
                </div>
                <div class="card-body bg-light">
                    <div class="row" id="deptList">
                        <div class="col-12 text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½æ•°æ®...</p>
                        </div>
                    </div>
                </div>
            </div>


        </div>
    </main>
</div>

<div class="modal fade" id="addDeptModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ·»åŠ æ–°ç§‘å®¤</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addDeptForm">
                    <div class="mb-3">
                        <label class="form-label">ç§‘å®¤åç§° <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="deptName" required placeholder="ä¾‹å¦‚ï¼šçš®è‚¤ç§‘">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ç§‘å®¤ä¸»ä»»</label>
                        <select class="form-select" id="deptHead">
                            <option value="">æ­£åœ¨åŠ è½½åŒ»ç”Ÿåˆ—è¡¨...</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">é—¨è¯Šæ—¶é—´</label>
                        <input type="text" class="form-control" id="deptHours" placeholder="ä¾‹å¦‚ï¼šå‘¨ä¸€è‡³å‘¨äº” 08:00-17:00">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ç§‘å®¤æè¿°</label>
                        <textarea class="form-control" id="deptDescription" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="addDepartment()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deptDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ç§‘å®¤è¯¦æƒ… - <span id="detailDeptName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <strong>ç§‘å®¤ID:</strong> <span id="detailDeptCode" class="text-muted ms-2"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>ç§‘å®¤ä¸»ä»»:</strong> <span id="detailDeptHead" class="text-primary fw-bold ms-2"></span>
                    </div>
                    <div class="col-md-12 mt-3">
                        <strong>é—¨è¯Šæ—¶é—´:</strong> <span id="detailDeptHours" class="text-secondary ms-2"></span>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-12">
                        <strong>ç§‘å®¤æè¿°:</strong>
                        <div id="detailDeptDescription" class="mt-2 p-3 bg-light rounded text-secondary border"></div>
                    </div>
                </div>

                <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-people-fill"></i> ç§‘å®¤åŒ»ç”Ÿåˆ—è¡¨</h6>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead class="table-light">
                        <tr>
                            <th>å§“å</th>
                            <th>èŒç§°</th>
                            <th>è§’è‰²</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                        </thead>
                        <tbody id="deptDoctorsList">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../../utils/helpers.js"></script>

<script>
    const API_BASE = 'http://localhost:8081';
    let departments = [];

    document.addEventListener('DOMContentLoaded', function() {
        fetchDepartments();
        loadDoctorsForSelect();
        updateStats();
        setupSearch();
    });

    async function fetchDepartments() {
        const token = localStorage.getItem('token');
        if (!token) return window.location.href = '../admin/login.html';

        try {
            const response = await fetch(`${API_BASE}/department`, {
                headers: { 'Authorization': token }
            });
            const result = await response.json();

            if (result.code === 200) {
                departments = result.data;
                renderDepartmentCards(departments);
                // å®æ—¶æ›´æ–°ç§‘å®¤æ€»æ•°ç»Ÿè®¡
                document.getElementById('stat-dept-count').textContent = departments.length;
            } else {
                showMessage('æ•°æ®åŠ è½½å¤±è´¥: ' + result.message, 'error');
            }
        } catch (error) {
            console.error(error);
            document.getElementById('deptList').innerHTML =
                '<div class="col-12 text-center text-danger py-5">æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨</div>';
        }
    }

    function renderDepartmentCards(data) {
        const container = document.getElementById('deptList');
        if (!data || data.length === 0) {
            container.innerHTML = '<div class="col-12 text-center text-muted py-5">æš‚æ— ç§‘å®¤æ•°æ®ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’æ·»åŠ </div>';
            return;
        }

        container.innerHTML = data.map(dept => `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card dept-card h-100 bg-white border-0 shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title fw-bold text-dark mb-0">${dept.deptName}</h5>
                                <span class="badge bg-success bg-opacity-10 text-success">æ­£å¸¸</span>
                            </div>

                            <div class="small text-muted mb-2">
                                <i class="bi bi-person-badge me-1"></i>
                                ä¸»ä»»: <span class="text-dark">${dept.managerName || 'æœªè®¾ç½®'}</span>
                            </div>
                            <div class="small text-muted mb-3">
                                <i class="bi bi-clock me-1"></i>
                                æ—¶é—´: <span>${dept.workHours || 'æœªè®¾ç½®'}</span>
                            </div>

                            <p class="card-text text-secondary small text-truncate-2" style="min-height: 40px;">
                                ${dept.description || 'æš‚æ— è¯¦ç»†æè¿°'}
                            </p>

                            <div class="d-grid mt-3">
                                <button class="btn btn-outline-primary btn-sm rounded-pill" onclick="viewDeptDetail(${dept.deptId})">
                                    æŸ¥çœ‹è¯¦æƒ…
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
    }

    async function addDepartment() {
        const name = document.getElementById('deptName').value.trim();
        const desc = document.getElementById('deptDescription').value.trim();
        const head = document.getElementById('deptHead').value;
        const hours = document.getElementById('deptHours').value.trim();

        if (!name) {
            showMessage('è¯·è¾“å…¥ç§‘å®¤åç§°', 'warning');
            return;
        }

        const payload = {
            deptName: name,
            description: desc,
            managerId: head || null,  // å¯¹åº”åç«¯ Integer managerId
            workHours: hours          // å¯¹åº”åç«¯ String workHours
        };

        try {
            const response = await fetch(`${API_BASE}/department`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': localStorage.getItem('token')
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();

            if (result.code === 200) {
                showMessage('æ·»åŠ æˆåŠŸï¼', 'success');

                bootstrap.Modal.getInstance(document.getElementById('addDeptModal')).hide();

                document.getElementById('addDeptForm').reset();

                fetchDepartments();
            } else {
                showMessage(result.message || 'æ·»åŠ å¤±è´¥', 'error');
            }
        } catch (error) {
            showMessage('ç½‘ç»œè¯·æ±‚é”™è¯¯', 'error');
        }
    }

    async function viewDeptDetail(deptId) {
        const dept = departments.find(d => d.deptId === deptId);
        if (!dept) return;

        document.getElementById('detailDeptName').textContent = dept.deptName;
        document.getElementById('detailDeptCode').textContent = dept.deptId;
        document.getElementById('detailDeptHead').textContent = dept.managerName || 'æš‚æœªè®¾ç½®';
        document.getElementById('detailDeptHours').textContent = dept.workHours || 'æš‚æœªè®¾ç½®'; // æ–°å¢
        document.getElementById('detailDeptDescription').textContent = dept.description || 'æš‚æ— æè¿°';

        const tbody = document.getElementById('deptDoctorsList');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3"><div class="spinner-border spinner-border-sm text-secondary"></div> <span class="text-muted ms-2">æ­£åœ¨åŠ è½½äººå‘˜...</span></td></tr>';

        const modal = new bootstrap.Modal(document.getElementById('deptDetailModal'));
        modal.show();

        try {
            // æŸ¥è¯¢è¯¥ç§‘å®¤ä¸‹çš„æ‰€æœ‰å‘˜å·¥
            const response = await fetch(`${API_BASE}/staff?deptId=${deptId}&page=1&pageSize=100`, {
                headers: { 'Authorization': localStorage.getItem('token') }
            });
            const result = await response.json();

            if (result.code === 200 && result.data.records.length > 0) {
                // ç­›é€‰å‡ºåŒ»ç”Ÿè§’è‰²çš„å‘˜å·¥
                const doctors = result.data.records.filter(s => s.role && s.role.includes('åŒ»'));

                if(doctors.length > 0) {
                    tbody.innerHTML = doctors.map(doc => `
                            <tr>
                                <td class="fw-bold">${doc.staffName}</td>
                                <td>${doc.title || '-'}</td>
                                <td><span class="badge bg-info text-dark">${doc.role}</span></td>
                                <td><span class="badge bg-success">åœ¨èŒ</span></td>
                            </tr>
                        `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3 text-muted">è¯¥ç§‘å®¤æš‚æ— åŒ»ç”Ÿè®°å½•</td></tr>';
                }
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3 text-muted">è¯¥ç§‘å®¤æš‚æ— äººå‘˜è®°å½•</td></tr>';
            }
        } catch (error) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-3">åŠ è½½äººå‘˜åˆ—è¡¨å¤±è´¥</td></tr>';
        }
    }

    async function loadDoctorsForSelect() {
        try {
            const response = await fetch(`${API_BASE}/staff?page=1&pageSize=200`, {
                headers: { 'Authorization': localStorage.getItem('token') }
            });
            const result = await response.json();
            if(result.code === 200) {
                const select = document.getElementById('deptHead');
                const doctors = result.data.records.filter(s => s.role && s.role.includes('åŒ»'));

                select.innerHTML = '<option value="">è¯·é€‰æ‹©ç§‘å®¤ä¸»ä»»</option>' +
                    doctors.map(d => `<option value="${d.staffId}">${d.staffName} (${d.title || d.role})</option>`).join('');
            }
        } catch(e) { console.error('åŠ è½½åŒ»ç”Ÿä¸‹æ‹‰æ¡†å¤±è´¥', e); }
    }

    async function updateStats() {
        try {
            // æŸ¥è¯¢åŒ»ç”Ÿæ€»æ•°
            const response = await fetch(`${API_BASE}/staff?role=åŒ»ç”Ÿ&page=1&pageSize=1`, {
                headers: { 'Authorization': localStorage.getItem('token') }
            });
            const result = await response.json();
            if(result.code === 200) {
                document.getElementById('stat-doc-count').textContent = result.data.total;
            }
        } catch(e) { console.log('ç»Ÿè®¡åŠ è½½å¤±è´¥'); }
    }


    function setupSearch() {
        document.getElementById('searchDept').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = departments.filter(d => d.deptName.toLowerCase().includes(term));
            renderDepartmentCards(filtered);
        });
    }
</script>
</body>
</html>
