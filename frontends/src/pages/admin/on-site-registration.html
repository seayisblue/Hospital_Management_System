<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°åœºæŒ‚å· - åŒ»é™¢é—¨è¯Šç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/common.css">
    <style>
        .schedule-card {
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #dee2e6;
        }
        .schedule-card:hover {
            border-color: #667eea;
            background-color: #f8f9fa;
        }
        .schedule-card.selected {
            border-color: #667eea;
            background-color: #eef2ff;
            position: relative;
        }
        .schedule-card.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 5px;
            right: 10px;
            color: #667eea;
            font-weight: bold;
        }
        .patient-info-card {
            background-color: #f8f9fa;
            border-left: 4px solid #667eea;
        }
    </style>
</head>
<body>
<div id="navbar-container"></div>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="dashboard.html" class="btn btn-outline-secondary">ğŸ  é¦–é¡µ</a>
        </div>
        <div>
            <h2 class="mb-0">ğŸ« ç°åœºæŒ‚å·åŠç†</h2>
        </div>
        <div class="invisible">
            <a href="#" class="btn btn-outline-secondary">ğŸ  é¦–é¡µ</a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">1. æŸ¥æ‰¾æ‚£è€…</h5>
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="searchKeyword" placeholder="è¾“å…¥å§“åæˆ–æ‰‹æœºå·">
                        <button class="btn btn-primary" onclick="searchPatient()">æœç´¢</button>
                    </div>

                    <div class="list-group mb-3" id="patientResults" style="max-height: 200px; overflow-y: auto; display: none;">
                    </div>

                    <div id="selectedPatientInfo" class="d-none">
                        <div class="card patient-info-card">
                            <div class="card-body">
                                <h5 class="card-title" id="pName">-</h5>
                                <p class="card-text mb-1">æ€§åˆ«: <span id="pGender">-</span></p>
                                <p class="card-text mb-1">ç”µè¯: <span id="pPhone">-</span></p>
                                <p class="card-text mb-0">èº«ä»½è¯: <span id="pIdCard">-</span></p>
                            </div>
                        </div>
                        <div class="alert alert-success mt-2 mb-0 py-2">
                            <small>âœ… å·²é€‰ä¸­æ‚£è€… (ID: <span id="pId">-</span>)</small>
                        </div>
                    </div>

                    <div id="noPatientTip" class="alert alert-warning mt-3 d-none">
                        æœªæ‰¾åˆ°æ‚£è€…ï¼Ÿ<a href="../patient/register.html" target="_blank">å»æ³¨å†Œæ–°è´¦å·</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">2. é€‰æ‹©æ’ç­</h5>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="deptSelect" style="width: 150px;" onchange="fetchSchedules()">
                            <option value="">æ‰€æœ‰ç§‘å®¤</option>
                        </select>
                        <input type="date" class="form-control form-control-sm" id="dateSelect" onchange="fetchSchedules()">
                    </div>
                </div>
                <div class="card-body">
                    <div class="row" id="scheduleList">
                        <div class="col-12 text-center text-muted p-5">è¯·å…ˆé€‰æ‹©ç§‘å®¤æˆ–æ—¥æœŸæŸ¥è¯¢æ’ç­</div>
                    </div>
                </div>
                <div class="card-footer text-end">
                    <div class="d-flex justify-content-end align-items-center">
                        <div class="me-3">
                            <span class="text-muted">æŒ‚å·è´¹ï¼š</span>
                            <span class="h4 text-danger mb-0">Â¥15.00</span>
                        </div>
                        <button class="btn btn-primary btn-lg" onclick="submitAppointment()">ç¡®è®¤æŒ‚å·</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../../utils/helpers.js"></script>

<script>
    // å…¨å±€å˜é‡
    let currentPatientId = null;
    let selectedScheduleId = null;
    let adminId = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadNavbar();
        loadDepartments(); // åŠ è½½ç§‘å®¤ä¸‹æ‹‰æ¡†

        // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨é»˜è®¤å€¼ä¸ºä»Šå¤©
        document.getElementById('dateSelect').valueAsDate = new Date();

        //ä»¥æ­¤è·å–ç®¡ç†å‘˜ID (è™½ç„¶æ¥å£å¯èƒ½ä¸å¼ºæ ¡éªŒï¼Œä½†ä¸ºäº†æ•°æ®å®Œæ•´æ€§)
        const staffInfo = JSON.parse(localStorage.getItem('staffInfo') || '{}');
        adminId = staffInfo.staffId;
    });

    // 1. æœç´¢æ‚£è€…
    async function searchPatient() {
        const keyword = document.getElementById('searchKeyword').value;
        if (!keyword) {
            showMessage('è¯·è¾“å…¥æœç´¢å…³é”®å­—', 'warning');
            return;
        }

        try {
            const response = await fetch(`http://localhost:8081/patient/search?keyword=${encodeURIComponent(keyword)}`, {
                method: 'GET',
                headers: { 'Authorization': localStorage.getItem('token') }
            });
            const result = await response.json();

            const resultsDiv = document.getElementById('patientResults');
            const noPatientTip = document.getElementById('noPatientTip');

            resultsDiv.style.display = 'none';
            document.getElementById('selectedPatientInfo').classList.add('d-none');
            currentPatientId = null;

            if (result.code === 200 && result.data.length > 0) {
                // å¦‚æœåªæœ‰ä¸€ä¸ªç»“æœï¼Œç›´æ¥é€‰ä¸­
                if (result.data.length === 1) {
                    selectPatient(result.data[0]);
                } else {
                    // æ˜¾ç¤ºåˆ—è¡¨ä¾›é€‰æ‹©
                    resultsDiv.innerHTML = result.data.map(p => `
                            <a href="#" class="list-group-item list-group-item-action" onclick='selectPatient(${JSON.stringify(p)})'>
                                <strong>${p.patientName}</strong> - ${p.phoneNumber}
                                <br><small class="text-muted">${p.idCardNumber}</small>
                            </a>
                        `).join('');
                    resultsDiv.style.display = 'block';
                }
                noPatientTip.classList.add('d-none');
            } else {
                noPatientTip.classList.remove('d-none');
            }
        } catch (error) {
            console.error(error);
            showMessage('æœç´¢å¤±è´¥', 'error');
        }
    }

    // é€‰ä¸­æ‚£è€…
    function selectPatient(patient) {
        currentPatientId = patient.patientId;

        // å¡«å……ä¿¡æ¯
        document.getElementById('pName').textContent = patient.patientName;
        document.getElementById('pGender').textContent = patient.gender;
        document.getElementById('pPhone').textContent = patient.phoneNumber;
        document.getElementById('pIdCard').textContent = patient.idCardNumber;
        document.getElementById('pId').textContent = patient.patientId;

        // æ˜¾ç¤ºå¡ç‰‡ï¼Œéšè—åˆ—è¡¨
        document.getElementById('selectedPatientInfo').classList.remove('d-none');
        document.getElementById('patientResults').style.display = 'none';
        document.getElementById('noPatientTip').classList.add('d-none');
    }

    // 2. åŠ è½½ç§‘å®¤
    async function loadDepartments() {
        try {
            const response = await fetch('http://localhost:8081/department', {
                headers: { 'Authorization': localStorage.getItem('token') }
            });
            const result = await response.json();
            if (result.code === 200) {
                const select = document.getElementById('deptSelect');
                // ä¿ç•™ç¬¬ä¸€ä¸ª"æ‰€æœ‰ç§‘å®¤"é€‰é¡¹
                select.innerHTML = '<option value="">æ‰€æœ‰ç§‘å®¤</option>' +
                    result.data.map(d => `<option value="${d.deptId}">${d.deptName}</option>`).join('');

                // é»˜è®¤åŠ è½½ä¸€æ¬¡æ’ç­
                fetchSchedules();
            }
        } catch (e) { console.error(e); }
    }

    // 3. æŸ¥è¯¢æ’ç­
    async function fetchSchedules() {
        const deptId = document.getElementById('deptSelect').value;
        const date = document.getElementById('dateSelect').value;

        let url = `http://localhost:8081/appointment/schedules?startDate=${date}`;
        if (deptId) url += `&deptId=${deptId}`;

        try {
            const response = await fetch(url, {
                headers: { 'Authorization': localStorage.getItem('token') }
            });
            const result = await response.json();

            const container = document.getElementById('scheduleList');
            if (result.code === 200 && result.data.length > 0) {
                container.innerHTML = result.data.map(s => `
                        <div class="col-md-6 mb-3">
                            <div class="card schedule-card" onclick="selectSchedule(this, ${s.scheduleId})">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <strong>${s.deptName} - ${s.staffName}</strong>
                                        <span class="badge bg-info text-dark">${s.timeSlot}</span>
                                    </div>
                                    <div class="mt-2 small text-muted">
                                        èŒç§°: ${s.title || 'åŒ»å¸ˆ'} <br>
                                        ä½™å·: <span class="text-success fw-bold">${s.availableSlots}</span> / ${s.totalSlots}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
            } else {
                container.innerHTML = '<div class="col-12 text-center text-muted p-4">æš‚æ— æ’ç­ä¿¡æ¯</div>';
            }
            selectedScheduleId = null; // é‡ç½®é€‰ä¸­
        } catch (e) {
            console.error(e);
            showMessage('æ’ç­åŠ è½½å¤±è´¥', 'error');
        }
    }

    function selectSchedule(el, id) {
        document.querySelectorAll('.schedule-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');
        selectedScheduleId = id;
    }

    // 4. æäº¤ç°åœºæŒ‚å·
    async function submitAppointment() {
        if (!currentPatientId) {
            showMessage('è¯·å…ˆæœç´¢å¹¶é€‰ä¸­æ‚£è€…', 'warning');
            return;
        }
        if (!selectedScheduleId) {
            showMessage('è¯·é€‰æ‹©ä¸€ä¸ªæ’ç­', 'warning');
            return;
        }

        if (!confirm('ç¡®è®¤æŒ‚å·ä¿¡æ¯æ— è¯¯å¹¶æäº¤ï¼Ÿ')) return;

        try {
            // æ¥å£: POST /admin/appointment/onsite
            const response = await fetch('http://localhost:8081/admin/appointment/onsite', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': localStorage.getItem('token')
                },
                body: JSON.stringify({
                    patientId: currentPatientId,
                    scheduleId: selectedScheduleId,
                    operatorId: adminId // ç®¡ç†å‘˜ID
                })
            });

            const result = await response.json();

            if (result.code === 200) {
                showMessage('æŒ‚å·æˆåŠŸï¼è¯·æé†’æ‚£è€…å‰å¾€å°±è¯Š', 'success');
                // åˆ·æ–°æ’ç­ï¼ˆå·æºå‡å°‘ï¼‰
                fetchSchedules();
                // ä¹Ÿå¯ä»¥é€‰æ‹©é‡ç½®æ‚£è€…é€‰æ‹©
                // currentPatientId = null;
                // document.getElementById('selectedPatientInfo').classList.add('d-none');
            } else {
                showMessage('æŒ‚å·å¤±è´¥: ' + result.message, 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç³»ç»Ÿé”™è¯¯', 'error');
        }
    }
</script>
</body>
</html>