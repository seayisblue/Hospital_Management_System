<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ç­ç®¡ç† - åŒ»é™¢é—¨è¯Šç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/common.css">
</head>
<body>
<div id="navbar-container"></div>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ğŸ“… åŒ»ç”Ÿæ’ç­ç®¡ç†</h2>
        <button class="btn btn-primary" onclick="openAddModal()">
            â• æ–°å¢æ’ç­
        </button>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <select class="form-select" id="searchDept" onchange="loadDoctors(this.value, 'searchDoctor')">
                        <option value="">æ‰€æœ‰ç§‘å®¤</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="searchDoctor">
                        <option value="">æ‰€æœ‰åŒ»ç”Ÿ</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="date" class="form-control" id="searchDate">
                </div>
                <div class="col-md-3">
                    <button class="btn btn-primary w-100" onclick="fetchSchedules()">æŸ¥è¯¢</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>æ—¶æ®µ</th>
                        <th>ç§‘å®¤</th>
                        <th>åŒ»ç”Ÿ</th>
                        <th>èŒç§°</th>
                        <th>å·²æŒ‚/æ€»å·</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody id="scheduleTable">
                    </tbody>
                </table>
            </div>
            <nav class="mt-3">
                <ul class="pagination justify-content-center" id="pagination"></ul>
            </nav>
        </div>
    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ–°å¢æ’ç­</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addForm">
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©ç§‘å®¤</label>
                        <select class="form-select" id="modalDept" required onchange="loadDoctors(this.value, 'modalStaff')">
                            <option value="">è¯·é€‰æ‹©ç§‘å®¤</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©åŒ»ç”Ÿ</label>
                        <select class="form-select" id="modalStaff" name="staffId" required>
                            <option value="">è¯·å…ˆé€‰æ‹©ç§‘å®¤</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ’ç­æ—¥æœŸ</label>
                        <input type="date" class="form-control" name="scheduleDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ—¶æ®µ</label>
                        <select class="form-select" name="timeSlot" required>
                            <option value="ä¸Šåˆ">ä¸Šåˆ</option>
                            <option value="ä¸‹åˆ">ä¸‹åˆ</option>
                            <option value="æ™šä¸Š">æ™šä¸Š</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ€»å·æºæ•°</label>
                        <input type="number" class="form-control" name="totalSlots" value="30" min="1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitAdd()">æäº¤</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../../utils/helpers.js"></script>

<script>
    let scheduleList = [];
    let currentPage = 1;

    document.addEventListener('DOMContentLoaded', function() {
        loadNavbar();
        loadDepartments(); // åŠ è½½ç§‘å®¤é€‰é¡¹
        fetchSchedules();  // åŠ è½½åˆ—è¡¨
    });

    // 1. åŠ è½½ç§‘å®¤ (ç”¨äºä¸‹æ‹‰æ¡†)
    async function loadDepartments() {
        try {
            const response = await fetch('http://localhost:8081/department', {
                headers: { 'Authorization': localStorage.getItem('token') }
            });
            const result = await response.json();
            if (result.code === 200) {
                const options = '<option value="">æ‰€æœ‰ç§‘å®¤</option>' +
                    result.data.map(d => `<option value="${d.deptId}">${d.deptName}</option>`).join('');

                // å¡«å……æœç´¢æ¡†å’Œæ¨¡æ€æ¡†çš„ç§‘å®¤ä¸‹æ‹‰
                document.getElementById('searchDept').innerHTML = options;
                document.getElementById('modalDept').innerHTML = options.replace('æ‰€æœ‰ç§‘å®¤', 'è¯·é€‰æ‹©ç§‘å®¤');
            }
        } catch (e) { console.error(e); }
    }

    // 2. çº§è”åŠ è½½åŒ»ç”Ÿ
    async function loadDoctors(deptId, targetSelectId) {
        const targetSelect = document.getElementById(targetSelectId);
        targetSelect.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

        if (!deptId) {
            targetSelect.innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©ç§‘å®¤</option>';
            return;
        }

        try {
            // æ¥å£: /staff?deptId=xx&role=åŒ»ç”Ÿ&pageSize=100
            const response = await fetch(`http://localhost:8081/staff?deptId=${deptId}&role=åŒ»ç”Ÿ&pageSize=100`, {
                headers: { 'Authorization': localStorage.getItem('token') }
            });
            const result = await response.json();

            if (result.code === 200) {
                if (result.data.records.length === 0) {
                    targetSelect.innerHTML = '<option value="">è¯¥ç§‘å®¤æš‚æ— åŒ»ç”Ÿ</option>';
                } else {
                    targetSelect.innerHTML = '<option value="">è¯·é€‰æ‹©åŒ»ç”Ÿ</option>' +
                        result.data.records.map(s => `<option value="${s.staffId}">${s.staffName} (${s.title||'åŒ»å¸ˆ'})</option>`).join('');
                }
            }
        } catch (e) { console.error(e); }
    }

    // 3. è·å–æ’ç­åˆ—è¡¨
    async function fetchSchedules() {
        const token = localStorage.getItem('token');
        if (!token) return window.location.href = 'login.html';

        const staffId = document.getElementById('searchDoctor').value;
        const deptId = document.getElementById('searchDept').value;
        const date = document.getElementById('searchDate').value;

        let url = `http://localhost:8081/admin/schedule/page?current=${currentPage}&pageSize=10`;
        if (staffId) url += `&staffId=${staffId}`;
        if (deptId) url += `&deptId=${deptId}`;
        if (date) url += `&startDate=${date}&endDate=${date}`; // ç²¾ç¡®æŸ¥æŸä¸€å¤©

        try {
            const response = await fetch(url, {
                headers: { 'Authorization': token }
            });
            const result = await response.json();

            if (result.code === 200) {
                scheduleList = result.data.records;
                renderTable();
            } else {
                showMessage('åŠ è½½å¤±è´¥: ' + result.message, 'error');
            }
        } catch (e) {
            showMessage('è¿æ¥æœåŠ¡å™¨å¤±è´¥', 'error');
        }
    }

    // 4. æ¸²æŸ“è¡¨æ ¼
    function renderTable() {
        const tbody = document.getElementById('scheduleTable');
        if (scheduleList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">æš‚æ— æ’ç­æ•°æ®</td></tr>';
            return;
        }

        tbody.innerHTML = scheduleList.map(item => {
            // è®¡ç®—çŠ¶æ€
            let statusBadge = '<span class="badge bg-success">å¯æŒ‚å·</span>';
            if (item.availableSlots <= 0) {
                statusBadge = '<span class="badge bg-secondary">å·²æ»¡</span>';
            }

            return `
                    <tr>
                        <td>${item.scheduleDate}</td>
                        <td>${item.timeSlot}</td>
                        <td>${item.deptName}</td>
                        <td><strong>${item.staffName}</strong></td>
                        <td>${item.title || '-'}</td>
                        <td>
                            <span class="text-primary fw-bold">${item.bookedSlots}</span> / ${item.totalSlots}
                        </td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger"
                                ${item.bookedSlots > 0 ? 'disabled' : ''}
                                onclick="deleteSchedule(${item.scheduleId})">
                                åˆ é™¤
                            </button>
                        </td>
                    </tr>
                `;
        }).join('');
    }

    // 5. æ‰“å¼€æ–°å¢å¼¹çª—
    function openAddModal() {
        document.getElementById('addForm').reset();
        // é‡ç½®åŒ»ç”Ÿä¸‹æ‹‰æ¡†
        document.getElementById('modalStaff').innerHTML = '<option value="">è¯·å…ˆé€‰æ‹©ç§‘å®¤</option>';
        // é»˜è®¤æ—¥æœŸæ˜å¤©
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.querySelector('input[name="scheduleDate"]').valueAsDate = tomorrow;

        new bootstrap.Modal(document.getElementById('addModal')).show();
    }

    // 6. æäº¤æ–°å¢
    async function submitAdd() {
        const form = document.getElementById('addForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // ç±»å‹è½¬æ¢
        data.staffId = parseInt(data.staffId);
        data.totalSlots = parseInt(data.totalSlots);

        try {
            const response = await fetch('http://localhost:8081/admin/schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': localStorage.getItem('token')
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.code === 200) {
                showMessage('æ’ç­åˆ›å»ºæˆåŠŸï¼', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
                fetchSchedules();
            } else {
                showMessage(result.message, 'error');
            }
        } catch (e) {
            showMessage('æ“ä½œå¤±è´¥', 'error');
        }
    }

    // 7. åˆ é™¤æ’ç­
    async function deleteSchedule(id) {
        if (!confirm('ç¡®å®šåˆ é™¤è¯¥æ’ç­å—ï¼Ÿ')) return;

        try {
            const response = await fetch(`http://localhost:8081/admin/schedule/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': localStorage.getItem('token') }
            });
            const result = await response.json();
            if (result.code === 200) {
                showMessage('åˆ é™¤æˆåŠŸ', 'success');
                fetchSchedules();
            } else {
                showMessage(result.message, 'error');
            }
        } catch (e) {
            showMessage('æ“ä½œå¤±è´¥', 'error');
        }
    }
</script>
</body>
</html>