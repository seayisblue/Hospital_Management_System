<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»ç”Ÿå·¥ä½œç«™ - åŒ»é™¢é—¨è¯Šç®¡ç†ç³»ç»Ÿ</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/common.css">
    <style>
        .patient-list-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .patient-list-item:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
        }
        .urgent-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
<div id="navbar-container"></div>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 id="welcome-msg">ğŸ‘¨â€âš•ï¸ åŒ»ç”Ÿï¼Œæ¬¢è¿å›æ¥ï¼</h4>
                            <p class="mb-0" id="doctor-details">åŠ è½½ä¸­...</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="h5" id="current-date">--æœˆ--æ—¥</div>
                            <div id="current-time">--:--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">ğŸ“‹ ä»Šæ—¥å°±è¯Šé˜Ÿåˆ—</h5>
                    <span class="badge bg-primary" id="waiting-count">åŠ è½½ä¸­...</span>
                </div>
                <div class="card-body">
                    <div class="list-group" id="patientQueue">
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- æˆ‘çš„æ’ç­å¡ç‰‡ -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">ğŸ“… æˆ‘çš„æ’ç­</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2 align-items-center">
                        <span>ä»Šå¤© (å‘¨ä¸€)</span>
                        <span class="badge bg-success">âœ… æ­£åœ¨å‡ºè¯Š</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>æ˜å¤© (å‘¨äºŒ)</span>
                        <span class="badge bg-secondary">ä¼‘æ¯</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>åå¤© (å‘¨ä¸‰)</span>
                        <span class="text-muted small">09:00 - 17:00</span>
                    </div>
                </div>
                <div class="card-footer bg-white border-top-0" id="dept-schedule-manager" style="display: none;">
                    <div class="d-grid">
                        <a href="schedule-management.html" class="btn btn-outline-primary">
                            <i class="bi bi-calendar-week"></i> ç®¡ç†ç§‘å®¤æ’ç­
                        </a>
                    </div>
                </div>
            </div>

            <!-- åŒ»é™¢é€šçŸ¥å¡ç‰‡ -->
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">ğŸ“¢ åŒ»é™¢é€šçŸ¥</h5>
                </div>
                <div class="list-group list-group-flush">
                    <a href="#" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1 text-truncate">ç³»ç»Ÿç»´æŠ¤é€šçŸ¥</h6>
                            <small class="text-muted">åˆšåˆš</small>
                        </div>
                        <p class="mb-1 small text-muted text-truncate">ä»Šæ™š 23:00 è¿›è¡Œç³»ç»Ÿå‡çº§ï¼Œè¯·åŠæ—¶ä¿å­˜...</p>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1 text-truncate">æµæ„Ÿè¯Šç–—è§„èŒƒæ›´æ–°</h6>
                            <small class="text-muted">æ˜¨å¤©</small>
                        </div>
                    </a>
                </div>
            </div>

            <!-- ä»Šæ—¥æ•°æ®å¡ç‰‡ - ä¿®æ”¹ä¸ºå¸¦headerçš„æ ·å¼ -->
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">ğŸ“Š ä»Šæ—¥æ•°æ®</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center mt-2">
                        <div class="col-6 border-end">
                            <h3 class="text-primary mb-0" id="today-count">0</h3>
                            <small class="text-muted">æ¥è¯Šäººæ•°</small>
                        </div>
                        <div class="col-6">
                            <h3 class="text-success mb-0" id="prescription-count">0</h3>
                            <small class="text-muted">å¤„æ–¹æ•°é‡</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../../utils/helpers.js"></script>

<script>
    let currentPatientList = [];

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', function() {
        loadNavbar();
        loadDoctorInfo();      // åŠ è½½åŒ»ç”Ÿä¿¡æ¯
        fetchPendingPatients();// åŠ è½½ç—…äººåˆ—è¡¨
        updateDateTime();      // åˆå§‹åŒ–æ—¶é—´
        setInterval(updateDateTime, 1000); // æ¯ç§’æ›´æ–°æ—¶é—´

        // æ¨¡æ‹ŸåŠ è½½å·¥ä½œç»Ÿè®¡ï¼ˆç­‰åç«¯æœ‰æ¥å£äº†å†æ›¿æ¢ï¼‰
        loadWorkStats();
    });

    // æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
    function loadDoctorInfo() {
        const infoStr = localStorage.getItem('doctorInfo');
        if (infoStr) {
            const info = JSON.parse(infoStr);

            // 1. æ›´æ–°æ¬¢è¿è¯­ (åŸæœ‰ä»£ç )
            const welcomeMsg = document.getElementById('welcome-msg');
            if(welcomeMsg) {
                welcomeMsg.innerHTML = `ğŸ‘¨â€âš•ï¸ ${info.staffName}ï¼Œæ¬¢è¿å›æ¥ï¼`;
            }

            // 2. æ›´æ–°ç§‘å®¤å’ŒèŒç§° (åŸæœ‰ä»£ç )
            const details = document.getElementById('doctor-details');
            if(details) {
                const dept = info.deptName || 'æš‚æ— ç§‘å®¤';
                const title = info.title || 'åŒ»å¸ˆ';
                details.innerHTML = `${dept} - ${title}`;
            }

            if (info.isDeptManager === true) {
                const managerBtn = document.getElementById('dept-schedule-manager');
                if (managerBtn) {
                    managerBtn.style.display = 'block';
                }
            }
        }
    }

    // è·å–å¾…å°±è¯Šåˆ—è¡¨
    async function fetchPendingPatients() {
        const token = localStorage.getItem('token');
        if (!token) return window.location.href = 'login.html';

        try {
            // æ¥å£ï¼šæŸ¥è¯¢è¯¥åŒ»ç”Ÿçš„å¾…å°±è¯ŠæŒ‚å·
            const response = await fetch('http://localhost:8081/doctor/appointments/pending', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                }
            });

            const result = await response.json();

            if (result.code === 200) {
                const patients = result.data;
                currentPatientList = patients;
                renderPatientQueue(patients);

                // æ›´æ–°ç­‰å¾…äººæ•°
                const badge = document.getElementById('waiting-count');
                if(badge) badge.textContent = `${patients.length}äººç­‰å¾…`;

                // ç®€å•æ¨¡æ‹Ÿï¼šå‡è®¾ä»Šæ—¥æ¥è¯Šäººæ•°å°±æ˜¯å¾…è¯Šäººæ•°ï¼ˆå®é™…åº”è¯¥ä»åç«¯æŸ¥ Completed çŠ¶æ€çš„å•å­ï¼‰
                // document.getElementById('today-count').textContent = patients.length;

            } else {
                if (result.code === 401) {
                    alert('ç™»å½•è¿‡æœŸ');
                    window.location.href = 'login.html';
                } else {
                    showMessage('åŠ è½½æ‚£è€…åˆ—è¡¨å¤±è´¥: ' + result.message, 'error');
                }
            }
        } catch (error) {
            console.error(error);
            showMessage('æœåŠ¡å™¨è¿æ¥å¤±è´¥', 'error');
        }
    }

    function renderPatientQueue(patients) {
        const container = document.getElementById('patientQueue');

        if (patients.length === 0) {
            container.innerHTML = '<div class="text-center p-5 text-muted">ğŸ‰ æš‚æ— å¾…å°±è¯Šæ‚£è€…ï¼Œä¼‘æ¯ä¸€ä¸‹å§</div>';
            return;
        }

        container.innerHTML = patients.map(p => `
            <div class="list-group-item patient-list-item border-start border-4 border-primary" data-appointment-id="${p.appointmentId}">
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div>
                        <div class="d-flex align-items-center mb-1">
                            <h6 class="mb-0 fw-bold me-2">${p.patientName}</h6>
                            <span class="badge bg-light text-dark border me-1">${p.patientGender}</span>
                            <span class="badge bg-light text-dark border">${p.patientAge}å²</span>
                        </div>
                        <p class="mb-0 text-muted small">
                            <i class="bi bi-clock"></i> é¢„çº¦: ${formatTime(p.appointmentTime)}
                        </p>
                    </div>
                    <div>
                        <button class="btn btn-primary btn-sm px-3" onclick="startConsultation(${p.appointmentId})">
                            æ¥è¯Š
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    // æ¨¡æ‹ŸåŠ è½½ç»Ÿè®¡æ•°æ®ï¼ˆå ä½å‡½æ•°ï¼‰
    function loadWorkStats() {
        // è¿™é‡Œä»¥åå¯ä»¥æ¥åç«¯æ¥å£ /doctor/stats
        // ç›®å‰å…ˆä¿æŒ 0 æˆ–è€…éšæœºæ•°æ¨¡æ‹Ÿä¸€ä¸‹æ•ˆæœ
        // document.getElementById('today-count').textContent = '5';
        // document.getElementById('prescription-count').textContent = '3';
    }

    // æ—¥æœŸæ ¼å¼åŒ–
    function formatTime(dateTimeStr) {
        if(!dateTimeStr) return '';
        return dateTimeStr.replace('T', ' ').substring(0, 16);
    }

    // å®æ—¶æ—¶é—´æ›´æ–°
    function updateDateTime() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });
        const timeStr = now.toLocaleTimeString('zh-CN', { weekday: 'long', hour12: false, hour: '2-digit', minute: '2-digit' });

        const dateEl = document.getElementById('current-date');
        const timeEl = document.getElementById('current-time');

        if(dateEl) dateEl.textContent = `ğŸ“… ${dateStr}`;
        if(timeEl) timeEl.textContent = timeStr;
    }

    // å¼€å§‹æ¥è¯Š
    function startConsultation(appointmentId) {
        const patient = currentPatientList.find(p => p.appointmentId === appointmentId);
        if (patient) {
            localStorage.setItem('currentPatientInfo', JSON.stringify({
                name: patient.patientName,
                gender: patient.patientGender,
                age: patient.patientAge,
                phone: patient.patientPhone,
                id: patient.patientId
            }));
        }
        localStorage.setItem('currentAppointmentId', appointmentId);
        window.location.href = `medical-record.html?appointmentId=${appointmentId}`;
    }
</script>
</body>
</html>