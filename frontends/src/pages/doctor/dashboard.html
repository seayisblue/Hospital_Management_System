<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»ç”Ÿå·¥ä½œç«™ - åŒ»é™¢é—¨è¯Šç®¡ç†ç³»ç»Ÿ</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/common.css">
    <style>
        .patient-list-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .patient-list-item:hover {
            background-color: #f8f9fa;
            transform: translateX(5px);
        }
        .urgent-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <!-- åŒ»ç”Ÿä¿¡æ¯æ¨ªå¹… -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4>ğŸ‘¨â€âš•ï¸ å¼ åŒ»ç”Ÿï¼Œæ¬¢è¿å›æ¥ï¼</h4>
                                <p class="mb-0">å†…ç§‘ - ä¸»ä»»åŒ»å¸ˆ | ä»Šæ—¥æ¥è¯Šæ•°: <strong>12</strong> äºº</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="h5">ğŸ“… 2024å¹´1æœˆ15æ—¥</div>
                                <div>æ˜ŸæœŸä¸€ 09:30 AM</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- å°±è¯Šé˜Ÿåˆ— -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">ğŸ“‹ ä»Šæ—¥å°±è¯Šé˜Ÿåˆ—</h5>
                        <span class="badge bg-primary">8äººç­‰å¾…</span>
                    </div>
                    <div class="card-body">
                        <div class="list-group" id="patientQueue">


                        </div>
                    </div>
                </div>

                <!-- ä»Šæ—¥å·²å®Œæˆå°±è¯Š -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">âœ… ä»Šæ—¥å·²å®Œæˆå°±è¯Š</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>æ‚£è€…</th>
                                        <th>è¯Šæ–­</th>
                                        <th>å°±è¯Šæ—¶é—´</th>
                                        <th>çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>èµµå…­</td>
                                        <td>ä¸Šå‘¼å¸é“æ„ŸæŸ“</td>
                                        <td>08:00-08:20</td>
                                        <td><span class="badge bg-success">å·²å®Œæˆ</span></td>
                                    </tr>
                                    <tr>
                                        <td>é’±ä¸ƒ</td>
                                        <td>é«˜è¡€å‹éšè®¿</td>
                                        <td>08:25-08:45</td>
                                        <td><span class="badge bg-success">å·²å®Œæˆ</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¿«æ·åŠŸèƒ½ -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <div class="h1 text-primary">ğŸ“</div>
                        <h5>ç”µå­ç—…å†æ¨¡æ¿</h5>
                        <p class="card-text">å¸¸ç”¨ç—…å†æ¨¡æ¿å’Œè¯Šæ–­æ–¹æ¡ˆ</p>
                        <button class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#templatesModal">æŸ¥çœ‹æ¨¡æ¿</button>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body text-center">
                        <div class="h1 text-success">ğŸ’Š</div>
                        <h5>è¯å“ç›®å½•</h5>
                        <p class="card-text">å¸¸ç”¨è¯å“ä¿¡æ¯å’Œç”¨æ³•</p>
                        <button class="btn btn-outline-primary w-100" data-bs-toggle="modal" data-bs-target="#medicinesModal">æŸ¥çœ‹è¯å“</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body text-center">
                        <div class="h1 text-info">ğŸ“Š</div>
                        <h5>å·¥ä½œç»Ÿè®¡</h5>
                        <div class="row text-center mt-3">
                            <div class="col-6">
                                <div class="h5 text-primary">12</div>
                                <small>ä»Šæ—¥æ¥è¯Š</small>
                            </div>
                            <div class="col-6">
                                <div class="h5 text-success">8</div>
                                <small>å¼€å…·å¤„æ–¹</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç—…å†æ¨¡æ¿æ¨¡æ€æ¡† -->
    <div class="modal fade" id="templatesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“ ç”µå­ç—…å†æ¨¡æ¿</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="list-group">
                        <a href="#" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">ä¸Šå‘¼å¸é“æ„ŸæŸ“æ¨¡æ¿</h6>
                                <small>å¸¸ç”¨</small>
                            </div>
                            <p class="mb-1">ä¸»è¯‰ï¼šå‘çƒ­ã€å’³å—½ã€å’½ç—›ã€‚æŸ¥ä½“ï¼šå’½éƒ¨å……è¡€ï¼Œæ‰æ¡ƒä½“ä¸å¤§...</p>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">é«˜è¡€å‹éšè®¿æ¨¡æ¿</h6>
                                <small>å¸¸ç”¨</small>
                            </div>
                            <p class="mb-1">ä¸»è¯‰ï¼šè¡€å‹æ§åˆ¶æƒ…å†µã€‚æŸ¥ä½“ï¼šBP 130/85mmHgï¼Œå¿ƒç‡78æ¬¡/åˆ†...</p>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">ç³–å°¿ç—…ç®¡ç†æ¨¡æ¿</h6>
                                <small>ä¸“ç§‘</small>
                            </div>
                            <p class="mb-1">ä¸»è¯‰ï¼šè¡€ç³–æ§åˆ¶æƒ…å†µã€‚æŸ¥ä½“ï¼šéšæœºè¡€ç³–8.5mmol/L...</p>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¯å“ç›®å½•æ¨¡æ€æ¡† -->
    <div class="modal fade" id="medicinesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ’Š å¸¸ç”¨è¯å“ç›®å½•</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>è¯å“åç§°</th>
                                    <th>è§„æ ¼</th>
                                    <th>ç”¨æ³•</th>
                                    <th>å•ä»·</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>é˜¿è«è¥¿æ—èƒ¶å›Š</td>
                                    <td>0.25g*24ç²’</td>
                                    <td>0.5g tid</td>
                                    <td>Â¥25.00</td>
                                </tr>
                                <tr>
                                    <td>æ„Ÿå†’çµé¢—ç²’</td>
                                    <td>10g*9è¢‹</td>
                                    <td>1è¢‹ tid</td>
                                    <td>Â¥18.50</td>
                                </tr>
                                <tr>
                                    <td>é™å‹ç‰‡</td>
                                    <td>30ç‰‡</td>
                                    <td>1ç‰‡ qd</td>
                                    <td>Â¥32.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../utils/helpers.js"></script>

    <script>
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            loadNavbar();
            loadDoctorInfo();      // åŠ è½½åŒ»ç”Ÿåå­—
            fetchPendingPatients();// â˜…â˜…â˜… å»åç«¯æ‹‰å–ç—…äººåˆ—è¡¨ â˜…â˜…â˜…
        });

        // æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
        function loadDoctorInfo() {
            const infoStr = localStorage.getItem('doctorInfo');
            if (infoStr) {
                const info = JSON.parse(infoStr);
                // æ‰¾åˆ°é¡µé¢ä¸Šæ˜¾ç¤ºåå­—çš„åœ°æ–¹ï¼ˆæ ¹æ®ä½ çš„HTMLç»“æ„å¯èƒ½éœ€è¦å¾®è°ƒé€‰æ‹©å™¨ï¼Œæˆ–è€…ç›´æ¥ç”¨ä¸‹é¢çš„ç®€å•ç²—æš´æ³•ï¼‰
                const welcomeTitle = document.querySelector('.card-body h4');
                if(welcomeTitle) welcomeTitle.innerHTML = `ğŸ‘¨â€âš•ï¸ ${info.staffName}ï¼Œæ¬¢è¿å›æ¥ï¼`;
            }
        }

        let currentPatientList = [];
        // â˜…â˜…â˜… æ ¸å¿ƒï¼šè·å–å¾…å°±è¯Šåˆ—è¡¨ â˜…â˜…â˜…
        async function fetchPendingPatients() {
            const token = localStorage.getItem('token');
            if (!token) return window.location.href = 'login.html';

            try {
                // 1. è°ƒç”¨åç«¯æ¥å£ï¼šæŸ¥è¯¢è¯¥åŒ»ç”Ÿçš„å¾…å°±è¯ŠæŒ‚å·
                const response = await fetch('http://localhost:8081/doctor/appointments/pending', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token // å¸¦ä¸Šé—¨ç¥¨
                    }
                });

                const result = await response.json();

                if (result.code === 200) {
                    const patients = result.data;
                    currentPatientList = patients;
                    renderPatientQueue(patients); // æ¸²æŸ“åˆ—è¡¨

                    // æ›´æ–°å³ä¸Šè§’çš„â€œXäººç­‰å¾…â€
                    const badge = document.querySelector('.card-header .badge');
                    if(badge) badge.textContent = `${patients.length}äººç­‰å¾…`;

                } else {
                    if (result.code === 401) {
                        alert('ç™»å½•è¿‡æœŸ');
                        window.location.href = 'login.html';
                    } else {
                        showMessage('åŠ è½½æ‚£è€…åˆ—è¡¨å¤±è´¥: ' + result.message, 'error');
                    }
                }
            } catch (error) {
                console.error(error);
                showMessage('æœåŠ¡å™¨è¿æ¥å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“åˆ—è¡¨ HTML
        function renderPatientQueue(patients) {
            const container = document.getElementById('patientQueue');

            if (patients.length === 0) {
                container.innerHTML = '<div class="text-center p-4 text-muted">æš‚æ— å¾…å°±è¯Šæ‚£è€…</div>';
                return;
            }

            container.innerHTML = patients.map(p => `
            <div class="list-group-item patient-list-item" data-appointment-id="${p.appointmentId}">
                <div class="d-flex w-100 justify-content-between">
                    <div>
                        <h6 class="mb-1">
                            ${p.patientName}
                            <span class="badge bg-light text-dark">${p.patientGender}</span>
                            <span class="badge bg-light text-dark">${p.patientAge}å²</span>
                        </h6>
                        <p class="mb-1">é¢„çº¦æ—¶é—´ï¼š${formatTime(p.appointmentTime)}</p>
                        <small class="text-muted">æ’ç­æ—¶æ®µ: ${p.scheduleDate} ${p.timeSlot}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-warning mb-2">å¾…å°±è¯Š</span>
                        <div>
                            <button class="btn btn-sm btn-primary" onclick="startConsultation(${p.appointmentId})">
                                å¼€å§‹æ¥è¯Š
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        }

        // ç®€å•çš„æ—¥æœŸæ ¼å¼åŒ–å·¥å…·
        function formatTime(dateTimeStr) {
            if(!dateTimeStr) return '';
            return dateTimeStr.replace('T', ' ').substring(0, 16);
        }

        // ç‚¹å‡»æ¥è¯Š
        function startConsultation(appointmentId) {
            // 1. ä»å…¨å±€åˆ—è¡¨ä¸­æ‰¾åˆ°å½“å‰ç‚¹å‡»çš„æ‚£è€…å¯¹è±¡
            const patient = currentPatientList.find(p => p.appointmentId === appointmentId);

            if (patient) {
                // 2. â˜…â˜…â˜… æŠŠæ‚£è€…ä¿¡æ¯å­˜å…¥ç¼“å­˜ â˜…â˜…â˜…
                localStorage.setItem('currentPatientInfo', JSON.stringify({
                    name: patient.patientName,
                    gender: patient.patientGender,
                    age: patient.patientAge,
                    phone: patient.patientPhone,
                    id: patient.patientId
                }));
            }

            // 3. å­˜æŒ‚å·IDå¹¶è·³è½¬
            localStorage.setItem('currentAppointmentId', appointmentId);
            showMessage(`å¼€å§‹æ¥è¯Š...`, 'success');
            setTimeout(() => {
                window.location.href = `medical-record.html?appointmentId=${appointmentId}`;
            }, 500);
        }
    </script>
</body>
</html>