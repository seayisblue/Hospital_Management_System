<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼€å…·å¤„æ–¹ - åŒ»é™¢é—¨è¯Šç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/common.css">
    <style>
        .medicine-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        .medicine-item:hover {
            background: #e9ecef;
            cursor: pointer;
        }
        .medicine-item.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .quantity-control {
            width: 80px;
        }
        .prescription-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .usage-template {
            font-size: 0.875rem;
            padding: 4px 8px;
            margin: 2px;
            cursor: pointer;
        }
        .total-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
        }
    </style>
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ’Š å¼€å…·å¤„æ–¹</h2>
            <div>
                <button class="btn btn-outline-secondary" onclick="saveDraft()">ä¿å­˜è‰ç¨¿</button>
                <button class="btn btn-success" onclick="submitPrescription()">å¼€å…·å¤„æ–¹</button>
            </div>
        </div>

        <!-- æ‚£è€…ä¿¡æ¯ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">ğŸ‘¤ æ‚£è€…ä¿¡æ¯</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>å§“å:</strong> å¼ ä¸‰
                    </div>
                    <div class="col-md-3">
                        <strong>æ€§åˆ«:</strong> ç”·
                    </div>
                    <div class="col-md-3">
                        <strong>å¹´é¾„:</strong> 35å²
                    </div>
                    <div class="col-md-3">
                        <strong>ç—…å†å·:</strong> P20240115001
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <strong>è¯Šæ–­:</strong> æ€¥æ€§ä¸Šå‘¼å¸é“æ„ŸæŸ“
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- è¯å“é€‰æ‹©åŒºåŸŸ -->
            <div class="col-md-5">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">è¯å“ç›®å½•</h5>
                        <div class="input-group" style="width: 200px;">
                            <input type="text" class="form-control form-control-sm" placeholder="æœç´¢è¯å“..." id="medicineSearch">
                            <button class="btn btn-outline-secondary btn-sm" type="button">ğŸ”</button>
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                        <div class="list-group" id="medicineList">
                            <!-- è¯å“åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <!-- å¸¸ç”¨ç”¨æ³•æ¨¡æ¿ -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0">ğŸ’¡ å¸¸ç”¨ç”¨æ³•æ¨¡æ¿</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap">
                            <span class="usage-template badge bg-light text-dark" onclick="applyUsageTemplate('ä¸€æ—¥ä¸‰æ¬¡')">ä¸€æ—¥ä¸‰æ¬¡</span>
                            <span class="usage-template badge bg-light text-dark" onclick="applyUsageTemplate('ä¸€æ—¥ä¸¤æ¬¡')">ä¸€æ—¥ä¸¤æ¬¡</span>
                            <span class="usage-template badge bg-light text-dark" onclick="applyUsageTemplate('ä¸€æ—¥ä¸€æ¬¡')">ä¸€æ—¥ä¸€æ¬¡</span>
                            <span class="usage-template badge bg-light text-dark" onclick="applyUsageTemplate('é¥­åæœç”¨')">é¥­åæœç”¨</span>
                            <span class="usage-template badge bg-light text-dark" onclick="applyUsageTemplate('é¥­å‰æœç”¨')">é¥­å‰æœç”¨</span>
                            <span class="usage-template badge bg-light text-dark" onclick="applyUsageTemplate('æ—©æ™šå„ä¸€æ¬¡')">æ—©æ™šå„ä¸€æ¬¡</span>
                            <span class="usage-template badge bg-light text-dark" onclick="applyUsageTemplate('å¿…è¦æ—¶æœç”¨')">å¿…è¦æ—¶æœç”¨</span>
                            <span class="usage-template badge bg-light text-dark" onclick="applyUsageTemplate('å¤–ç”¨')">å¤–ç”¨</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¤„æ–¹è¯¦æƒ…åŒºåŸŸ -->
            <div class="col-md-7">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">ğŸ“ å¤„æ–¹å†…å®¹</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered prescription-table">
                                <thead>
                                    <tr>
                                        <th width="25%">è¯å“åç§°</th>
                                        <th width="15%">è§„æ ¼</th>
                                        <th width="10%">æ•°é‡</th>
                                        <th width="25%">ç”¨æ³•ç”¨é‡</th>
                                        <th width="15%">å•ä»·</th>
                                        <th width="10%">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="prescriptionItems">
                                    <!-- åŠ¨æ€æ·»åŠ çš„è¯å“è¡Œ -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="4" class="text-end"><strong>æ€»è®¡é‡‘é¢:</strong></td>
                                        <td colspan="2" class="total-amount">Â¥0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <!-- åŒ»å˜±è¾“å…¥ -->
                        <div class="mt-4">
                            <label for="doctorAdvice" class="form-label fw-bold">åŒ»å˜±è¯´æ˜</label>
                            <textarea class="form-control" id="doctorAdvice" rows="3" placeholder="è¯·è¾“å…¥ç”¨è¯æ³¨æ„äº‹é¡¹ã€é¥®é£Ÿå»ºè®®ç­‰..."></textarea>
                        </div>

                        <!-- å¤„æ–¹å¤©æ•° -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="prescriptionDays" class="form-label">å¤„æ–¹å¤©æ•°</label>
                                <select class="form-select" id="prescriptionDays">
                                    <option value="3">3å¤©</option>
                                    <option value="5" selected>5å¤©</option>
                                    <option value="7">7å¤©</option>
                                    <option value="10">10å¤©</option>
                                    <option value="14">14å¤©</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">é¢„è®¡æ€»é‡‘é¢</label>
                                <div class="total-amount" id="estimatedTotal">Â¥0.00</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¤„æ–¹é¢„è§ˆ -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">ğŸ‘ï¸ å¤„æ–¹é¢„è§ˆ</h5>
                    </div>
                    <div class="card-body">
                        <div class="prescription-preview" id="prescriptionPreview">
                            <p class="text-muted">æ·»åŠ è¯å“åæ˜¾ç¤ºå¤„æ–¹é¢„è§ˆ...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”¨æ³•ç”¨é‡ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="usageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç¼–è¾‘ç”¨æ³•ç”¨é‡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="usageForm">
                        <input type="hidden" id="editingMedicineId">
                        <div class="mb-3">
                            <label class="form-label">ç”¨æ³•ç”¨é‡</label>
                            <textarea class="form-control" id="usageText" rows="3" placeholder="ä¾‹å¦‚ï¼šä¸€æ¬¡2ç²’ï¼Œä¸€æ—¥ä¸‰æ¬¡ï¼Œé¥­åæœç”¨"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ç”¨è¯å¤©æ•°</label>
                            <input type="number" class="form-control" id="usageDays" value="5" min="1" max="30">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveUsage()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../utils/helpers.js"></script>
    
    <script>
        // è¯å“æ•°æ®
        const medicines = [
            { id: 1, name: 'é˜¿è«è¥¿æ—èƒ¶å›Š', specification: '0.25g*24ç²’', price: 25.00, stock: 156, category: 'æŠ—ç”Ÿç´ ' },
            { id: 2, name: 'æ„Ÿå†’çµé¢—ç²’', specification: '10g*9è¢‹', price: 18.50, stock: 89, category: 'æ„Ÿå†’è¯' },
            { id: 3, name: 'é™å‹ç‰‡', specification: '30ç‰‡', price: 32.00, stock: 120, category: 'å¿ƒè¡€ç®¡' },
            { id: 4, name: 'ç»´ç”Ÿç´ Cç‰‡', specification: '100mg*60ç‰‡', price: 12.00, stock: 200, category: 'ç»´ç”Ÿç´ ' },
            { id: 5, name: 'æ­¢ç—›è´´è†', specification: '5è´´/ç›’', price: 25.00, stock: 75, category: 'å¤–ç”¨' },
            { id: 6, name: 'çœ¼è¯æ°´', specification: '10ml', price: 15.00, stock: 60, category: 'çœ¼ç§‘' },
            { id: 7, name: 'è‚ èƒƒè¯', specification: '20ç‰‡', price: 28.00, stock: 90, category: 'æ¶ˆåŒ–ç³»ç»Ÿ' },
            { id: 8, name: 'æ¶ˆç‚è¯', specification: '0.1g*24ç‰‡', price: 18.00, stock: 110, category: 'æŠ—ç”Ÿç´ ' }
        ];

        // å½“å‰å¤„æ–¹ä¸­çš„è¯å“
        let prescriptionItems = [];
        let selectedMedicineId = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadNavbar();
            initializePrescriptionPage();
        });

        function initializePrescriptionPage() {
            renderMedicineList();
            setupEventListeners();
        }

        function renderMedicineList() {
            const medicineList = document.getElementById('medicineList');
            medicineList.innerHTML = medicines.map(medicine => `
                <div class="medicine-item" data-medicine-id="${medicine.id}">
                    <div class="row align-items-center">
                        <div class="col-8">
                            <h6 class="mb-1">${medicine.name}</h6>
                            <small class="text-muted">${medicine.specification}</small>
                            <div>
                                <span class="badge bg-secondary">${medicine.category}</span>
                                <span class="badge bg-info">åº“å­˜: ${medicine.stock}</span>
                            </div>
                        </div>
                        <div class="col-4 text-end">
                            <div class="text-primary fw-bold">Â¥${medicine.price.toFixed(2)}</div>
                            <button class="btn btn-sm btn-primary mt-1" onclick="addToPrescription(${medicine.id})">
                                æ·»åŠ åˆ°å¤„æ–¹
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            // æ·»åŠ ç‚¹å‡»é€‰æ‹©æ•ˆæœ
            document.querySelectorAll('.medicine-item').forEach(item => {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.medicine-item').forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedMedicineId = this.dataset.medicineId;
                });
            });
        }

        function setupEventListeners() {
            // æœç´¢åŠŸèƒ½
            document.getElementById('medicineSearch').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.medicine-item').forEach(item => {
                    const medicineName = item.querySelector('h6').textContent.toLowerCase();
                    item.style.display = medicineName.includes(searchTerm) ? 'block' : 'none';
                });
            });

            // å¤„æ–¹å¤©æ•°å˜åŒ–
            document.getElementById('prescriptionDays').addEventListener('change', updatePrescriptionPreview);
        }

        function addToPrescription(medicineId) {
            const medicine = medicines.find(m => m.id === medicineId);
            if (!medicine) return;

            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            const existingItem = prescriptionItems.find(item => item.id === medicineId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                prescriptionItems.push({
                    id: medicine.id,
                    name: medicine.name,
                    specification: medicine.specification,
                    price: medicine.price,
                    quantity: 1,
                    usage: 'è¯·è®¾ç½®ç”¨æ³•ç”¨é‡',
                    days: 5
                });
            }

            renderPrescriptionItems();
            updateTotalAmount();
            updatePrescriptionPreview();
            showMessage(`å·²æ·»åŠ  ${medicine.name} åˆ°å¤„æ–¹`, 'success');
        }

        function removeFromPrescription(medicineId) {
            prescriptionItems = prescriptionItems.filter(item => item.id !== medicineId);
            renderPrescriptionItems();
            updateTotalAmount();
            updatePrescriptionPreview();
        }

        function updateQuantity(medicineId, change) {
            const item = prescriptionItems.find(item => item.id === medicineId);
            if (item) {
                item.quantity += change;
                if (item.quantity < 1) item.quantity = 1;
                renderPrescriptionItems();
                updateTotalAmount();
                updatePrescriptionPreview();
            }
        }

        function editUsage(medicineId) {
            const item = prescriptionItems.find(item => item.id === medicineId);
            if (item) {
                document.getElementById('editingMedicineId').value = medicineId;
                document.getElementById('usageText').value = item.usage;
                document.getElementById('usageDays').value = item.days;
                const modal = new bootstrap.Modal(document.getElementById('usageModal'));
                modal.show();
            }
        }

        function saveUsage() {
            const medicineId = document.getElementById('editingMedicineId').value;
            const usage = document.getElementById('usageText').value;
            const days = parseInt(document.getElementById('usageDays').value);

            const item = prescriptionItems.find(item => item.id === parseInt(medicineId));
            if (item) {
                item.usage = usage;
                item.days = days;
                renderPrescriptionItems();
                updatePrescriptionPreview();
            }

            const modal = bootstrap.Modal.getInstance(document.getElementById('usageModal'));
            modal.hide();
        }

        function applyUsageTemplate(template) {
            if (selectedMedicineId) {
                const item = prescriptionItems.find(item => item.id === parseInt(selectedMedicineId));
                if (item) {
                    item.usage = template;
                    renderPrescriptionItems();
                    updatePrescriptionPreview();
                    showMessage(`å·²åº”ç”¨ç”¨æ³•: ${template}`, 'info');
                }
            } else {
                showMessage('è¯·å…ˆé€‰æ‹©è¯å“', 'warning');
            }
        }

        function renderPrescriptionItems() {
            const tbody = document.getElementById('prescriptionItems');
            tbody.innerHTML = prescriptionItems.map(item => `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.specification}</td>
                    <td>
                        <div class="input-group input-group-sm">
                            <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(${item.id}, -1)">-</button>
                            <input type="number" class="form-control text-center quantity-control" value="${item.quantity}" min="1" 
                                   onchange="updateQuantityDirect(${item.id}, this.value)">
                            <button class="btn btn-outline-secondary" type="button" onclick="updateQuantity(${item.id}, 1)">+</button>
                        </div>
                    </td>
                    <td>
                        <div>${item.usage}</div>
                        <small class="text-muted">${item.days}å¤©ç”¨é‡</small>
                        <button class="btn btn-sm btn-outline-primary mt-1" onclick="editUsage(${item.id})">ç¼–è¾‘</button>
                    </td>
                    <td>Â¥${item.price.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromPrescription(${item.id})">åˆ é™¤</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateQuantityDirect(medicineId, value) {
            const quantity = parseInt(value);
            if (quantity > 0) {
                const item = prescriptionItems.find(item => item.id === medicineId);
                if (item) {
                    item.quantity = quantity;
                    updateTotalAmount();
                    updatePrescriptionPreview();
                }
            }
        }

        function updateTotalAmount() {
            const total = prescriptionItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.querySelector('.total-amount').textContent = `Â¥${total.toFixed(2)}`;
            document.getElementById('estimatedTotal').textContent = `Â¥${total.toFixed(2)}`;
        }

        function updatePrescriptionPreview() {
            const preview = document.getElementById('prescriptionPreview');
            const days = document.getElementById('prescriptionDays').value;
            const advice = document.getElementById('doctorAdvice').value;

            if (prescriptionItems.length === 0) {
                preview.innerHTML = '<p class="text-muted">æ·»åŠ è¯å“åæ˜¾ç¤ºå¤„æ–¹é¢„è§ˆ...</p>';
                return;
            }

            let previewHTML = `
                <div class="prescription-header mb-3">
                    <h6>å¤„æ–¹é¢„è§ˆ (${days}å¤©ç”¨é‡)</h6>
                </div>
                <div class="prescription-content">
            `;

            prescriptionItems.forEach(item => {
                previewHTML += `
                    <div class="mb-2">
                        <strong>${item.name}</strong> - ${item.specification}<br>
                        <small class="text-muted">${item.quantity}${getUnit(item.name)} Ã— ${item.days}å¤© | ${item.usage}</small>
                    </div>
                `;
            });

            if (advice) {
                previewHTML += `
                    <div class="mt-3 p-2 bg-light rounded">
                        <strong>åŒ»å˜±:</strong> ${advice}
                    </div>
                `;
            }

            previewHTML += `</div>`;
            preview.innerHTML = previewHTML;
        }

        function getUnit(medicineName) {
            if (medicineName.includes('èƒ¶å›Š') || medicineName.includes('ç‰‡')) return 'ç›’';
            if (medicineName.includes('é¢—ç²’')) return 'è¢‹';
            if (medicineName.includes('è´´è†')) return 'è´´';
            if (medicineName.includes('çœ¼è¯æ°´')) return 'ç“¶';
            return 'ä¸ª';
        }

        function saveDraft() {
            if (prescriptionItems.length === 0) {
                showMessage('å¤„æ–¹ä¸ºç©ºï¼Œæ— æ³•ä¿å­˜', 'warning');
                return;
            }
            showMessage('å¤„æ–¹è‰ç¨¿å·²ä¿å­˜', 'success');
            // è¿™é‡Œå¯ä»¥æ·»åŠ ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨æˆ–åç«¯çš„é€»è¾‘
        }

        function submitPrescription() {
            if (prescriptionItems.length === 0) {
                showMessage('è¯·æ·»åŠ è‡³å°‘ä¸€ç§è¯å“', 'error');
                return;
            }

            // æ£€æŸ¥æ‰€æœ‰è¯å“æ˜¯å¦è®¾ç½®äº†ç”¨æ³•ç”¨é‡
            const hasEmptyUsage = prescriptionItems.some(item => !item.usage || item.usage === 'è¯·è®¾ç½®ç”¨æ³•ç”¨é‡');
            if (hasEmptyUsage) {
                showMessage('è¯·ä¸ºæ‰€æœ‰è¯å“è®¾ç½®ç”¨æ³•ç”¨é‡', 'error');
                return;
            }

            const totalAmount = prescriptionItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            if (confirm(`ç¡®è®¤å¼€å…·å¤„æ–¹ï¼Ÿæ€»é‡‘é¢: Â¥${totalAmount.toFixed(2)}`)) {
                showMessage('å¤„æ–¹å¼€å…·æˆåŠŸï¼æ­£åœ¨ç”Ÿæˆè´¦å•...', 'success');
                // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
            }
        }
    </script>
</body>
</html>