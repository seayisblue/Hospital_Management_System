<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼€å…·å¤„æ–¹ - åŒ»é™¢é—¨è¯Šç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/common.css">
    <style>
        .medicine-item {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        .medicine-item:hover {
            background: #e9ecef;
            cursor: pointer;
        }
        .medicine-item.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }
        .quantity-control {
            width: 80px;
        }
        .prescription-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .usage-template {
            font-size: 0.875rem;
            padding: 4px 8px;
            margin: 2px;
            cursor: pointer;
        }
        .total-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #28a745;
        }
    </style>
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ’Š å¼€å…·å¤„æ–¹</h2>
            <div>
                <button class="btn btn-outline-secondary" onclick="saveDraft()">ä¿å­˜è‰ç¨¿</button>
                <button class="btn btn-success" onclick="submitPrescription()">å¼€å…·å¤„æ–¹</button>
            </div>
        </div>

        <!-- æ‚£è€…ä¿¡æ¯ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">ğŸ‘¤ æ‚£è€…ä¿¡æ¯</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3"><strong>å§“å:</strong> <span id="pName">-</span></div>
                    <div class="col-md-3"><strong>æ€§åˆ«:</strong> <span id="pGender">-</span></div>
                    <div class="col-md-3"><strong>å¹´é¾„:</strong> <span id="pAge">-</span></div>
                    <div class="col-md-3"><strong>ç”µè¯:</strong> <span id="pPhone">-</span></div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <strong>è¯Šæ–­:</strong> æ€¥æ€§ä¸Šå‘¼å¸é“æ„ŸæŸ“
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- è¯å“é€‰æ‹©åŒºåŸŸ -->
            <div class="col-md-5">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">è¯å“ç›®å½•</h5>
                        <div class="input-group" style="width: 200px;">
                            <input type="text" class="form-control form-control-sm" placeholder="æœç´¢è¯å“..." id="medicineSearch">
                            <button class="btn btn-outline-secondary btn-sm" type="button">ğŸ”</button>
                        </div>
                    </div>
                    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                        <div class="list-group" id="medicineList">
                            <!-- è¯å“åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <!-- å¸¸ç”¨ç”¨æ³•æ¨¡æ¿ -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="card-title mb-0">ğŸ’¡ å¸¸ç”¨ç”¨æ³•æ¨¡æ¿</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap">
                            <span class="usage-template badge bg-light text-dark" onclick="applyUsageTemplate('ä¸€æ—¥ä¸‰æ¬¡')">ä¸€æ—¥ä¸‰æ¬¡</span>
                            <span class="usage-template badge bg-light text-dark" onclick="applyUsageTemplate('ä¸€æ—¥ä¸¤æ¬¡')">ä¸€æ—¥ä¸¤æ¬¡</span>
                            <span class="usage-template badge bg-light text-dark" onclick="applyUsageTemplate('ä¸€æ—¥ä¸€æ¬¡')">ä¸€æ—¥ä¸€æ¬¡</span>
                            <span class="usage-template badge bg-light text-dark" onclick="applyUsageTemplate('é¥­åæœç”¨')">é¥­åæœç”¨</span>
                            <span class="usage-template badge bg-light text-dark" onclick="applyUsageTemplate('é¥­å‰æœç”¨')">é¥­å‰æœç”¨</span>
                            <span class="usage-template badge bg-light text-dark" onclick="applyUsageTemplate('æ—©æ™šå„ä¸€æ¬¡')">æ—©æ™šå„ä¸€æ¬¡</span>
                            <span class="usage-template badge bg-light text-dark" onclick="applyUsageTemplate('å¿…è¦æ—¶æœç”¨')">å¿…è¦æ—¶æœç”¨</span>
                            <span class="usage-template badge bg-light text-dark" onclick="applyUsageTemplate('å¤–ç”¨')">å¤–ç”¨</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¤„æ–¹è¯¦æƒ…åŒºåŸŸ -->
            <div class="col-md-7">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">ğŸ“ å¤„æ–¹å†…å®¹</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered prescription-table">
                                <thead>
                                    <tr>
                                        <th width="25%">è¯å“åç§°</th>
                                        <th width="15%">è§„æ ¼</th>
                                        <th width="10%">æ•°é‡</th>
                                        <th width="25%">ç”¨æ³•ç”¨é‡</th>
                                        <th width="15%">å•ä»·</th>
                                        <th width="10%">æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="prescriptionItems">
                                    <!-- åŠ¨æ€æ·»åŠ çš„è¯å“è¡Œ -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="4" class="text-end"><strong>æ€»è®¡é‡‘é¢:</strong></td>
                                        <td colspan="2" class="total-amount">Â¥0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <!-- åŒ»å˜±è¾“å…¥ -->
                        <div class="mt-4">
                            <label for="doctorAdvice" class="form-label fw-bold">åŒ»å˜±è¯´æ˜</label>
                            <textarea class="form-control" id="doctorAdvice" rows="3" placeholder="è¯·è¾“å…¥ç”¨è¯æ³¨æ„äº‹é¡¹ã€é¥®é£Ÿå»ºè®®ç­‰..."></textarea>
                        </div>

                        <!-- å¤„æ–¹å¤©æ•° -->
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="prescriptionDays" class="form-label">å¤„æ–¹å¤©æ•°</label>
                                <select class="form-select" id="prescriptionDays">
                                    <option value="3">3å¤©</option>
                                    <option value="5" selected>5å¤©</option>
                                    <option value="7">7å¤©</option>
                                    <option value="10">10å¤©</option>
                                    <option value="14">14å¤©</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">é¢„è®¡æ€»é‡‘é¢</label>
                                <div class="total-amount" id="estimatedTotal">Â¥0.00</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¤„æ–¹é¢„è§ˆ -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">ğŸ‘ï¸ å¤„æ–¹é¢„è§ˆ</h5>
                    </div>
                    <div class="card-body">
                        <div class="prescription-preview" id="prescriptionPreview">
                            <p class="text-muted">æ·»åŠ è¯å“åæ˜¾ç¤ºå¤„æ–¹é¢„è§ˆ...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç”¨æ³•ç”¨é‡ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div class="modal fade" id="usageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç¼–è¾‘ç”¨æ³•ç”¨é‡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="usageForm">
                        <input type="hidden" id="editingMedicineId">
                        <div class="mb-3">
                            <label class="form-label">ç”¨æ³•ç”¨é‡</label>
                            <textarea class="form-control" id="usageText" rows="3" placeholder="ä¾‹å¦‚ï¼šä¸€æ¬¡2ç²’ï¼Œä¸€æ—¥ä¸‰æ¬¡ï¼Œé¥­åæœç”¨"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ç”¨è¯å¤©æ•°</label>
                            <input type="number" class="form-control" id="usageDays" value="5" min="1" max="30">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="saveUsage()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../utils/helpers.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let allMedicines = []; // æ‰€æœ‰è¯å“åˆ—è¡¨
        let prescriptionItems = []; // è´­ç‰©è½¦é‡Œçš„è¯å“
        let selectedMedicineId = null;

        // è·å– URL ä¸­çš„ç—…å† ID
        const urlParams = new URLSearchParams(window.location.search);
        const recordId = urlParams.get('recordId') || localStorage.getItem('currentRecordId');

        document.addEventListener('DOMContentLoaded', function() {
            loadNavbar();

            const patientInfoStr = localStorage.getItem('currentPatientInfo');
            if (patientInfoStr) {
                const info = JSON.parse(patientInfoStr);
                document.getElementById('pName').textContent = info.name;
                document.getElementById('pGender').textContent = info.gender;
                document.getElementById('pAge').textContent = info.age + 'å²';
                document.getElementById('pPhone').textContent = info.phone;
            }

            if (!recordId) {
                alert('æœªæ‰¾åˆ°å…³è”ç—…å†ï¼Œè¯·å…ˆå¡«å†™ç—…å†');
                window.location.href = 'dashboard.html';
                return;
            }

            fetchMedicines(); // è·å–è¯å“åˆ—è¡¨
            setupEventListeners();
        });

        // 1. è·å–è¯å“åˆ—è¡¨
        async function fetchMedicines() {
            const token = localStorage.getItem('token');
            try {
                const response = await fetch('http://localhost:8081/medicine?page=1&pageSize=100', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    }
                });
                const result = await response.json();
                if (result.code === 200) {
                    allMedicines = result.data.records;
                    renderMedicineList(allMedicines);
                } else {
                    showMessage('è¯å“åŠ è½½å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                console.error(error);
                showMessage('è¿æ¥æœåŠ¡å™¨å¤±è´¥', 'error');
            }
        }

        // 2. æ¸²æŸ“è¯å“åˆ—è¡¨
        function renderMedicineList(medicines) {
            const container = document.getElementById('medicineList');
            if (medicines.length === 0) {
                container.innerHTML = '<div class="p-3 text-center text-muted">æš‚æ— è¯å“</div>';
                return;
            }

            container.innerHTML = medicines.map(m => `
            <div class="medicine-item" onclick="selectMedicineItem(this, ${m.medicineId})">
                <div class="row align-items-center">
                    <div class="col-8">
                        <h6 class="mb-1">${m.medicineName}</h6>
                        <small class="text-muted">${m.specification || 'å¸¸è§„'}</small>
                        <div>
                            <span class="badge ${m.stockLevel < 20 ? 'bg-warning' : 'bg-info'}">
                                åº“å­˜: ${m.stockLevel}
                            </span>
                        </div>
                    </div>
                    <div class="col-4 text-end">
                        <div class="text-primary fw-bold">Â¥${m.unitPrice}</div>
                        <button class="btn btn-sm btn-primary mt-1"
                                onclick="event.stopPropagation(); addToPrescription(${m.medicineId})">
                            æ·»åŠ 
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        }

        // é€‰ä¸­è¯å“æ•ˆæœ
        function selectMedicineItem(element, id) {
            document.querySelectorAll('.medicine-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            selectedMedicineId = id;
        }

        // 3. æ·»åŠ åˆ°å¤„æ–¹ (è´­ç‰©è½¦)
        function addToPrescription(id) {
            const medicine = allMedicines.find(m => m.medicineId === id);
            if (!medicine) return;

            // æ£€æŸ¥åº“å­˜
            if (medicine.stockLevel <= 0) {
                showMessage('è¯¥è¯å“åº“å­˜ä¸è¶³ï¼', 'warning');
                return;
            }

            // æ£€æŸ¥æ˜¯å¦å·²æ·»åŠ 
            const existing = prescriptionItems.find(item => item.medicineId === id);
            if (existing) {
                existing.quantity += 1;
            } else {
                prescriptionItems.push({
                    medicineId: medicine.medicineId,
                    medicineName: medicine.medicineName,
                    specification: medicine.specification,
                    unitPrice: medicine.unitPrice,
                    quantity: 1,
                    usage: '', // åˆå§‹ä¸ºç©º
                    days: 0    // åˆå§‹ä¸º0
                });
            }
            selectedMedicineId = id;
            renderPrescriptionItems();
            updateTotalAmount();
            updatePrescriptionPreview();
            document.querySelectorAll('.medicine-item').forEach(el => el.classList.remove('selected'));
            const leftItem = document.querySelector(`.medicine-item[onclick*="${id}"]`);
            if (leftItem) leftItem.classList.add('selected');
        }

        // 4. æ¸²æŸ“å¤„æ–¹è¡¨æ ¼
        function renderPrescriptionItems() {
            const tbody = document.getElementById('prescriptionItems');
            tbody.innerHTML = prescriptionItems.map(item => `
            <tr onclick="selectPrescriptionItem(${item.medicineId})"
                class="${selectedMedicineId === item.medicineId ? 'table-active' : ''}"
                style="cursor: pointer;">

                <td>${item.medicineName}</td>
                <td>${item.specification || '-'}</td>
                <td>
                    <div class="input-group input-group-sm" style="width: 100px;">
                        <button class="btn btn-outline-secondary" type="button"
                                onclick="event.stopPropagation(); updateQuantity(${item.medicineId}, -1)">-</button>
                        <input type="text" class="form-control text-center" value="${item.quantity}" readonly>
                        <button class="btn btn-outline-secondary" type="button"
                                onclick="event.stopPropagation(); updateQuantity(${item.medicineId}, 1)">+</button>
                    </div>
                </td>
                <td>
                    <input type="text" class="form-control form-control-sm mb-1"
                           placeholder="ç”¨æ³• (å¦‚: ä¸€æ—¥ä¸‰æ¬¡)"
                           value="${item.usage}"
                           onclick="event.stopPropagation(); selectPrescriptionItem(${item.medicineId})"
                           onchange="updateItemField(${item.medicineId}, 'usage', this.value)">
                    <input type="number" class="form-control form-control-sm"
                           placeholder="å¤©æ•°"
                           value="${item.days || ''}"
                           onclick="event.stopPropagation(); selectPrescriptionItem(${item.medicineId})"
                           onchange="updateItemField(${item.medicineId}, 'days', this.value)">
                </td>
                <td>Â¥${item.unitPrice}</td>
                <td>
                    <button class="btn btn-sm btn-outline-danger"
                            onclick="event.stopPropagation(); removeItem(${item.medicineId})">åˆ é™¤</button>
                </td>
            </tr>
        `).join('');
        }

        // å³ä¾§åˆ—è¡¨ç‚¹å‡»é€‰ä¸­
        function selectPrescriptionItem(id) {
            selectedMedicineId = id;

            // é‡æ–°æ¸²æŸ“å·¦å³ä¸¤ä¾§åˆ—è¡¨ï¼Œä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€çš„é«˜äº®
            renderPrescriptionItems();

            // å¦‚æœå·¦ä¾§åˆ—è¡¨ä¹Ÿåœ¨è§†é‡å†…ï¼Œæœ€å¥½ä¹Ÿé«˜äº®å·¦ä¾§ï¼ˆå¯é€‰ï¼‰
            document.querySelectorAll('.medicine-item').forEach(el => el.classList.remove('selected'));
            const leftItem = document.querySelector(`.medicine-item[onclick*="${id}"]`);
            if (leftItem) leftItem.classList.add('selected');
        }
        // æ›´æ–°æ•°é‡
        function updateQuantity(id, delta) {
            const item = prescriptionItems.find(i => i.medicineId === id);
            if (item) {
                const newQty = item.quantity + delta;
                if (newQty > 0) {
                    item.quantity = newQty;
                    renderPrescriptionItems(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ˜¾ç¤º
                    updateTotalAmount();
                    updatePrescriptionPreview();
                }
            }
        }

        // æ›´æ–°ç”¨æ³•/å¤©æ•°
        function updateItemField(id, field, value) {
            const item = prescriptionItems.find(i => i.medicineId === id);
            if (item) {
                item[field] = value;
                updatePrescriptionPreview();
            }
        }

        // åˆ é™¤é¡¹ç›®
        function removeItem(id) {
            prescriptionItems = prescriptionItems.filter(i => i.medicineId !== id);
            renderPrescriptionItems();
            updateTotalAmount();
            updatePrescriptionPreview();
        }

        // è®¡ç®—æ€»é‡‘é¢
        function updateTotalAmount() {
            const total = prescriptionItems.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
            document.querySelectorAll('.total-amount').forEach(el => el.innerText = 'Â¥' + total.toFixed(2));
        }

        // é¢„è§ˆæ›´æ–°
        function updatePrescriptionPreview() {
            const container = document.getElementById('prescriptionPreview');
            if (prescriptionItems.length === 0) {
                container.innerHTML = '<p class="text-muted">æš‚æ— è¯å“</p>';
                return;
            }
            const advice = document.getElementById('doctorAdvice').value;

            let html = prescriptionItems.map(item => `
            <div class="mb-2">
                <strong>${item.medicineName}</strong> x ${item.quantity} <br>
                <small class="text-muted">ç”¨æ³•ï¼š${item.usage || 'æœªå¡«å†™'} | å¤©æ•°ï¼š${item.days || 0}å¤©</small>
            </div>
        `).join('');

            if (advice) {
                html += `<div class="mt-3 pt-2 border-top"><small class="text-muted">åŒ»å˜±ï¼š${advice}</small></div>`;
            }
            container.innerHTML = html;
        }

        // æœç´¢å’Œæ¨¡æ¿åŠŸèƒ½
        function setupEventListeners() {
            document.getElementById('medicineSearch').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                const filtered = allMedicines.filter(m => m.medicineName.toLowerCase().includes(term));
                renderMedicineList(filtered);
            });

            document.getElementById('doctorAdvice').addEventListener('input', updatePrescriptionPreview);
        }

        // å¿«æ·æ¨¡æ¿åº”ç”¨
        function applyUsageTemplate(text) {
            if (!selectedMedicineId) {
                showMessage('è¯·å…ˆç‚¹å‡»å·¦ä¾§åˆ—è¡¨é€‰ä¸­ä¸€ç§è¯å“', 'warning');
                return;
            }
            // å¦‚æœè¯¥è¯å“å·²åœ¨å¤„æ–¹ä¸­ï¼Œæ›´æ–°å®ƒçš„ç”¨æ³•
            const item = prescriptionItems.find(i => i.medicineId === selectedMedicineId);
            if (item) {
                item.usage = text;
                renderPrescriptionItems();
                updatePrescriptionPreview();
            } else {
                // å¦‚æœæ²¡åœ¨å¤„æ–¹é‡Œï¼Œå…ˆæ·»åŠ 
                addToPrescription(selectedMedicineId);
                // æ·»åŠ åå†æ‰¾ä¸€æ¬¡æ›´æ–°ç”¨æ³•
                const newItem = prescriptionItems.find(i => i.medicineId === selectedMedicineId);
                if(newItem) newItem.usage = text;
                renderPrescriptionItems();
                updatePrescriptionPreview();
            }
        }

        // 5. â˜…â˜…â˜… æäº¤å¤„æ–¹ â˜…â˜…â˜…
        async function submitPrescription() {
            if (prescriptionItems.length === 0) {
                showMessage('è¯·è‡³å°‘æ·»åŠ ä¸€ç§è¯å“', 'warning');
                return;
            }

            // æ ¡éªŒ
            for (let item of prescriptionItems) {
                if (!item.usage || !item.days) {
                    showMessage(`ã€${item.medicineName}ã€‘çš„ç”¨æ³•æˆ–å¤©æ•°æœªå¡«å†™å®Œæ•´`, 'warning');
                    return;
                }
            }

            const requestData = {
                recordId: parseInt(recordId),
                items: prescriptionItems.map(item => ({
                    medicineId: item.medicineId,
                    quantity: item.quantity,
                    usage: item.usage,
                    frequency: "æ¯æ—¥", // ç®€åŒ–å¤„ç†
                    days: parseInt(item.days)
                }))
            };

            try {
                const response = await fetch('http://localhost:8081/doctor/prescription', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': localStorage.getItem('token')
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();

                if (result.code === 200) {
                    showMessage('å¤„æ–¹å¼€å…·æˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1500);
                } else {
                    showMessage('æäº¤å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                console.error(error);
                showMessage('è¿æ¥æœåŠ¡å™¨å¤±è´¥', 'error');
            }
        }

        // ä¿ç•™ saveDraft å ä½
        function saveDraft() { showMessage('åŠŸèƒ½å¼€å‘ä¸­...', 'info'); }
    </script>
</body>
</html>