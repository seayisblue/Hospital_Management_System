<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>排班管理 - 医院门诊管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/common.css">
    <style>
        :root {
            --theme-start: #4CA1AF;
            --theme-end: #C4E0E5;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-700: #334155;
        }

        body {
            background-color: #f8fafc;
            color: #1e293b;
            font-family: -apple-system, system-ui, sans-serif;
        }

        .header-section {
            background: linear-gradient(135deg, var(--theme-start), var(--theme-end));
            padding: 25px 0 65px 0;
            color: white;
        }

        .back-link { color: rgba(255, 255, 255, 0.8); text-decoration: none; }

        /* 列表容器 */
        .schedule-flow-container { margin-top: -45px; }

        .glass-search-bar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid var(--slate-200);
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 24px;
        }

        /* 极简流式记录项 */
        .schedule-entry {
            background: #fff;
            border: 1px solid var(--slate-200);
            border-radius: 8px;
            margin-bottom: 10px;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            transition: 0.2s;
        }
        .schedule-entry:hover { border-color: var(--theme-start); transform: translateX(5px); }

        .entry-date {
            width: 100px;
            border-right: 1px solid var(--slate-200);
            margin-right: 20px;
        }
        .entry-date .day { font-size: 1.3rem; font-weight: 800; color: var(--theme-start); line-height: 1; }
        .entry-date .month { font-size: 0.75rem; color: #94a3b8; margin-top: 4px; }

        .doc-info { flex: 1; }
        .doc-name { font-weight: 700; font-size: 1rem; }
        .doc-meta { font-size: 0.8rem; color: #64748b; }

        /* 状态与操作 */
        .status-indicator { font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #10b981; }

        /* 弹窗多选样式 */
        .multi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
            gap: 10px;
            padding: 12px;
            background: var(--slate-100);
            border-radius: 8px;
            max-height: 180px;
            overflow-y: auto;
        }
        .custom-check { display: none; }
        .custom-label {
            display: block;
            padding: 8px;
            text-align: center;
            background: #fff;
            border: 1px solid var(--slate-200);
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: 0.2s;
        }
        .custom-check:checked + .custom-label {
            background: var(--theme-start);
            color: white;
            border-color: var(--theme-start);
        }

        .week-bar { display: flex; gap: 6px; margin-top: 10px; }
        .week-label { flex: 1; padding: 10px 0; font-size: 0.8rem; }

        .btn-main {
            background: var(--slate-700); color: white; border: none;
            padding: 10px 30px; border-radius: 6px; font-weight: 600;
        }
    </style>
</head>
<body>

<div class="header-section">
    <div class="container">
        <a href="dashboard.html" class="back-link"><span class="material-icons-outlined">arrow_back</span></a>
        <div class="d-flex justify-content-between align-items-center mt-2">
            <h2 class="fw-bold mb-0">科室排班排期</h2>
            <button class="btn btn-light d-flex align-items-center gap-1" id="btnAddSchedule" style="display:none" onclick="openAddModal()">
                <span class="material-icons-outlined" style="font-size: 20px;">layers</span> 批量快速排班
            </button>
        </div>
    </div>
</div>

<div class="container schedule-flow-container">
    <div class="glass-search-bar">
        <div class="row align-items-center">
            <div class="col-md-4">
                <select class="form-select border-0 shadow-none" id="searchDoctor"><option value="">所有医生</option></select>
            </div>
            <div class="col-md-4 border-start">
                <input type="date" class="form-control border-0 shadow-none" id="searchDate">
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-main" onclick="fetchSchedules()">立即检索</button>
            </div>
        </div>
    </div>

    <div id="scheduleTable"></div>
    <nav class="mt-4"><ul class="pagination justify-content-center" id="pagination"></ul></nav>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0">
            <div class="modal-header border-0 px-4 pt-4">
                <h5 class="fw-bold">智能批量排班计划</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body px-4">
                <form id="addForm">
                    <div class="mb-4">
                        <label class="small fw-bold text-muted mb-2 d-block">1. 选择出诊人员 (可多选)</label>
                        <div class="multi-grid" id="modalStaffList"></div>
                    </div>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="small fw-bold text-muted mb-2 d-block">2. 排班起始日期</label>
                            <input type="date" class="form-control" name="startDate" id="startDate" required>
                        </div>
                        <div class="col-md-6">
                            <label class="small fw-bold text-muted mb-2 d-block">3. 出诊时段</label>
                            <select class="form-select" name="timeSlot" required>
                                <option value="上午">上午门诊</option>
                                <option value="下午">下午门诊</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="small fw-bold text-muted mb-2 d-block">4. 选择重复周期 (多选星期的日期)</label>
                            <div class="week-bar">
                                <input type="checkbox" class="custom-check" id="w1" name="weeks" value="1"><label class="custom-label week-label" for="w1">一</label>
                                <input type="checkbox" class="custom-check" id="w2" name="weeks" value="2"><label class="custom-label week-label" for="w2">二</label>
                                <input type="checkbox" class="custom-check" id="w3" name="weeks" value="3"><label class="custom-label week-label" for="w3">三</label>
                                <input type="checkbox" class="custom-check" id="w4" name="weeks" value="4"><label class="custom-label week-label" for="w4">四</label>
                                <input type="checkbox" class="custom-check" id="w5" name="weeks" value="5"><label class="custom-label week-label" for="w5">五</label>
                                <input type="checkbox" class="custom-check" id="w6" name="weeks" value="6"><label class="custom-label week-label" for="w6">六</label>
                                <input type="checkbox" class="custom-check" id="w0" name="weeks" value="0"><label class="custom-label week-label" for="w0">日</label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 px-4 pb-4">
                <button class="btn btn-light px-4" data-bs-dismiss="modal">取消</button>
                <button class="btn btn-main px-4" onclick="handleBatchSubmit()">一键生成排班</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../../utils/helpers.js"></script>

<script>
    let currentDeptId = null;

    document.addEventListener('DOMContentLoaded', () => initEnv());

    function getTodayStr() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    async function initEnv() {
        const user = JSON.parse(localStorage.getItem('doctorInfo') || '{}');
        currentDeptId = user.deptId;
        if (user.isDeptManager) document.getElementById('btnAddSchedule').style.display = 'flex';
        const todayStr = getTodayStr();
        const searchDate = document.getElementById('searchDate');
        const startDate = document.getElementById('startDate');
        if (searchDate) searchDate.setAttribute('min', todayStr);
        if (startDate) startDate.setAttribute('min', todayStr);
        await loadDoctorsData(currentDeptId);
        fetchSchedules();
    }

    async function loadDoctorsData(deptId) {
        const res = await (await fetch(`http://localhost:8081/staff?deptId=${deptId}&pageSize=100`, {
            headers: { 'Authorization': localStorage.getItem('token') }
        })).json();

        if (res.code === 200) {
            const docs = res.data.records;
            document.getElementById('searchDoctor').innerHTML += docs.map(d => `<option value="${d.staffId}">${d.staffName}</option>`).join('');
            document.getElementById('modalStaffList').innerHTML = docs.map(d => `
                <div>
                    <input type="checkbox" class="custom-check" id="doc_${d.staffId}" name="doctorIds" value="${d.staffId}">
                    <label class="custom-label" for="doc_${d.staffId}">${d.staffName}</label>
                </div>
            `).join('');
        }
    }

    async function fetchSchedules() {
        const sid = document.getElementById('searchDoctor').value;
        const date = document.getElementById('searchDate').value;
        let url = `http://localhost:8081/schedule/page?current=1&pageSize=30&deptId=${currentDeptId}`;
        if (sid) url += `&staffId=${sid}`;
        if (date) url += `&startDate=${date}&endDate=${date}`;

        const res = await (await fetch(url, { headers: { 'Authorization': localStorage.getItem('token') } })).json();
        if (res.code === 200) renderList(res.data.records);
    }

    function renderList(list) {
        const container = document.getElementById('scheduleTable');
        if (!list.length) { container.innerHTML = '<div class="text-center p-5 text-muted">无排班记录</div>'; return; }

        container.innerHTML = list.map(item => {
            const dateParts = item.scheduleDate.split('-');
            return `
                <div class="schedule-entry">
                    <div class="entry-date">
                        <div class="day">${dateParts[2]}</div>
                        <div class="month">${dateParts[0]}.${dateParts[1]}</div>
                    </div>
                    <div class="doc-info">
                        <div class="doc-name">${item.staffName}</div>
                        <div class="doc-meta">${item.title || '医师'} · ${item.timeSlot}</div>
                    </div>
                    <div class="status-indicator">
                        <div class="dot"></div>
                        余 ${item.availableSlots} / ${item.totalSlots}
                    </div>
                    <button class="btn btn-link text-danger ms-4" onclick="deleteItem(${item.scheduleId})">
                        <span class="material-icons-outlined">delete</span>
                    </button>
                </div>
            `;
        }).join('');
    }

    // 批量逻辑核心
    async function handleBatchSubmit() {
        const selectedDocs = Array.from(document.querySelectorAll('input[name="doctorIds"]:checked')).map(el => el.value);
        const selectedWeeks = Array.from(document.querySelectorAll('input[name="weeks"]:checked')).map(el => parseInt(el.value));
        const startDateStr = document.getElementById('startDate').value;
        const timeSlot = document.querySelector('select[name="timeSlot"]').value;

        if (!selectedDocs.length) return showMessage('请选择医生', 'warning');
        if (!selectedWeeks.length && !startDateStr) return showMessage('请设置日期或周期', 'warning');
        if (startDateStr && startDateStr < getTodayStr()) {
            return showMessage('不能选择今天之前的日期', 'warning');
        }

        // 生成目标日期数组
        let targetDates = [];
        if (selectedWeeks.length) {
            // 如果选了周期，生成未来两周内匹配星期的日期
            let start = startDateStr ? new Date(startDateStr) : new Date();
            for(let i=0; i<14; i++) {
                let temp = new Date(start);
                temp.setDate(start.getDate() + i);
                if(selectedWeeks.includes(temp.getDay())) {
                    targetDates.push(temp.toISOString().split('T')[0]);
                }
            }
        } else {
            targetDates.push(startDateStr);
        }

        let count = 0;
        for (const docId of selectedDocs) {
            for (const d of targetDates) {
                const r = await fetch('http://localhost:8081/schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': localStorage.getItem('token') },
                    body: JSON.stringify({
                        staffId: parseInt(docId),
                        scheduleDate: d,
                        timeSlot: timeSlot,
                        totalSlots: 30,
                        deptId: currentDeptId
                    })
                });
                if ((await r.json()).code === 200) count++;
            }
        }

        showMessage(`批量操作成功，生成 ${count} 条排班记录`, 'success');
        bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
        fetchSchedules();
    }

    function openAddModal() {
        document.getElementById('addForm').reset();
        new bootstrap.Modal(document.getElementById('addModal')).show();
    }

    async function deleteItem(id) {
        if (!confirm('撤销此排班？')) return;
        const res = await (await fetch(`http://localhost:8081/schedule/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': localStorage.getItem('token') }
        })).json();
        if (res.code === 200) fetchSchedules();
    }
</script>
</body>
</html>
