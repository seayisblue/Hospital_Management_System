<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ’ç­ç®¡ç† - åŒ»é™¢é—¨è¯Šç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/common.css">
</head>
<body>
<div id="navbar-container"></div>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="dashboard.html" class="btn btn-outline-secondary me-2">ğŸ  é¦–é¡µ</a>
        <h2>ğŸ“… åŒ»ç”Ÿæ’ç­ç®¡ç†</h2>

        <button class="btn btn-primary" id="btnAddSchedule" style="display:none" onclick="openAddModal()">
            â• æ–°å¢æ’ç­
        </button>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="row">

                <div class="col-md-3">
                    <select class="form-select" id="searchDoctor">
                        <option value="">æ‰€æœ‰åŒ»ç”Ÿ</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="searchDept">
                        <option value="">æ‰€æœ‰ç§‘å®¤</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <input type="date" class="form-control" id="searchDate">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" onclick="fetchSchedules()">æŸ¥è¯¢</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>æ—¶æ®µ</th>
                        <th>ç§‘å®¤</th>
                        <th>åŒ»ç”Ÿ</th>
                        <th>èŒç§°</th>
                        <th>å·²æŒ‚/æ€»å·</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                    </thead>
                    <tbody id="scheduleTable">
                    </tbody>
                </table>
            </div>
            <nav class="mt-3">
                <ul class="pagination justify-content-center" id="pagination"></ul>
            </nav>
        </div>
    </div>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">

                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addForm">
                    <div class="mb-3">
                        <label class="form-label">æ‰€å±ç§‘å®¤</label>
                        <select class="form-select" id="modalDept" disabled>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">é€‰æ‹©åŒ»ç”Ÿ</label>
                        <select class="form-select" id="modalStaff" name="staffId" required>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ’ç­æ—¥æœŸ</label>
                        <input type="date" class="form-control" name="scheduleDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ—¶æ®µ</label>
                        <select class="form-select" name="timeSlot" required>
                            <option value="ä¸Šåˆ">ä¸Šåˆ</option>
                            <option value="ä¸‹åˆ">ä¸‹åˆ</option>
                            <option value="æ™šä¸Š">æ™šä¸Š</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æ€»å·æºæ•°</label>
                        <input type="number" class="form-control" name="totalSlots" value="30" min="1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitAdd()">æäº¤</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../../utils/helpers.js"></script>

<script>
    let scheduleList = [];
    let currentPage = 1;
    let currentDeptId = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadNavbar();
        initDoctorEnvironment();
    });

    // 1. åˆå§‹åŒ–ç¯å¢ƒ (æ ¸å¿ƒä¿®æ”¹)
    async function initDoctorEnvironment() {
        const user = JSON.parse(localStorage.getItem('doctorInfo') || '{}');
        if (!user.deptId) {
            alert("æ— æ³•è·å–æ‚¨çš„ç§‘å®¤ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•");
            return;
        }
        currentDeptId = user.deptId;

        // 1.1 è®¾ç½®ç§‘å®¤æ˜¾ç¤º (é”å®š)
        const deptSelects = ['searchDept', 'modalDept'];
        deptSelects.forEach(id => {
            const sel = document.getElementById(id);
            if(sel) {
                sel.innerHTML = `<option value="${user.deptId}" selected>${user.deptName || 'æœ¬ç§‘å®¤'}</option>`;
                sel.disabled = true;
            }
        });

        // 1.2 æ˜¾ç¤ºæ–°å¢æŒ‰é’® (å¦‚æœæ˜¯ç§‘ä¸»ä»»)
        if (user.isDeptManager === true) {
            document.getElementById('btnAddSchedule').style.display = 'block';
        }

        // 1.3 åŠ è½½åŒ»ç”Ÿåˆ—è¡¨ (æ³¨æ„ï¼šè¿™é‡ŒåŠ äº† await)
        // å…ˆåŠ è½½æ¨¡æ€æ¡†çš„åŒ»ç”Ÿï¼ˆæ–¹ä¾¿æ–°å¢ç”¨ï¼‰
        await loadDoctors(currentDeptId, 'modalStaff');
        // å†åŠ è½½æœç´¢æ¡†çš„åŒ»ç”Ÿ
        await loadDoctors(currentDeptId, 'searchDoctor');

        // 1.4 è®¾ç½®æœç´¢æ¡†çš„é»˜è®¤é€‰ä¸­çŠ¶æ€ (è§£å†³ä½ çš„ç¬¬ä¸€ä¸ªé—®é¢˜)
        const searchSelect = document.getElementById('searchDoctor');

        if (user.isDeptManager === true) {
            //å¦‚æœæ˜¯ä¸»ä»»ï¼šé»˜è®¤é€‰â€œæ‰€æœ‰åŒ»ç”Ÿâ€
            searchSelect.value = "";
            searchSelect.disabled = false; // ç¡®ä¿å¯é€‰
        } else {
            //å¦‚æœæ˜¯æ™®é€šåŒ»ç”Ÿï¼šé”å®šé€‰è‡ªå·±ï¼Œä¸å…è®¸æŸ¥åˆ«äºº
            searchSelect.value = user.staffId;
            searchSelect.disabled = true;
        }

        // 1.5 æœ€åå†æŸ¥æ•°æ® (ç¡®ä¿å‚æ•°éƒ½å°±ä½äº†)
        fetchSchedules();
    }

    // 2. åŠ è½½åŒ»ç”Ÿåˆ—è¡¨
    async function loadDoctors(deptId, targetSelectId) {
        const targetSelect = document.getElementById(targetSelectId);
        try {
            // å»æ‰ &role=åŒ»ç”Ÿï¼ŒæŸ¥è¯¢ç§‘å®¤æ‰€æœ‰äºº
            const response = await fetch(`http://localhost:8081/staff?deptId=${deptId}&pageSize=100`, {
                headers: { 'Authorization': localStorage.getItem('token') }
            });
            const result = await response.json();

            if (result.code === 200) {
                // ç”Ÿæˆé€‰é¡¹ HTML
                let optionsHtml = result.data.records.map(s =>
                    `<option value="${s.staffId}">${s.staffName} ${s.title ? '('+s.title+')' : ''}</option>`
                ).join('');

                // å¦‚æœæ˜¯æœç´¢æ¡†ï¼Œå¤´éƒ¨æ’å…¥â€œæ‰€æœ‰åŒ»ç”Ÿâ€
                if(targetSelectId === 'searchDoctor') {
                    optionsHtml = '<option value="">æ‰€æœ‰åŒ»ç”Ÿ</option>' + optionsHtml;
                }

                // å¦‚æœæ˜¯æ¨¡æ€æ¡†ï¼Œå¤´éƒ¨æ’å…¥æç¤º
                if(targetSelectId === 'modalStaff') {
                    optionsHtml = '<option value="">è¯·é€‰æ‹©åŒ»ç”Ÿ</option>' + optionsHtml;
                }

                targetSelect.innerHTML = optionsHtml;
            }
        } catch (e) { console.error(e); }
    }

    // 3. è·å–æ’ç­åˆ—è¡¨
    async function fetchSchedules() {
        const token = localStorage.getItem('token');
        if (!token) return window.location.href = 'login.html';

        // è·å–å‚æ•°
        const staffId = document.getElementById('searchDoctor').value;
        const deptId = document.getElementById('searchDept').value;
        const date = document.getElementById('searchDate').value;

        // æ‹¼æ¥ URL
        let url = `http://localhost:8081/schedule/page?current=${currentPage}&pageSize=10`;

        // åªæœ‰å½“é€‰æ‹©äº†ç‰¹å®šåŒ»ç”Ÿæ—¶ï¼Œæ‰ä¼  staffId
        // å¦‚æœ staffId ä¸ºç©ºå­—ç¬¦ä¸²(å³â€œæ‰€æœ‰åŒ»ç”Ÿâ€)ï¼Œå°±ä¸ä¼ è¿™ä¸ªå‚æ•°ï¼Œåç«¯å°±ä¼šæŸ¥æ‰€æœ‰
        if (staffId) url += `&staffId=${staffId}`;

        if (deptId) url += `&deptId=${deptId}`;
        if (date) url += `&startDate=${date}&endDate=${date}`;

        try {
            const response = await fetch(url, {
                headers: { 'Authorization': token }
            });
            const result = await response.json();

            if (result.code === 200) {
                scheduleList = result.data.records;
                renderTable();
                renderPagination(result.data.total, result.data.size); // åˆ«å¿˜äº†åˆ†é¡µ
            } else {
                showMessage('åŠ è½½å¤±è´¥: ' + result.message, 'error');
            }
        } catch (e) {
            console.error(e); // æ‰“å°é”™è¯¯æ–¹ä¾¿è°ƒè¯•
            showMessage('è¿æ¥æœåŠ¡å™¨å¤±è´¥', 'error');
        }
    }

    // 4. æ¸²æŸ“è¡¨æ ¼ (ä¿æŒä¸å˜)
    function renderTable() {
        const tbody = document.getElementById('scheduleTable');
        if (!scheduleList || scheduleList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">æš‚æ— æ’ç­æ•°æ®</td></tr>';
            return;
        }

        tbody.innerHTML = scheduleList.map(item => {
            let statusBadge = '<span class="badge bg-success">å¯æŒ‚å·</span>';
            if (item.availableSlots <= 0) {
                statusBadge = '<span class="badge bg-secondary">å·²æ»¡</span>';
            }
            return `
                    <tr>
                        <td>${item.scheduleDate}</td>
                        <td>${item.timeSlot}</td>
                        <td>${item.deptName}</td>
                        <td><strong>${item.staffName}</strong></td>
                        <td>${item.title || '-'}</td>
                        <td><span class="text-primary fw-bold">${item.bookedSlots}</span> / ${item.totalSlots}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger"
                                ${item.bookedSlots > 0 ? 'disabled' : ''}
                                onclick="deleteSchedule(${item.scheduleId})">
                                åˆ é™¤
                            </button>
                        </td>
                    </tr>
                `;
        }).join('');
    }

    // ç®€å•çš„åˆ†é¡µæ¸²æŸ“ (å¦‚æœæ²¡æœ‰å¼•ç”¨ helper é‡Œçš„)
    function renderPagination(total, size) {
        const totalPages = Math.ceil(total / size);
        const pagination = document.getElementById('pagination');
        if(totalPages <= 1) {
            pagination.innerHTML = '';
            return;
        }

        let html = '';
        html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">ä¸Šä¸€é¡µ</a>
                 </li>`;

        html += `<li class="page-item disabled"><span class="page-link">ç¬¬ ${currentPage} / ${totalPages} é¡µ</span></li>`;

        html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">ä¸‹ä¸€é¡µ</a>
                 </li>`;
        pagination.innerHTML = html;
    }

    function changePage(page) {
        if(page < 1) return;
        currentPage = page;
        fetchSchedules();
    }

    // 5. æ‰“å¼€å¼¹çª— (ä¿æŒé€»è¾‘ä¼˜åŒ–)
    function openAddModal() {
        document.getElementById('addForm').reset();
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        document.querySelector('input[name="scheduleDate"]').valueAsDate = tomorrow;

        // ç¡®ä¿æ¨¡æ€æ¡†é‡Œçš„åŒ»ç”Ÿåˆ—è¡¨ä¹Ÿè¢«é‡ç½®æ˜¾ç¤º
        document.getElementById('modalStaff').value = "";

        new bootstrap.Modal(document.getElementById('addModal')).show();
    }

    // 6. æäº¤æ–°å¢ (ä¿æŒä¸å˜)
    async function submitAdd() {
        const form = document.getElementById('addForm');
        if (!form.checkValidity()) { form.reportValidity(); return; }

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        data.staffId = parseInt(data.staffId);
        data.totalSlots = parseInt(data.totalSlots);
        data.deptId = parseInt(currentDeptId);

        try {
            const response = await fetch('http://localhost:8081/schedule', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': localStorage.getItem('token')
                },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.code === 200) {
                showMessage('æ’ç­åˆ›å»ºæˆåŠŸï¼', 'success');
                bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
                fetchSchedules(); // åˆ·æ–°åˆ—è¡¨
            } else {
                showMessage(result.message, 'error');
            }
        } catch (e) { showMessage('æ“ä½œå¤±è´¥', 'error'); }
    }

    // 7. åˆ é™¤ (ä¿æŒä¸å˜)
    async function deleteSchedule(id) {
        if (!confirm('ç¡®å®šåˆ é™¤è¯¥æ’ç­å—ï¼Ÿ')) return;
        try {
            const response = await fetch(`http://localhost:8081/schedule/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': localStorage.getItem('token') }
            });
            const result = await response.json();
            if (result.code === 200) {
                showMessage('åˆ é™¤æˆåŠŸ', 'success');
                fetchSchedules();
            } else {
                showMessage(result.message, 'error');
            }
        } catch (e) { showMessage('æ“ä½œå¤±è´¥', 'error'); }
    }
</script>
</body>
</html>