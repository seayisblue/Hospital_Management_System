<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¿ä¸ŠæŒ‚å· - åŒ»é™¢é—¨è¯Šç®¡ç†ç³»ç»Ÿ</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/common.css">
    <style>
        .doctor-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .doctor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .doctor-card.selected {
            border: 2px solid #667eea;
            background-color: #f8f9ff;
        }
        .time-slot {
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .time-slot:hover {
            background-color: #e9ecef;
        }
        .time-slot.selected {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }
        .time-slot.disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title mb-0">ğŸ©º çº¿ä¸ŠæŒ‚å·</h4>
                    </div>
                    <div class="card-body">
                        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="steps">
                                    <div class="step active">
                                        <div class="step-number">1</div>
                                        <div class="step-label">é€‰æ‹©ç§‘å®¤</div>
                                    </div>
                                    <div class="step">
                                        <div class="step-number">2</div>
                                        <div class="step-label">é€‰æ‹©åŒ»ç”Ÿ</div>
                                    </div>
                                    <div class="step">
                                        <div class="step-number">3</div>
                                        <div class="step-label">é€‰æ‹©æ—¶é—´</div>
                                    </div>
                                    <div class="step">
                                        <div class="step-number">4</div>
                                        <div class="step-label">ç¡®è®¤æŒ‚å·</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ç§‘å®¤é€‰æ‹© -->
                        <div id="step1" class="step-content">
                            <h5>è¯·é€‰æ‹©å°±è¯Šç§‘å®¤</h5>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <div class="card doctor-card" data-dept="1">
                                        <div class="card-body text-center">
                                            <div class="h3 text-primary">â¤ï¸</div>
                                            <h6>å†…ç§‘</h6>
                                            <small class="text-muted">æ„Ÿå†’ã€å‘çƒ§ã€é«˜è¡€å‹ç­‰</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card doctor-card" data-dept="2">
                                        <div class="card-body text-center">
                                            <div class="h3 text-success">ğŸ¦´</div>
                                            <h6>å¤–ç§‘</h6>
                                            <small class="text-muted">åˆ›ä¼¤ã€æ‰‹æœ¯ã€éª¨ç§‘ç­‰</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card doctor-card" data-dept="3">
                                        <div class="card-body text-center">
                                            <div class="h3 text-warning">ğŸ‘¶</div>
                                            <h6>å„¿ç§‘</h6>
                                            <small class="text-muted">å„¿ç«¥ç–¾ç—…ã€ç”Ÿé•¿å‘è‚²</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card doctor-card" data-dept="å¦‡äº§ç§‘">
                                        <div class="card-body text-center">
                                            <div class="h3 text-danger">ğŸ¤°</div>
                                            <h6>å¦‡äº§ç§‘</h6>
                                            <small class="text-muted">å¦‡ç§‘ç–¾ç—…ã€å­•äº§æ£€æŸ¥</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card doctor-card" data-dept="çœ¼ç§‘">
                                        <div class="card-body text-center">
                                            <div class="h3 text-info">ğŸ‘ï¸</div>
                                            <h6>çœ¼ç§‘</h6>
                                            <small class="text-muted">è§†åŠ›æ£€æŸ¥ã€çœ¼éƒ¨ç–¾ç—…</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <div class="card doctor-card" data-dept="å£è…”ç§‘">
                                        <div class="card-body text-center">
                                            <div class="h3 text-secondary">ğŸ¦·</div>
                                            <h6>å£è…”ç§‘</h6>
                                            <small class="text-muted">ç‰™é½¿æ£€æŸ¥ã€å£è…”æ²»ç–—</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end">
                                <button class="btn btn-primary" onclick="nextStep(1)">ä¸‹ä¸€æ­¥</button>
                            </div>
                        </div>

                        <!-- åŒ»ç”Ÿé€‰æ‹© -->
                        <div id="step2" class="step-content d-none">
                            <h5>è¯·é€‰æ‹©åŒ»ç”Ÿ</h5>
                            <div class="row" id="doctorList">
                                <!-- åŒ»ç”Ÿåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            <div class="row mt-3">
                                <div class="col-6">
                                    <button class="btn btn-outline-secondary" onclick="prevStep(2)">ä¸Šä¸€æ­¥</button>
                                </div>
                                <div class="col-6 text-end">
                                    <button class="btn btn-primary" onclick="nextStep(2)">ä¸‹ä¸€æ­¥</button>
                                </div>
                            </div>
                        </div>

                        <!-- æ—¶é—´é€‰æ‹© -->
                        <div id="step3" class="step-content d-none">
                            <h5>è¯·é€‰æ‹©å°±è¯Šæ—¶é—´</h5>
                            <div class="mb-3">
                                <label class="form-label">é€‰æ‹©æ—¥æœŸ</label>
                                <input type="date" class="form-control" id="appointmentDate" min="">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">é€‰æ‹©æ—¶é—´æ®µ</label>
                                <div class="row" id="timeSlots">
                                    <!-- æ—¶é—´æ®µå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-6">
                                    <button class="btn btn-outline-secondary" onclick="prevStep(3)">ä¸Šä¸€æ­¥</button>
                                </div>
                                <div class="col-6 text-end">
                                    <button class="btn btn-primary" onclick="nextStep(3)">ä¸‹ä¸€æ­¥</button>
                                </div>
                            </div>
                        </div>

                        <!-- ç¡®è®¤æŒ‚å· -->
                        <div id="step4" class="step-content d-none">
                            <h5>ç¡®è®¤æŒ‚å·ä¿¡æ¯</h5>
                            <div class="card">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>ç§‘å®¤ï¼š</strong><span id="confirmDept">-</span></p>
                                            <p><strong>åŒ»ç”Ÿï¼š</strong><span id="confirmDoctor">-</span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>æ—¶é—´ï¼š</strong><span id="confirmTime">-</span></p>
                                            <p><strong>è´¹ç”¨ï¼š</strong><span id="confirmFee">-</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-6">
                                    <button class="btn btn-outline-secondary" onclick="prevStep(4)">ä¸Šä¸€æ­¥</button>
                                </div>
                                <div class="col-6 text-end">
                                    <button class="btn btn-success" onclick="confirmAppointment()">ç¡®è®¤æŒ‚å·</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../utils/helpers.js"></script>

    <script>
        // å…¨å±€å˜é‡å­˜å‚¨æ•°æ®
        let appointmentData = {
            deptId: null,
            deptName: '',
            doctor: null,
            schedule: null // æœ€ç»ˆé€‰ä¸­çš„æ’ç­å¯¹è±¡
        };

        // ç¼“å­˜ä»åç«¯æŸ¥å›æ¥çš„æ’ç­åˆ—è¡¨
        let availableSchedules = [];

        document.addEventListener('DOMContentLoaded', function() {
            loadNavbar();
            initPage();
        });

        function initPage() {
            // 1. ç»‘å®šç§‘å®¤ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.doctor-card[data-dept]').forEach(card => {
                card.addEventListener('click', function() {
                    document.querySelectorAll('.doctor-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');

                    appointmentData.deptId = this.dataset.dept;
                    appointmentData.deptName = this.querySelector('h6').innerText;
                });
            });
        }

        // æµç¨‹æ§åˆ¶ï¼šä¸‹ä¸€æ­¥
        async function nextStep(currentStep) {
            // æ ¡éªŒç¬¬ä¸€æ­¥ï¼šé€‰ç§‘å®¤
            if (currentStep === 1) {
                if (!appointmentData.deptId) {
                    showMessage('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç§‘å®¤ï¼', 'error');
                    return;
                }
                // â˜…â˜…â˜… å…³é”®ï¼šé€‰å®Œç§‘å®¤ï¼Œå»åç«¯æŸ¥æ’ç­ â˜…â˜…â˜…
                await fetchSchedules(appointmentData.deptId);

                if (availableSchedules.length === 0) {
                    showMessage('è¯¥ç§‘å®¤è¿‘æœŸæš‚æ— æ’ç­ï¼Œè¯·é€‰æ‹©å…¶ä»–ç§‘å®¤', 'warning');
                    return;
                }
                generateDoctorList(); // æ ¹æ®æ’ç­ç”ŸæˆåŒ»ç”Ÿåˆ—è¡¨
            }

            // æ ¡éªŒç¬¬äºŒæ­¥ï¼šé€‰åŒ»ç”Ÿ
            if (currentStep === 2) {
                if (!appointmentData.doctor) {
                    showMessage('è¯·é€‰æ‹©åŒ»ç”Ÿï¼', 'error');
                    return;
                }
                generateTimeSlots(); // æ ¹æ®åŒ»ç”Ÿç”Ÿæˆæ—¶é—´æ®µ
            }

            // æ ¡éªŒç¬¬ä¸‰æ­¥ï¼šé€‰æ—¶é—´
            if (currentStep === 3) {
                if (!appointmentData.schedule) {
                    showMessage('è¯·é€‰æ‹©å°±è¯Šæ—¶é—´ï¼', 'error');
                    return;
                }
                updateConfirmation(); // æ›´æ–°ç¡®è®¤ä¿¡æ¯
            }

            // åˆ‡æ¢æ˜¾ç¤º
            document.getElementById(`step${currentStep}`).classList.add('d-none');
            document.getElementById(`step${currentStep + 1}`).classList.remove('d-none');
            updateStepIndicator(currentStep + 1);
        }

        function prevStep(currentStep) {
            document.getElementById(`step${currentStep}`).classList.add('d-none');
            document.getElementById(`step${currentStep - 1}`).classList.remove('d-none');
            updateStepIndicator(currentStep - 1);
        }

        function updateStepIndicator(step) {
            document.querySelectorAll('.step').forEach((stepEl, index) => {
                if (index + 1 <= step) stepEl.classList.add('active');
                else stepEl.classList.remove('active');
            });
        }

        // â˜…â˜…â˜… æ ¸å¿ƒï¼šä»åç«¯è·å–æ’ç­æ•°æ® â˜…â˜…â˜…
        async function fetchSchedules(deptId) {
            const token = localStorage.getItem('token');
            if(!token) return window.location.href = 'login.html';

            try {
                // æ¥å£: GET /appointment/schedules?deptId=1
                const response = await fetch(`http://localhost:8081/appointment/schedules?deptId=${deptId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': token
                    }
                });
                const result = await response.json();
                if (result.code === 200) {
                    availableSchedules = result.data; // æ‹¿åˆ°æ’ç­åˆ—è¡¨
                    console.log('æ’ç­æ•°æ®:', availableSchedules);
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (e) {
                console.error(e);
                showMessage('è·å–æ’ç­å¤±è´¥', 'error');
            }
        }

        // ç”ŸæˆåŒ»ç”Ÿåˆ—è¡¨ (æ ¹æ®æ’ç­æ•°æ®å»é‡)
        function generateDoctorList() {
            const container = document.getElementById('doctorList');
            // åˆ©ç”¨ Map å»é‡åŒ»ç”Ÿ
            const doctorsMap = new Map();
            availableSchedules.forEach(sch => {
                if (!doctorsMap.has(sch.staffId)) {
                    doctorsMap.set(sch.staffId, {
                        id: sch.staffId,
                        name: sch.staffName,
                        title: sch.title || 'åŒ»ç”Ÿ'
                    });
                }
            });

            let html = '';
            doctorsMap.forEach(doc => {
                html += `
                <div class="col-md-6 mb-3">
                    <div class="card doctor-card" onclick="selectDoctor(${doc.id}, '${doc.name}', '${doc.title}', this)">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-8">
                                    <h6>${doc.name}</h6>
                                    <small class="text-muted">${doc.title}</small>
                                </div>
                                <div class="col-4 text-end">
                                    <div class="h3 text-success">ğŸ©º</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function selectDoctor(id, name, title, el) {
            appointmentData.doctor = { id, name, title };
            // æ ·å¼å¤„ç†
            document.querySelectorAll('#doctorList .doctor-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }

        // ç”Ÿæˆæ—¶é—´æ®µ (ç­›é€‰å‡ºé€‰ä¸­åŒ»ç”Ÿçš„æ’ç­)
        function generateTimeSlots() {
            const container = document.getElementById('timeSlots');
            // è¿‡æ»¤å‡ºå½“å‰åŒ»ç”Ÿçš„æ’ç­
            const mySchedules = availableSchedules.filter(s => s.staffId === appointmentData.doctor.id);

            if(mySchedules.length === 0) {
                container.innerHTML = 'è¯¥åŒ»ç”Ÿæš‚æ— æ’ç­';
                return;
            }

            // è¿™é‡Œçš„æ—¥æœŸè¾“å…¥æ¡†å…¶å®æ²¡ç”¨äº†ï¼Œå› ä¸ºæˆ‘ä»¬ç›´æ¥åˆ—å‡ºæ‰€æœ‰å¯ç”¨æ’ç­
            document.getElementById('appointmentDate').parentNode.style.display = 'none';

            container.innerHTML = mySchedules.map(sch => `
            <div class="col-md-4 mb-2">
                <div class="time-slot text-center" onclick="selectSchedule(${sch.scheduleId}, '${sch.scheduleDate}', '${sch.timeSlot}', this)">
                    <div>${sch.scheduleDate}</div>
                    <div>${sch.timeSlot}</div>
                    <small>ä½™å·: ${sch.availableSlots}</small>
                </div>
            </div>
        `).join('');
        }

        function selectSchedule(id, date, time, el) {
            appointmentData.schedule = { id, date, time };
            document.querySelectorAll('.time-slot').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }

        // æ›´æ–°ç¡®è®¤ä¿¡æ¯
        function updateConfirmation() {
            document.getElementById('confirmDept').textContent = appointmentData.deptName;
            document.getElementById('confirmDoctor').textContent = `${appointmentData.doctor.name} (${appointmentData.doctor.title})`;
            document.getElementById('confirmTime').textContent = `${appointmentData.schedule.date} ${appointmentData.schedule.time}`;
            document.getElementById('confirmFee').textContent = "Â¥15.00"; // ä½ çš„åç«¯é»˜è®¤å†™äº†15å…ƒ
        }

        // â˜…â˜…â˜… æœ€ç»ˆæäº¤ï¼šç¡®è®¤æŒ‚å· â˜…â˜…â˜…
        async function confirmAppointment() {
            try {
                const response = await fetch('http://localhost:8081/appointment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': localStorage.getItem('token')
                    },
                    body: JSON.stringify({
                        scheduleId: appointmentData.schedule.id // åç«¯åªéœ€è¦ scheduleId
                    })
                });

                const result = await response.json();

                if (result.code === 200) {
                    showMessage('æŒ‚å·æˆåŠŸï¼', 'success');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html'; // è·³å›é¦–é¡µçœ‹â€œæœ€è¿‘é¢„çº¦â€
                    }, 1500);
                } else {
                    showMessage('æŒ‚å·å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                console.error(error);
                showMessage('è¿æ¥æœåŠ¡å™¨å¤±è´¥', 'error');
            }
        }
    </script>

    <style>
        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 15px;
            right: -50%;
            width: 100%;
            height: 2px;
            background-color: #dee2e6;
            z-index: 1;
        }
        .step.active:not(:last-child)::after {
            background-color: #667eea;
        }
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #dee2e6;
            color: white;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
        }
        .step.active .step-number {
            background-color: #667eea;
        }
        .step-label {
            font-size: 0.875rem;
            color: #6c757d;
        }
        .step.active .step-label {
            color: #667eea;
            font-weight: bold;
        }
    </style>
</body>
</html>