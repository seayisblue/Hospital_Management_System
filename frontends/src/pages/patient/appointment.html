<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>线上挂号 - 医院门诊管理系统</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/common.css">

    <style>
        :root {
            --theme-start: #4CA1AF;
            --theme-end: #C4E0E5;
            --text-main: #2c3e50;
        }

        body {
            /* 全局渐变背景 */
            background: linear-gradient(180deg, var(--theme-start) 0%, var(--theme-end) 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: var(--text-main);
            scroll-behavior: smooth;
        }

        .booking-wrapper {
            display: flex;
            max-width: 1200px;
            margin: 80px auto;
            min-height: 80vh;
        }

        /* 左侧垂直进度条 (圆点与线) */
        .sidebar-nav {
            width: 200px;
            position: sticky;
            top: 100px;
            height: fit-content;
            padding-left: 30px;
        }

        .nav-timeline {
            position: relative;
            padding: 0;
            list-style: none;
        }

        /* 中间的纵线 */
        .nav-timeline::before {
            content: '';
            position: absolute;
            left: 14px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgba(255, 255, 255, 0.3);
            z-index: 1;
        }

        .nav-step {
            position: relative;
            margin-bottom: 180px;
            z-index: 2;
            display: flex;
            align-items: center;
            opacity: 0.6;
            transition: all 0.4s ease;

        }

        .nav-step.active {
            opacity: 1;
        }

        .dot {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid #fff;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            transition: all 0.3s;
        }

        .nav-step.active .dot {
            background: #fff;
            color: var(--theme-start);
            box-shadow: 0 0 15px rgba(255,255,255,0.5);
        }

        .label {
            color: #fff;
            font-weight: 500;
            font-size: 1rem;
        }

        /* 右侧内容区 */
        .content-area {
            flex: 1;
            padding-left: 50px;
            padding-bottom: 150px;
        }

        .section-panel {
            background: rgba(255, 255, 255, 0.7); /* 半透明白色面板 */
            backdrop-filter: blur(10px);
            padding: 40px;
            margin-bottom: 80px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 30px;
            color: var(--theme-start);
            display: flex;
            align-items: center;
        }

        .section-title i { margin-right: 10px; }

        /* 网格列表样式 */
        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .option-card {
            background: #fff;
            border: 1px solid #eee;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-card:hover {
            border-color: var(--theme-start);
            transform: translateY(-2px);
        }

        .option-card.selected {
            background: var(--theme-start);
            color: #fff !important;
            border-color: var(--theme-start);
        }

        .option-card.selected .text-muted {
            color: rgba(255,255,255,0.8) !important;
        }

        /* 确认按钮区 */
        .confirm-box {
            border-top: 1px solid #eee;
            margin-top: 20px;
            padding-top: 20px;
        }

        .btn-confirm {
            background: var(--theme-start);
            color: #fff;
            border: none;
            padding: 12px 35px;
            font-weight: 600;
            transition: opacity 0.3s;
        }

        .btn-confirm:hover {
            opacity: 0.9;
            color: #fff;
        }

        /* 时间槽样式 */
        .slot-pill {
            background: #fff; /* 新增：默认白色背景 */
            border: 1px solid #eee; /* 统一边框 */
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
        }
        .slot-pill.selected {
            background: var(--theme-start);
            color: white;
            border-color: var(--theme-start);
        }

    </style>
</head>

<body>
<div id="navbar-container"></div>

<div class="booking-wrapper">
    <div class="sidebar-nav">
        <ul class="nav-timeline">
            <li class="nav-step active" id="node1">
                <div class="dot">1</div>
                <div class="label">选择科室</div>
            </li>
            <li class="nav-step" id="node2">
                <div class="dot">2</div>
                <div class="label">选择医生</div>
            </li>
            <li class="nav-step" id="node3">
                <div class="dot">3</div>
                <div class="label">就诊时间</div>
            </li>
            <li class="nav-step" id="node4">
                <div class="dot">4</div>
                <div class="label">核对信息</div>
            </li>
        </ul>
    </div>

    <div class="content-area">

        <section id="step1" class="section-panel">
            <h2 class="section-title"><i class="material-icons-outlined">business</i> 选择科室</h2>
            <div id="deptList" class="option-grid">
                <div class="text-muted">正在载入科室...</div>
            </div>
        </section>

        <section id="step2" class="section-panel d-none">
            <h2 class="section-title"><i class="material-icons-outlined">person_search</i> 选择医生</h2>
            <div id="doctorList" class="option-grid"></div>
        </section>

        <section id="step3" class="section-panel d-none">
            <h2 class="section-title"><i class="material-icons-outlined">history_toggle_off</i> 选择就诊日期与时段</h2>
            <div id="timeSlots" class="option-grid"></div>
        </section>

        <section id="step4" class="section-panel d-none">
            <h2 class="section-title"><i class="material-icons-outlined">fact_check</i> 核对预约单</h2>
            <div class="row g-4">
                <div class="col-md-6">
                    <small class="text-muted d-block">预约科室</small>
                    <p class="h5" id="confirmDept">-</p>
                </div>
                <div class="col-md-6">
                    <small class="text-muted d-block">主治医生</small>
                    <p class="h5" id="confirmDoctor">-</p>
                </div>
                <div class="col-md-6">
                    <small class="text-muted d-block">预约时间</small>
                    <p class="h5" id="confirmTime">-</p>
                </div>
                <div class="col-md-6">
                    <small class="text-muted d-block">挂号费用</small>
                    <p class="h5 text-danger" id="confirmFee">¥ 15.00</p>
                </div>
            </div>
            <div class="confirm-box text-end">
                <button class="btn btn-confirm" onclick="confirmAppointment()">确认并提交挂号</button>
            </div>
        </section>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../../utils/helpers.js"></script>

<script>
    let appointmentData = {
        deptId: null,
        deptName: '',
        doctor: null,
        schedule: null
    };

    let availableSchedules = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadNavbar();
        fetchDepartments();
    });

    async function fetchDepartments() {
        try {
            const response = await fetch('http://localhost:8081/department', {
                method: 'GET',
                headers: { 'Authorization': localStorage.getItem('patientToken') }
            });
            const result = await response.json();
            if (result.code === 200) {
                renderDepartments(result.data);
            }
        } catch (error) {
            console.error(error);
        }
    }

    function renderDepartments(departments) {
        const container = document.getElementById('deptList');
        container.innerHTML = departments.map(dept => `
            <div class="option-card" onclick="selectDept(${dept.deptId}, '${dept.deptName}', this)">
                <div class="fw-bold">${dept.deptName}</div>

            </div>
        `).join('');
    }

    async function selectDept(deptId, deptName, element) {
        document.querySelectorAll('#deptList .option-card').forEach(c => c.classList.remove('selected'));
        element.classList.add('selected');

        appointmentData.deptId = deptId;
        appointmentData.deptName = deptName;

        await fetchSchedules(deptId);

        if (availableSchedules.length > 0) {
            generateDoctorList();
            activateStep(2);
        } else {
            showMessage('该科室暂无排班', 'warning');
        }
    }

    function generateDoctorList() {
        const container = document.getElementById('doctorList');
        const doctorsMap = new Map();
        availableSchedules.forEach(sch => {
            if (!doctorsMap.has(sch.staffId)) {
                doctorsMap.set(sch.staffId, { id: sch.staffId, name: sch.staffName, title: sch.title });
            }
        });

        container.innerHTML = Array.from(doctorsMap.values()).map(doc => `
            <div class="option-card" onclick="selectDoctor(${doc.id}, '${doc.name}', '${doc.title}', this)">
                <div class="fw-bold">${doc.name}</div>
                <small class="text-muted">${doc.title || '医师'}</small>
            </div>
        `).join('');
    }

    function selectDoctor(id, name, title, el) {
        document.querySelectorAll('#doctorList .option-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');

        appointmentData.doctor = { id, name, title };
        generateTimeSlots();
        activateStep(3);
    }

    function generateTimeSlots() {
        const container = document.getElementById('timeSlots');
        const mySchedules = availableSchedules.filter(s => s.staffId === appointmentData.doctor.id);

        container.innerHTML = mySchedules.map(sch => `
            <div class="slot-pill" onclick="selectSchedule(${sch.scheduleId}, '${sch.scheduleDate}', '${sch.timeSlot}', this)">
                <div class="fw-bold">${sch.scheduleDate}</div>
                <div class="small">${sch.timeSlot}</div>
                <div class="small opacity-75">余 ${sch.availableSlots}</div>
            </div>
        `).join('');
    }

    function selectSchedule(id, date, time, el) {
        document.querySelectorAll('.slot-pill').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');

        appointmentData.schedule = { id, date, time };
        updateConfirmation();
        activateStep(4);
    }

    // 逻辑流转与滚动
    function activateStep(stepNumber) {
        const section = document.getElementById(`step${stepNumber}`);
        section.classList.remove('d-none');

        // 更新左侧节点高亮
        document.querySelectorAll('.nav-step').forEach((node, idx) => {
            if(idx + 1 <= stepNumber) node.classList.add('active');
        });

        // 平滑滚动至新开启的区域
        setTimeout(() => {
            window.scrollTo({
                top: section.offsetTop - 120,
                behavior: 'smooth'
            });
        }, 100);
    }

    function updateConfirmation() {
        document.getElementById('confirmDept').textContent = appointmentData.deptName;
        document.getElementById('confirmDoctor').textContent = `${appointmentData.doctor.name} (${appointmentData.doctor.title})`;
        document.getElementById('confirmTime').textContent = `${appointmentData.schedule.date} ${appointmentData.schedule.time}`;
    }

    function getTodayStr() {
        const now = new Date();
        const y = now.getFullYear();
        const m = String(now.getMonth() + 1).padStart(2, '0');
        const d = String(now.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    async function fetchSchedules(deptId) {
        try {
            const response = await fetch(`http://localhost:8081/appointment/schedules?deptId=${deptId}`, {
                method: 'GET',
                headers: { 'Authorization': localStorage.getItem('patientToken') }
            });
            const result = await response.json();
            if (result.code === 200) {
                const todayStr = getTodayStr();
                availableSchedules = result.data.filter(sch => sch.scheduleDate >= todayStr);
            }
        } catch (e) {
            showMessage('获取排班失败', 'error');
        }
    }

    async function confirmAppointment() {
        try {
            const response = await fetch('http://localhost:8081/appointment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': localStorage.getItem('patientToken')
                },
                body: JSON.stringify({ scheduleId: appointmentData.schedule.id })
            });
            const result = await response.json();
            if (result.code === 200) {
                showMessage('挂号成功', 'success');
                setTimeout(() => window.location.href = 'dashboard.html', 1500);
            } else {
                showMessage(result.message, 'error');
            }
        } catch (error) {
            showMessage('连接服务器失败', 'error');
        }
    }
</script>
</body>
</html>
