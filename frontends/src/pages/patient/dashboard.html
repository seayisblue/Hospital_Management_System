<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‚£è€…é¦–é¡µ - åŒ»é™¢é—¨è¯Šç®¡ç†ç³»ç»Ÿ</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/common.css">
</head>
<body>
    <!-- å¯¼èˆªæ å®¹å™¨ -->
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <!-- æ¬¢è¿æ¨ªå¹… -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h3 id="welcomeMsg">æ¬¢è¿å›æ¥ï¼</h3>
                                <p class="mb-0">ä»Šå¤©æ„Ÿè§‰æ€ä¹ˆæ ·ï¼Ÿæˆ‘ä»¬éšæ—¶ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„åŒ»ç–—æœåŠ¡ã€‚</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="h4">ğŸ“… 2024å¹´1æœˆ15æ—¥</div>
                                <div>æ˜ŸæœŸä¸€</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åŠŸèƒ½å¡ç‰‡ -->
        <div class="row">
            <!-- çº¿ä¸ŠæŒ‚å· -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="h1 text-primary">ğŸ©º</div>
                        <h5 class="card-title">çº¿ä¸ŠæŒ‚å·</h5>
                        <p class="card-text">é€‰æ‹©ç§‘å®¤åŒ»ç”Ÿï¼Œé¢„çº¦å°±è¯Šæ—¶é—´</p>
                        <a href="appointment.html" class="btn btn-primary">ç«‹å³æŒ‚å·</a>
                    </div>
                </div>
            </div>

            <!-- å°±è¯Šè®°å½• -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="h1 text-success">ğŸ“‹</div>
                        <h5 class="card-title">å°±è¯Šè®°å½•</h5>
                        <p class="card-text">æŸ¥çœ‹å†å²ç—…å†å’Œè¯Šæ–­ä¿¡æ¯</p>
                        <a href="medical-records.html" class="btn btn-primary">æŸ¥çœ‹è®°å½•</a>
                    </div>
                </div>
            </div>

            <!-- æˆ‘çš„å¤„æ–¹ -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="h1 text-warning">ğŸ’Š</div>
                        <h5 class="card-title">æˆ‘çš„å¤„æ–¹</h5>
                        <p class="card-text">æŸ¥çœ‹åŒ»ç”Ÿå¼€å…·çš„å¤„æ–¹ä¿¡æ¯</p>
                        <a href="prescriptions.html" class="btn btn-primary">æŸ¥çœ‹å¤„æ–¹</a>
                    </div>
                </div>
            </div>

            <!-- ä¸ªäººä¿¡æ¯ -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="h1 text-info">ğŸ‘¤</div>
                        <h5 class="card-title">ä¸ªäººä¿¡æ¯</h5>
                        <p class="card-text">ç®¡ç†ä¸ªäººèµ„æ–™å’Œè´¦æˆ·è®¾ç½®</p>
                        <a href="profile.html" class="btn btn-primary">ç®¡ç†ä¿¡æ¯</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- æœ€è¿‘é¢„çº¦ -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">æœ€è¿‘é¢„çº¦</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>é¢„çº¦æ—¶é—´</th>
                                        <th>ç§‘å®¤</th>
                                        <th>åŒ»ç”Ÿ</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="appointmentList"> </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../utils/helpers.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadNavbar();
            initDashboard();
        });

        function initDashboard() {
            // 1. æ˜¾ç¤ºæ¬¢è¿è¯­
            const userName = localStorage.getItem('userName') || 'æ‚£è€…';
            const welcomeEl = document.getElementById('welcomeMsg'); // ç¡®ä¿ä½ çš„ HTML é‡Œæœ‰ id="welcomeMsg"
            if (welcomeEl) welcomeEl.textContent = `æ¬¢è¿å›æ¥ï¼Œ${userName}ï¼`;

            // 2. åŠ è½½é¢„çº¦åˆ—è¡¨
            fetchMyAppointments();
        }

        // â˜…â˜…â˜… è·å–æˆ‘çš„æŒ‚å·è®°å½• â˜…â˜…â˜…
        async function fetchMyAppointments() {
            const token = localStorage.getItem('token');
            // å¦‚æœæ²¡ Tokenï¼Œè¸¢å›ç™»å½•é¡µ
            if (!token) {
                // alert('æœªç™»å½•'); // å¯é€‰
                return window.location.href = 'login.html';
            }

            try {
                // âš ï¸ æ³¨æ„ï¼šç«¯å£å·å¿…é¡»æ˜¯ 8081
                const response = await fetch('http://localhost:8081/appointment/my', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    }
                });

                const result = await response.json();

                if (result.code === 200) {
                    renderAppointmentTable(result.data);
                } else {
                    // å¦‚æœ Token è¿‡æœŸ (401)ï¼Œå›ç™»å½•é¡µ
                    if (result.code === 401) {
                        window.location.href = 'login.html';
                    } else {
                        showMessage('åŠ è½½å¤±è´¥: ' + result.message, 'error');
                    }
                }
            } catch (error) {
                console.error('è¯·æ±‚é”™è¯¯:', error);
                // å¦‚æœè¿™é‡ŒæŠ¥é”™ï¼Œè¯´æ˜è¿ä¸ä¸Š 8081
                showMessage('è¿æ¥æœåŠ¡å™¨å¤±è´¥ (è¯·æ£€æŸ¥åç«¯ 8081 æ˜¯å¦å¯åŠ¨)', 'error');
            }
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderAppointmentTable(list) {
            const tbody = document.getElementById('appointmentList');

            if (!list || list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">æš‚æ— é¢„çº¦è®°å½•</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(item => {
                // æ—¶é—´æ ¼å¼åŒ–
                const timeStr = item.appointmentTime ? item.appointmentTime.replace('T', ' ').substring(0, 16) : '-';

                // çŠ¶æ€æ ·å¼
                let badgeClass = 'bg-secondary';
                let actionBtn = '';

                if (item.status === 'å¾…å°±è¯Š') {
                    badgeClass = 'bg-warning text-dark';
                    actionBtn = `<button class="btn btn-sm btn-outline-danger" onclick="cancelAppointment(${item.appointmentId})">å–æ¶ˆ</button>`;
                } else if (item.status === 'å·²å°±è¯Š') {
                    badgeClass = 'bg-success';
                    actionBtn = `<button class="btn btn-sm btn-outline-primary" onclick="location.href='medical-records.html'">ç—…å†</button>`;
                }

                return `
                <tr>
                    <td>${timeStr}</td>
                    <td>${item.deptName}</td>
                    <td>${item.staffName}</td>
                    <td><span class="badge ${badgeClass}">${item.status}</span></td>
                    <td>${actionBtn}</td>
                </tr>
            `;
            }).join('');
        }

        // å–æ¶ˆé¢„çº¦
        async function cancelAppointment(id) {
            if (!confirm('ç¡®å®šå–æ¶ˆå—ï¼Ÿ')) return;
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`http://localhost:8081/appointment/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': token }
                });
                const result = await response.json();
                if (result.code === 200) {
                    showMessage('å–æ¶ˆæˆåŠŸ', 'success');
                    fetchMyAppointments(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                showMessage('æ“ä½œå¤±è´¥', 'error');
            }
        }
    </script>
</body>
</html>