<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>患者首页 - 智慧医院</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../../styles/common.css">
    <style>
        /* 这里放该页面特有的样式，稍后可以移入 common.css */
        :root {
            --medical-blue: #4CA1AF;
            --medical-light: #C4E0E5;
        }

        body { background-color: #C4E0E5; }

        /* 标题背景区 */
        .hero-banner {
            height: 800px;
            background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)),
            url('../../assets/images/hos_bg2.png') center/cover no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            position: relative;
            margin-top: 50px;
        }

        .banner-text {
            position: absolute; /* 使用绝对定位 */
            top: 150px; /* 调整这个值以控制距离顶部的距离 */
            left: 0;
            right: 0;
            text-align: center; /* 如果希望文本居中 */
            color: white; /* 根据背景图颜色选择合适的文字颜色 */
        }
        /* 宫格布局 - 仿照图片效果 */
        .portal-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(2, 180px);
            gap: 20px;
            margin-top: -450px; /* 向上浮动到背景图上 */

        }

        .grid-item {
            background: white;

            padding: 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all 0.3s ease;
            text-decoration: none;
            color: #C4E0E5;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            position: relative;
            overflow: hidden;
            opacity: 0.7;

        }
        .grid-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.1);
            color: var(--medical-blue);
            opacity: 0.8;
        }

        .grid-item i {
            font-size: 2.5rem;
            color: var(--medical-blue);
        }
        .grid-item h5 {
            font-weight: bold;
            margin-top: 15px;

        }



        /* 跨行/跨列的大格子（对应图片中的重点功能） */
        .item-main { grid-column: span 2; grid-row: span 2; background-color: var(--medical-blue); color: white; }
        .item-main i, .item-main h4, .item-main p { color: white; }
        .item-main h4 {
            font-weight: 600;
        }
        .item-main:hover{
            opacity: 0.9;
        }
        .custom-margin-container {
            margin-top: 60px !important;    /* 距离上方 20px */

        }


    </style>
</head>
<body>
<div id="navbar-container"></div>

<div class="hero-banner">
    <div class="banner-text">
        <h1 class="display-4 fw-bold" id="welcomeMsg">欢迎来到智慧医疗</h1>
        <p class="lead">专业、高效、贴心的医疗服务就在您身边</p>
    </div>
</div>

<div class="container mb-5">
    <div class="portal-grid">
        <a href="appointment.html" class="grid-item item-main">
            <div>
                <i class="bi bi-calendar-check"></i>
                <h4 class="mt-3">线上挂号</h4>
                <p class="desc">快速选择科室医生，预约精准就诊时间，告别排队烦恼。</p>
            </div>
        </a>

        <a href="medical-records.html" class="grid-item">
            <i class="bi bi-file-earmark-medical"></i>
            <h5>就诊记录</h5>
        </a>

        <a href="prescriptions.html" class="grid-item">
            <i class="bi bi-capsule"></i>
            <h5>我的处方</h5>
        </a>

        <a href="profile.html" class="grid-item">
            <i class="bi bi-person-badge"></i>
            <h5>个人信息</h5>
        </a>

        <a href="#" class="grid-item">
            <i class="bi bi-info-circle"></i>
            <h5>就医指南</h5>
        </a>
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <div class="appointment-section">
                <div class="custom-margin-container d-flex justify-content-between align-items-center mb-4">
                    <h4 class="section-title-modern">
                        <i class="bi bi-clock-history me-2"></i>最近预约
                    </h4>
                    <a href="appointment.html" class="view-all-link">查看全部预约 <i class="bi bi-arrow-right-short"></i></a>
                </div>

                <div id="appointmentList" class="appointment-grid-modern">
                    <div class="text-center p-5 text-muted bg-white rounded-4 shadow-sm">
                        <i class="bi bi-calendar-x d-block fs-1 mb-2"></i>
                        暂无预约记录
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../../utils/helpers.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        loadNavbar();
        initDashboard();
    });

    function initDashboard() {
        // 1. 显示欢迎语
        const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
        const userName = userInfo.patientName || '患者';
        const welcomeEl = document.getElementById('welcomeMsg'); // 确保你的 HTML 里有 id="welcomeMsg"
        if (welcomeEl) welcomeEl.textContent = `欢迎回来，${userName}！`;

        // 2. 加载预约列表
        fetchMyAppointments();
    }

    // ★★★ 获取我的挂号记录 ★★★
    async function fetchMyAppointments() {
        const token = localStorage.getItem('patientToken');
        // 如果没 Token，踢回登录页
        if (!token) {
            // alert('未登录'); // 可选
            return window.location.href = 'login.html';
        }

        try {
            // ⚠️ 注意：端口号必须是 8081
            const response = await fetch('http://localhost:8081/appointment/my', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token
                }
            });

            const result = await response.json();

            if (result.code === 200) {
                renderAppointmentTable(result.data);
            } else {
                // 如果 Token 过期 (401)，回登录页
                if (result.code === 401) {
                    window.location.href = 'login.html';
                } else {
                    showMessage('加载失败: ' + result.message, 'error');
                }
            }
        } catch (error) {
            console.error('请求错误:', error);
            // 如果这里报错，说明连不上 8081
            showMessage('连接服务器失败 (请检查后端 8081 是否启动)', 'error');
        }
    }

    // 渲染表格
    function renderAppointmentTable(list) {
        const container = document.getElementById('appointmentList');

        if (!list || list.length === 0) {
            container.innerHTML = `
            <div class="text-center p-5 text-muted bg-white rounded-4 shadow-sm">
                <i class="bi bi-calendar-x d-block fs-1 mb-2"></i>
                暂无预约记录
            </div>`;
            return;
        }

        container.innerHTML = list.map(item => {
            // 1. 核心修改：不再从 appointmentTime 拆分
            // 直接使用 scheduleDate 和 timeSlot 组合成就诊时间
            const date = item.scheduleDate || "未知日期";
            const slot = item.timeSlot || "未知时段";

            let statusClass = item.status === '待就诊' ? 'bg-waiting' : 'bg-done';
            let actionBtn = '';

            if (item.status === '待就诊') {
                actionBtn = `<button class="btn btn-outline-danger btn-action-modern" onclick="cancelAppointment(${item.appointmentId})">取消预约</button>`;
            } else if (item.status === '已就诊') {
                actionBtn = `<button class="btn btn-primary btn-action-modern" onclick="location.href='medical-records.html'">查看病历</button>`;
            }

            return `
        <div class="appointment-item-modern">
            <div class="apt-info-left">
                <div class="apt-date-box">
                    <div class="time">${slot}</div>
                    <div class="date">${date}</div>
                </div>
                <div class="apt-details">
                    <h6>${item.deptName} - ${item.staffName} 医生</h6>
                    <p><i class="bi bi-geo-alt me-1"></i> 门诊大楼 3 楼 ${item.deptName}诊室</p>
                </div>
            </div>
            <div class="d-flex align-items-center gap-3">
                <span class="badge-modern ${statusClass}">${item.status}</span>
                ${actionBtn}
            </div>
        </div>
        `;
        }).join('');
    }

    // 取消预约
    async function cancelAppointment(id) {
        if (!confirm('确定取消吗？')) return;
        const token = localStorage.getItem('patientToken');

        try {
            const response = await fetch(`http://localhost:8081/appointment/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': token }
            });
            const result = await response.json();
            if (result.code === 200) {
                showMessage('取消成功', 'success');
                fetchMyAppointments(); // 刷新列表
            } else {
                showMessage(result.message, 'error');
            }
        } catch (error) {
            showMessage('操作失败', 'error');
        }
    }
</script>
</body>
</html>
