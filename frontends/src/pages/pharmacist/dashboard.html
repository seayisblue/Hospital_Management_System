<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯æˆ¿å·¥ä½œç«™ - åŒ»é™¢é—¨è¯Šç®¡ç†ç³»ç»Ÿ</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- æ·»åŠ  Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../../styles/common.css">
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <!-- è¯å‰‚å¸ˆä¿¡æ¯æ¨ªå¹… -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4>ğŸ’Š æè¯å‰‚å¸ˆï¼Œæ¬¢è¿å›æ¥ï¼</h4>
                                <p class="mb-0">è¯æˆ¿ä¸»ç®¡ | ä»Šæ—¥å·²å¤„ç†å¤„æ–¹: <strong>15</strong> å¼ </p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="h5">ğŸ“… 2024å¹´1æœˆ15æ—¥</div>
                                <div>æ˜ŸæœŸä¸€ 10:00 AM</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- å¾…å¤„ç†å¤„æ–¹ -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">ğŸ“‹ å¾…å¤„ç†å¤„æ–¹</h5>
                        <span class="badge bg-warning">5å¼ å¾…å‘è¯</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>å¤„æ–¹å·</th>
                                        <th>æ‚£è€…</th>
                                        <th>å¼€å…·åŒ»ç”Ÿ</th>
                                        <th>å¼€å…·æ—¶é—´</th>
                                        <th>çŠ¶æ€</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ä»Šæ—¥å·²å®Œæˆå¤„æ–¹ -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">âœ… ä»Šæ—¥å·²å®Œæˆå¤„æ–¹</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>å¤„æ–¹å·</th>
                                        <th>æ‚£è€…</th>
                                        <th>å‘è¯æ—¶é—´</th>
                                        <th>çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¿«æ·åŠŸèƒ½å’Œåº“å­˜é¢„è­¦ -->
            <div class="col-md-4">
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="card-title mb-0">âš ï¸ åº“å­˜é¢„è­¦</h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                é˜¿è«è¥¿æ—èƒ¶å›Š
                                <span class="badge bg-danger">åº“å­˜ä¸è¶³</span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                æ„Ÿå†’çµé¢—ç²’
                                <span class="badge bg-warning">åº“å­˜ç´§å¼ </span>
                            </div>
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                é™å‹ç‰‡
                                <span class="badge bg-success">åº“å­˜æ­£å¸¸</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-body text-center">
                        <div class="h1 text-primary">ğŸ“¦</div>
                        <h5>åº“å­˜ç®¡ç†</h5>
                        <p class="card-text">è¯å“å…¥åº“å’Œåº“å­˜è°ƒæ•´</p>
                        <a href="inventory.html" class="btn btn-outline-primary w-100">ç®¡ç†åº“å­˜</a>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body text-center">
                        <div class="h1 text-info">ğŸ“Š</div>
                        <h5>ä»Šæ—¥ç»Ÿè®¡</h5>
                        <div class="row text-center mt-3">
                            <div class="col-6">
                                <div class="h5 text-primary">15</div>
                                <small>å¤„ç†å¤„æ–¹</small>
                            </div>
                            <div class="col-6">
                                <div class="h5 text-success">128</div>
                                <small>å‘æ”¾è¯å“</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¤„æ–¹è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="prescriptionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“„ å¤„æ–¹è¯¦æƒ… - <span id="modalPrescriptionId"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>æ‚£è€…:</strong> å¼ ä¸‰
                        </div>
                        <div class="col-md-6">
                            <strong>å¼€å…·åŒ»ç”Ÿ:</strong> å¼ åŒ»ç”Ÿ
                        </div>
                    </div>
                    
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>è¯å“åç§°</th>
                                <th>è§„æ ¼</th>
                                <th>æ•°é‡</th>
                                <th>ç”¨æ³•ç”¨é‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>é˜¿è«è¥¿æ—èƒ¶å›Š</td>
                                <td>0.25g*24ç²’</td>
                                <td>2ç›’</td>
                                <td>0.5gï¼Œä¸€æ—¥ä¸‰æ¬¡</td>
                            </tr>
                            <tr>
                                <td>æ„Ÿå†’çµé¢—ç²’</td>
                                <td>10g*9è¢‹</td>
                                <td>1ç›’</td>
                                <td>1è¢‹ï¼Œä¸€æ—¥ä¸‰æ¬¡</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-success" onclick="dispenseFromModal()">ç¡®è®¤å‘è¯</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å‘è¯ç¡®è®¤æ¨¡æ€æ¡† -->
    <div class="modal fade" id="confirmDispenseModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle-fill me-2"></i>ç¡®è®¤å‘è¯
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-4">
                        <i class="bi bi-capsule text-success" style="font-size: 4rem;"></i>
                    </div>
                    <h4 class="mb-3" id="confirmMessage"></h4>
                    <p class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        ç¡®è®¤åå°†æ‰£é™¤ç›¸åº”åº“å­˜å¹¶è®°å½•å‘è¯æ“ä½œ
                    </p>
                    <div class="alert alert-warning mt-3" role="alert">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œè¯·ä»”ç»†æ ¸å¯¹è¯å“ä¿¡æ¯
                    </div>
                </div>
                <div class="modal-footer justify-content-center border-0 pt-0">
                    <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">
                        <i class="bi bi-x-circle me-2"></i>å–æ¶ˆ
                    </button>
                    <button type="button" class="btn btn-success px-4" id="confirmDispenseBtn">
                        <i class="bi bi-check-circle me-2"></i>ç¡®è®¤å‘è¯
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../utils/helpers.js"></script>

    <script>
        // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            loadNavbar();
            loadPharmacistInfo();
            fetchPendingPrescriptions(); // â˜…â˜…â˜… è·å–å¾…å‘è¯åˆ—è¡¨ â˜…â˜…â˜…
            
            // ç»‘å®šç¡®è®¤æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('confirmDispenseBtn').addEventListener('click', confirmDispense);
        });

        function loadPharmacistInfo() {
            const infoStr = localStorage.getItem('pharmacistInfo');
            if (infoStr) {
                const info = JSON.parse(infoStr);
                const title = document.querySelector('.card-body h4');
                if(title) title.innerText = `ğŸ’Š ${info.staffName}ï¼Œæ¬¢è¿å›æ¥ï¼`;
            }
        }

        // 1. è·å–å¾…å‘è¯å¤„æ–¹
        async function fetchPendingPrescriptions() {
            const token = localStorage.getItem('token');
            if (!token) return window.location.href = 'login.html';

            try {
                // åç«¯æ¥å£: è·å–æ‰€æœ‰"æœªå‘è¯"çš„å¤„æ–¹
                const response = await fetch('http://localhost:8081/pharmacy/prescriptions/pending', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    }
                });

                const result = await response.json();

                if (result.code === 200) {
                    const list = result.data;
                    currentPrescriptionList = list;
                    renderTable(list);

                    // æ›´æ–°å³ä¸Šè§’"Xå¼ å¾…å‘è¯"çš„æ•°å­—
                    const badge = document.querySelector('.card-header .badge');
                    if(badge) badge.textContent = `${list.length}å¼ å¾…å‘è¯`;
                } else {
                    // å¦‚æœTokenè¿‡æœŸ
                    if(result.code === 401) window.location.href = 'login.html';
                    else showMessage('è·å–åˆ—è¡¨å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                console.error(error);
                showMessage('è¿æ¥æœåŠ¡å™¨å¤±è´¥', 'error');
            }
        }

        // 2. æ¸²æŸ“è¡¨æ ¼
        function renderTable(list) {
            const tbody = document.querySelector('table tbody');

            if (list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">æš‚æ— å¾…å‘è¯å¤„æ–¹</td></tr>';
                return;
            }

            tbody.innerHTML = list.map(item => `
            <tr>
                <td>${item.prescriptionId}</td>
                <td>
                    ${item.patientName}
                    <small class="text-muted">(${item.patientAge}å²)</small>
                </td>
                <td>${item.staffName} <small class="text-muted">(${item.deptName})</small></td>
                <td>${item.prescriptionDate.replace('T', ' ').substring(0, 16)}</td>
                <td><span class="badge bg-warning">${item.status}</span></td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="viewDetails(${item.prescriptionId})">æŸ¥çœ‹</button>
                </td>
            </tr>
        `).join('');
        }

        // 3. â˜…â˜…â˜… æ ¸å¿ƒåŠŸèƒ½ï¼šå‘è¯ â˜…â˜…â˜…
        let currentPrescriptionIdForDispense = null;

        // ç‚¹å‡»å‘è¯æŒ‰é’®æ—¶è°ƒç”¨
        function dispenseMedicine(prescriptionId) {
            currentPrescriptionIdForDispense = prescriptionId;
            
            // è®¾ç½®ç¡®è®¤æ¶ˆæ¯
            document.getElementById('confirmMessage').textContent = 
                `ç¡®è®¤å‘æ”¾è¯å“å—ï¼Ÿ`;
            
            // æ˜¾ç¤ºç¡®è®¤æ¨¡æ€æ¡†
            const confirmModal = new bootstrap.Modal(document.getElementById('confirmDispenseModal'));
            confirmModal.show();
        }

        // ç¡®è®¤å‘è¯çš„å‡½æ•°
        async function confirmDispense() {
            if (!currentPrescriptionIdForDispense) return;
            
            const prescriptionId = currentPrescriptionIdForDispense;
            
            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const confirmBtn = document.getElementById('confirmDispenseBtn');
                const originalText = confirmBtn.innerHTML;
                confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>å‘è¯ä¸­...';
                confirmBtn.disabled = true;
                
                const response = await fetch('http://localhost:8081/pharmacy/dispense', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': localStorage.getItem('token')
                    },
                    body: JSON.stringify({ prescriptionId: prescriptionId })
                });

                const result = await response.json();

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
                
                // å…³é—­ç¡®è®¤æ¨¡æ€æ¡†
                const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmDispenseModal'));
                if (confirmModal) {
                    confirmModal.hide();
                }
                
                if (result.code === 200) {
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showMessage('âœ… å‘è¯æˆåŠŸï¼', 'success');
                    
                    // åˆ·æ–°å¤„æ–¹åˆ—è¡¨
                    fetchPendingPrescriptions();
                    
                    // å¦‚æœè¯¦æƒ…æ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿå…³é—­å®ƒ
                    const detailModal = bootstrap.Modal.getInstance(document.getElementById('prescriptionModal'));
                    if (detailModal) {
                        detailModal.hide();
                    }
                } else {
                    showMessage('å‘è¯å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                console.error(error);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                const confirmBtn = document.getElementById('confirmDispenseBtn');
                confirmBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>ç¡®è®¤å‘è¯';
                confirmBtn.disabled = false;
                
                showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error');
            }
            
            currentPrescriptionIdForDispense = null;
        }

        // æŸ¥çœ‹è¯¦æƒ… (ç®€å•å¼¹çª—å±•ç¤º)
        let currentPrescriptionList = [];

        // çœŸæ­£å®ç°æŸ¥çœ‹è¯¦æƒ…åŠŸèƒ½
        function viewDetails(id) {
            // ä»å…¨å±€åˆ—è¡¨ä¸­æ‰¾åˆ°å½“å‰ç‚¹å‡»çš„å¤„æ–¹
            const prescription = currentPrescriptionList.find(p => p.prescriptionId === id);

            if (!prescription) {
                showMessage('æœªæ‰¾åˆ°å¤„æ–¹ä¿¡æ¯', 'error');
                return;
            }

            // å¡«å……æ¨¡æ€æ¡†æ ‡é¢˜
            document.getElementById('modalPrescriptionId').textContent = prescription.prescriptionId;

            const modalBody = document.querySelector('#prescriptionModal .modal-body');
            modalBody.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-6"><strong>æ‚£è€…:</strong> ${prescription.patientName}</div>
                    <div class="col-md-6"><strong>å¼€å…·åŒ»ç”Ÿ:</strong> ${prescription.staffName} (${prescription.deptName})</div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6"><strong>æ—¶é—´:</strong> ${prescription.prescriptionDate.replace('T', ' ').substring(0, 16)}</div>
                    <div class="col-md-6"><strong>æ€»é‡‘é¢:</strong> <span class="text-danger fw-bold">Â¥${prescription.billAmount || '-'}</span></div>
                </div>

                <h6 class="border-bottom pb-2">ğŸ’Š è¯å“æ˜ç»†</h6>
                <table class="table table-bordered table-sm">
                    <thead class="table-light">
                        <tr>
                            <th>è¯å“åç§°</th>
                            <th>è§„æ ¼</th>
                            <th>æ•°é‡</th>
                            <th>å•ä»·</th>
                            <th>å°è®¡</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${prescription.details ? prescription.details.map(d => `
                            <tr>
                                <td>${d.medicineName}</td>
                                <td>${d.specification || '-'}</td>
                                <td>${d.quantity}</td>
                                <td>Â¥${d.unitPrice}</td>
                                <td>Â¥${d.subtotal}</td>
                            </tr>
                        `).join('') : '<tr><td colspan="5" class="text-center">æ— è¯å“ä¿¡æ¯</td></tr>'}
                    </tbody>
                </table>
            `;

            // è®¾ç½®"ç¡®è®¤å‘è¯"æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            const confirmBtn = document.querySelector('#prescriptionModal .btn-success');
            confirmBtn.onclick = function() {
                dispenseFromModal(id); // ä¼ å…¥å½“å‰çš„ ID
            };

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(document.getElementById('prescriptionModal'));
            modal.show();
        }

        // è¾…åŠ©å‡½æ•°ï¼šä»æ¨¡æ€æ¡†ç¡®è®¤å‘è¯
        function dispenseFromModal(id) {
            // å…³é—­è¯¦æƒ…æ¨¡æ€æ¡†
            const modalEl = document.getElementById('prescriptionModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) {
                modal.hide();
            }
            
            // æ˜¾ç¤ºç¡®è®¤å‘è¯æ¨¡æ€æ¡†
            setTimeout(() => {
                dispenseMedicine(id);
            }, 300); // ç¨å¾®å»¶è¿Ÿï¼Œè®©ç”¨æˆ·çœ‹åˆ°æ¨¡æ€æ¡†å…³é—­
        }
    </script>
</body>
</html>