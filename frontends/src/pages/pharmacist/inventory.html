<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº“å­˜ç®¡ç† - åŒ»é™¢é—¨è¯Šç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/common.css">
    <style>
        .stock-low {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }
        .stock-critical {
            background-color: #f8d7da !important;
            border-left: 4px solid #dc3545;
        }
        .stock-good {
            border-left: 4px solid #28a745;
        }
        .inventory-card {
            transition: all 0.3s ease;
        }
        .inventory-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .stock-level {
            font-weight: bold;
            font-size: 1.1rem;
        }
        .stock-progress {
            height: 8px;
        }
        .batch-info {
            font-size: 0.875rem;
            color: #6c757d;
        }
        .filter-active {
            background-color: #667eea !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ“¦ åº“å­˜ç®¡ç†</h2>
            <div>
                <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#stockInModal">
                    ğŸ“¥ è¯å“å…¥åº“
                </button>
                <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#adjustStockModal">
                    ğŸ“Š åº“å­˜è°ƒæ•´
                </button>
            </div>
        </div>

        <!-- åº“å­˜æ¦‚è§ˆ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center inventory-card">
                    <div class="card-body">
                        <div class="h4 text-primary">156</div>
                        <div class="text-muted">è¯å“å“ç±»</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center inventory-card">
                    <div class="card-body">
                        <div class="h4 text-success">Â¥286,540</div>
                        <div class="text-muted">åº“å­˜æ€»å€¼</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center inventory-card">
                    <div class="card-body">
                        <div class="h4 text-warning">12</div>
                        <div class="text-muted">åº“å­˜é¢„è­¦</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center inventory-card">
                    <div class="card-body">
                        <div class="h4 text-danger">3</div>
                        <div class="text-muted">ç¼ºè´§è¯å“</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç­›é€‰å’Œæœç´¢ -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control" placeholder="æœç´¢è¯å“åç§°..." id="searchMedicine">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="categoryFilter">
                            <option value="">æ‰€æœ‰åˆ†ç±»</option>
                            <option value="æŠ—ç”Ÿç´ ">æŠ—ç”Ÿç´ </option>
                            <option value="æ„Ÿå†’è¯">æ„Ÿå†’è¯</option>
                            <option value="å¿ƒè¡€ç®¡">å¿ƒè¡€ç®¡</option>
                            <option value="ç»´ç”Ÿç´ ">ç»´ç”Ÿç´ </option>
                            <option value="å¤–ç”¨">å¤–ç”¨</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="stockFilter">
                            <option value="">æ‰€æœ‰åº“å­˜çŠ¶æ€</option>
                            <option value="critical">åº“å­˜ç´§å¼ </option>
                            <option value="low">åº“å­˜ä¸è¶³</option>
                            <option value="good">åº“å­˜æ­£å¸¸</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="applyFilters()">ç­›é€‰</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº“å­˜åˆ—è¡¨ -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">è¯å“åº“å­˜åˆ—è¡¨</h5>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary active" onclick="changeView('table')">è¡¨æ ¼è§†å›¾</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="changeView('card')">å¡ç‰‡è§†å›¾</button>
                </div>
            </div>
            <div class="card-body">
                <!-- è¡¨æ ¼è§†å›¾ -->
                <div id="tableView">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>è¯å“ID</th>
                                    <th>è¯å“åç§°</th>
                                    <th>è§„æ ¼</th>
                                    <th>åˆ†ç±»</th>
                                    <th>å½“å‰åº“å­˜</th>
                                    <th>åº“å­˜çŠ¶æ€</th>
                                    <th>æœ€è¿‘å…¥åº“</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTable">
                                <!-- åŠ¨æ€ç”Ÿæˆåº“å­˜æ•°æ® -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- å¡ç‰‡è§†å›¾ -->
                <div id="cardView" class="d-none">
                    <div class="row" id="inventoryCards">
                        <!-- åŠ¨æ€ç”Ÿæˆåº“å­˜å¡ç‰‡ -->
                    </div>
                </div>

                <!-- åˆ†é¡µ -->
                <nav class="mt-4">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled">
                            <a class="page-link" href="#">ä¸Šä¸€é¡µ</a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                        <li class="page-item"><a class="page-link" href="#">3</a></li>
                        <li class="page-item">
                            <a class="page-link" href="#">ä¸‹ä¸€é¡µ</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>

        <!-- åº“å­˜é¢„è­¦åŒºåŸŸ -->
        <div class="card mt-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">âš ï¸ åº“å­˜é¢„è­¦</h5>
            </div>
            <div class="card-body">
                <div class="row" id="warningItems">
                    <!-- åŠ¨æ€ç”Ÿæˆé¢„è­¦é¡¹ç›® -->
                </div>
            </div>
        </div>
    </div>

    <!-- è¯å“å…¥åº“æ¨¡æ€æ¡† -->
    <div class="modal fade" id="stockInModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“¥ è¯å“å…¥åº“</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="stockInForm">
                        <div class="mb-3">
                            <label class="form-label">é€‰æ‹©è¯å“</label>
                            <select class="form-select" id="stockInMedicine" required>
                                <option value="">è¯·é€‰æ‹©è¯å“</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å…¥åº“æ•°é‡</label>
                            <input type="number" class="form-control" id="stockInQuantity" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å…¥åº“åŸå› </label>
                            <select class="form-select" id="stockInReason">
                                <option value="é‡‡è´­å…¥åº“" selected>é‡‡è´­å…¥åº“</option>
                                <option value="ç›˜ç›ˆå…¥åº“">ç›˜ç›ˆå…¥åº“</option>
                                <option value="é€€è¯å…¥åº“">é€€è¯å…¥åº“</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="processStockIn()">ç¡®è®¤å…¥åº“</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åº“å­˜è°ƒæ•´æ¨¡æ€æ¡† -->
    <div class="modal fade" id="adjustStockModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“Š åº“å­˜è°ƒæ•´</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="adjustStockForm">
                        <div class="mb-3">
                            <label class="form-label">é€‰æ‹©è¯å“</label>
                            <select class="form-select" id="adjustMedicine" required>
                                <option value="">è¯·é€‰æ‹©è¯å“</option>
                                <!-- åŠ¨æ€å¡«å……è¯å“é€‰é¡¹ -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">è°ƒæ•´ç±»å‹</label>
                            <select class="form-select" id="adjustType" required>
                                <option value="increase">å¢åŠ åº“å­˜</option>
                                <option value="decrease">å‡å°‘åº“å­˜</option>
                                <option value="set">è®¾ç½®åº“å­˜</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">è°ƒæ•´æ•°é‡</label>
                            <input type="number" class="form-control" id="adjustQuantity" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">è°ƒæ•´åŸå› </label>
                            <select class="form-select" id="adjustReason" required>
                                <option value="">è¯·é€‰æ‹©åŸå› </option>
                                <option value="ç›˜ç‚¹å·®å¼‚">ç›˜ç‚¹å·®å¼‚</option>
                                <option value="æŠ¥æŸ">æŠ¥æŸ</option>
                                <option value="å…¶ä»–">å…¶ä»–</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">å¤‡æ³¨è¯´æ˜</label>
                            <textarea class="form-control" id="adjustNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="processStockAdjust()">ç¡®è®¤è°ƒæ•´</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åº“å­˜è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="stockDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ğŸ“‹ åº“å­˜è¯¦æƒ… - <span id="detailMedicineName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <strong>å½“å‰åº“å­˜:</strong> <span id="detailCurrentStock" class="stock-level"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>åº“å­˜çŠ¶æ€:</strong> <span id="detailStockStatus"></span>
                        </div>
                    </div>
                    
                    <h6>åº“å­˜æµæ°´</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>ç±»å‹</th>
                                    <th>æ•°é‡</th>
                                    <th>åŸå› </th>
                                    <th>æ“ä½œäºº</th>
                                </tr>
                            </thead>
                            <tbody id="stockHistory">
                                <!-- åŠ¨æ€ç”Ÿæˆåº“å­˜æµæ°´ -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../utils/helpers.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let inventoryList = [];
        let allMedicines = []; // ç”¨äºä¸‹æ‹‰æ¡†é€‰æ‹©
        let currentMedicineLogs = []; // å½“å‰æŸ¥çœ‹çš„æµæ°´

        document.addEventListener('DOMContentLoaded', function() {
            loadNavbar();
            fetchInventory(); // åŠ è½½åº“å­˜åˆ—è¡¨
            setupEventListeners();
        });

        // 1. â˜…â˜…â˜… è·å–åº“å­˜åˆ—è¡¨ (å¤ç”¨è¯å“æŸ¥è¯¢æ¥å£) â˜…â˜…â˜…
        async function fetchInventory() {
            const token = localStorage.getItem('token');
            if (!token) return window.location.href = 'login.html';

            try {
                // æ¥å£: GET /medicine (è¿™é‡Œæˆ‘ä»¬å–100æ¡å±•ç¤º)
                const response = await fetch('http://localhost:8081/medicine?page=1&pageSize=100', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token
                    }
                });

                const result = await response.json();

                if (result.code === 200) {
                    inventoryList = result.data.records;
                    allMedicines = result.data.records; // å­˜ä¸€ä»½ç»™ä¸‹æ‹‰æ¡†ç”¨
                    renderInventoryTable();
                    updateStats(); // æ›´æ–°é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡
                } else {
                    if (result.code === 401) window.location.href = 'login.html';
                    else showMessage('åŠ è½½å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                console.error(error);
                showMessage('è¿æ¥æœåŠ¡å™¨å¤±è´¥', 'error');
            }
        }

        // 2. æ¸²æŸ“åº“å­˜è¡¨æ ¼
        function renderInventoryTable() {
            const tbody = document.getElementById('inventoryTable');

            if (inventoryList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">æš‚æ— è¯å“æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = inventoryList.map(item => {
                // è®¡ç®—åº“å­˜çŠ¶æ€ (å‡è®¾å®‰å…¨åº“å­˜ä¸º20)
                const minStock = 20;
                let statusBadge = '<span class="badge bg-success">å……è¶³</span>';
                let rowClass = '';

                if (item.stockLevel === 0) {
                    statusBadge = '<span class="badge bg-danger">ç¼ºè´§</span>';
                    rowClass = 'table-danger';
                } else if (item.stockLevel < minStock) {
                    statusBadge = '<span class="badge bg-warning text-dark">ç´§å¼ </span>';
                    rowClass = 'table-warning';
                }

                return `
                <tr class="${rowClass}">
                    <td>${item.medicineId}</td>
                    <td>
                        <strong>${item.medicineName}</strong>
                        <div class="small text-muted">${item.specification || '-'}</div>
                    </td>
                    <td>${item.manufacturer || '-'}</td>
                    <td>Â¥${item.unitPrice}</td>
                    <td class="fw-bold">${item.stockLevel}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewStockHistory(${item.medicineId}, '${item.medicineName}')">æµæ°´</button>
                        <button class="btn btn-sm btn-primary" onclick="openStockInModal(${item.medicineId})">å…¥åº“</button>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // 3. â˜…â˜…â˜… å‡†å¤‡å…¥åº“å¼¹çª— â˜…â˜…â˜…
        function openStockInModal(medicineId) {
            // å¡«å……è¯å“ä¸‹æ‹‰æ¡†
            const select = document.getElementById('stockInMedicine');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©è¯å“</option>' +
                allMedicines.map(m => `<option value="${m.medicineId}">${m.medicineName}</option>`).join('');

            // å¦‚æœä¼ äº†IDï¼Œè‡ªåŠ¨é€‰ä¸­
            if (medicineId) {
                select.value = medicineId;
            }

            // é‡ç½®å…¶ä»–å­—æ®µ
            document.getElementById('stockInQuantity').value = '';
            document.getElementById('stockInReason').value = 'é‡‡è´­å…¥åº“';

            const modal = new bootstrap.Modal(document.getElementById('stockInModal'));
            modal.show();
        }

        // 4. â˜…â˜…â˜… æäº¤å…¥åº“ â˜…â˜…â˜…
        async function processStockIn() {
            const medicineId = document.getElementById('stockInMedicine').value;
            const quantity = document.getElementById('stockInQuantity').value;
            const reason = document.getElementById('stockInReason').value;

            if (!medicineId || !quantity || quantity <= 0) {
                showMessage('è¯·å¡«å†™æ­£ç¡®çš„è¯å“å’Œæ•°é‡', 'warning');
                return;
            }

            try {
                // æ¥å£: POST /inventory/inbound
                const response = await fetch('http://localhost:8081/inventory/inbound', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': localStorage.getItem('token')
                    },
                    body: JSON.stringify({
                        medicineId: parseInt(medicineId),
                        quantity: parseInt(quantity),
                        reason: reason
                    })
                });

                const result = await response.json();

                if (result.code === 200) {
                    showMessage('å…¥åº“æˆåŠŸï¼', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('stockInModal')).hide();
                    fetchInventory(); // åˆ·æ–°åˆ—è¡¨ï¼Œåº“å­˜åº”è¯¥å¢åŠ äº†
                } else {
                    showMessage('å…¥åº“å¤±è´¥: ' + result.message, 'error');
                }
            } catch (error) {
                console.error(error);
                showMessage('æ“ä½œå¤±è´¥', 'error');
            }
        }

        // 5. â˜…â˜…â˜… æŸ¥çœ‹åº“å­˜æµæ°´ â˜…â˜…â˜…
        async function viewStockHistory(medicineId, medicineName) {
            document.getElementById('detailMedicineName').textContent = medicineName;

            try {
                // æ¥å£: GET /inventory/logs?medicineId=xxx
                const response = await fetch(`http://localhost:8081/inventory/logs?medicineId=${medicineId}&page=1&pageSize=20`, {
                    method: 'GET',
                    headers: { 'Authorization': localStorage.getItem('token') }
                });

                const result = await response.json();
                if (result.code === 200) {
                    renderHistoryTable(result.data.records);
                    new bootstrap.Modal(document.getElementById('stockDetailModal')).show();
                }
            } catch (error) {
                console.error(error);
            }
        }

        function renderHistoryTable(logs) {
            const tbody = document.getElementById('stockHistory');
            if (!logs || logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">æš‚æ— è®°å½•</td></tr>';
                return;
            }

            tbody.innerHTML = logs.map(log => {
                const isAdd = log.changeQuantity > 0;
                const colorClass = isAdd ? 'text-success' : 'text-danger';
                const sign = isAdd ? '+' : '';

                return `
                <tr>
                    <td>${log.createTime.replace('T', ' ')}</td>
                    <td>${log.reason}</td>
                    <td class="${colorClass} fw-bold">${sign}${log.changeQuantity}</td>
                    <td>${log.relatedId ? '#' + log.relatedId : '-'}</td>
                </tr>
            `;
            }).join('');
        }

        // æ›´æ–°é¡¶éƒ¨ç»Ÿè®¡
        function updateStats() {
            // ç®€å•è®¡ç®—ä¸€ä¸‹æ€»åº“å­˜ä»·å€¼
            const totalValue = inventoryList.reduce((sum, item) => sum + (item.unitPrice * item.stockLevel), 0);
            const lowStockCount = inventoryList.filter(i => i.stockLevel < 20).length;

            // éœ€è¦ç¡®ä¿HTMLé‡Œæœ‰è¿™äº›IDæ‰èƒ½æ›´æ–°ï¼Œè¿™é‡Œåšä¸ªç®€å•çš„å®¹é”™
            const cardValues = document.querySelectorAll('.card-body .h4');
            if(cardValues.length >= 3) {
                cardValues[0].textContent = inventoryList.length; // å“ç±»
                cardValues[1].textContent = 'Â¥' + totalValue.toFixed(0); // æ€»å€¼
                cardValues[2].textContent = lowStockCount; // é¢„è­¦
            }
        }

        function setupEventListeners() {
            // ç®€å•çš„æœç´¢
            document.getElementById('searchMedicine').addEventListener('input', function(e) {
                const term = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#inventoryTable tr');
                rows.forEach(row => {
                    const text = row.innerText.toLowerCase();
                    row.style.display = text.includes(term) ? '' : 'none';
                });
            });

            // ç»‘å®šå…¥åº“ç¡®è®¤æŒ‰é’® (å¦‚æœç”¨äº†onclickè¿™é‡Œå¯ä»¥çœç•¥ï¼Œä½†å»ºè®®ç»Ÿä¸€ç®¡ç†)
        }

        // å ä½å‡½æ•°
        function processStockAdjust() { alert('åº“å­˜è°ƒæ•´åŠŸèƒ½æš‚æœªå¼€æ”¾ï¼Œè¯·ä½¿ç”¨"å…¥åº“"åŠŸèƒ½'); }
    </script>
</body>
</html>