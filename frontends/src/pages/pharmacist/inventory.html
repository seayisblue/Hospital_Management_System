<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº“å­˜ç®¡ç† - åŒ»é™¢é—¨è¯Šç®¡ç†ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/common.css">
    <style>
        .stock-low {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }
        .stock-critical {
            background-color: #f8d7da !important;
            border-left: 4px solid #dc3545;
        }

        .stock-level {
            font-weight: bold;
            font-size: 1.1rem;
        }
        /* ç»Ÿä¸€é«˜åº¦ï¼Œé¿å…æŒ‰é’®å’Œè¾“å…¥æ¡†å¯¹ä¸é½ */
        .uniform-height {
            height: 38px;
        }
        /* æ“ä½œåˆ—æŒ‰é’®é—´è· */
        .action-btn {
            margin-right: 4px;
        }
    </style>
</head>
<body>
<div id="navbar-container"></div>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <a href="dashboard.html" class="btn btn-outline-secondary me-2">ğŸ  é¦–é¡µ</a>
        <h2>ğŸ“¦ åº“å­˜ç®¡ç†</h2>
        <div class="invisible">
            <a href="#" class="btn btn-outline-secondary">ğŸ  é¦–é¡µ</a>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center inventory-card">
                <div class="card-body">
                    <div class="h4 text-primary" id="stat-total">0</div>
                    <div class="text-muted">è¯å“å“ç±»</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center inventory-card">
                <div class="card-body">
                    <div class="h4 text-success" id="stat-value">Â¥0</div>
                    <div class="text-muted">åº“å­˜æ€»å€¼</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center inventory-card">
                <div class="card-body">
                    <div class="h4 text-warning" id="stat-low">0</div>
                    <div class="text-muted">åº“å­˜é¢„è­¦</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center inventory-card">
                <div class="card-body">
                    <div class="h4 text-danger" id="stat-out">0</div>
                    <div class="text-muted">ç¼ºè´§è¯å“</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <!-- å·¦ä¾§ï¼šæœç´¢ -->
                <div class="col-md-5">
                    <div class="input-group">
                        <span class="input-group-text">ğŸ”</span>
                        <input type="text"
                               class="form-control uniform-height"
                               placeholder="è¾“å…¥è¯å“åç§°"
                               id="searchMedicine">
                    </div>
                </div>

                <!-- å³ä¾§ï¼šåº“å­˜çŠ¶æ€ï¼ˆå…³é”®åœ¨ ms-autoï¼‰ -->
                <div class="col-md-3 ms-auto">
                    <select class="form-select uniform-height" id="stockFilter">
                        <option value="">æ‰€æœ‰åº“å­˜çŠ¶æ€</option>
                        <option value="critical">ğŸ”´ ç¼ºè´§</option>
                        <option value="low">ğŸŸ¡ é¢„è­¦</option>
                        <option value="good">ğŸŸ¢ å……è¶³</option>
                    </select>
                </div>
            </div>
        </div>
    </div>


    <div class="card">
        <div class="card-body p-0">
            <div id="tableView">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                        <tr>
                            <th class="ps-3">ID</th>
                            <th>è¯å“åç§°</th>
                            <th>è§„æ ¼ / å‚å®¶</th>
                            <th>å•ä»·</th>
                            <th>åº“å­˜æ•°</th>
                            <th>çŠ¶æ€</th>
                            <th class="text-end pe-3">æ“ä½œ</th>
                        </tr>
                        </thead>
                        <tbody id="inventoryTable">
                        </tbody>
                    </table>
                </div>
            </div>


        </div>
        <div class="card-footer bg-white">
            <nav>
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item disabled"><a class="page-link">ä¸Šä¸€é¡µ</a></li>
                    <li class="page-item active"><a class="page-link">1</a></li>
                    <li class="page-item disabled"><a class="page-link">ä¸‹ä¸€é¡µ</a></li>
                </ul>
            </nav>
        </div>
    </div>

    <div class="alert alert-warning mt-4 d-none" id="warningAlert">
        <h5>âš ï¸ ç¼ºè´§ä¸é¢„è­¦æé†’</h5>
        <div class="row" id="warningItems"></div>
    </div>
</div>

<div class="modal fade" id="stockInModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">ğŸ“¥ è¯å“å…¥åº“</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="stockInForm">
                    <div class="mb-3">
                        <label class="form-label">è¯å“åç§°</label>
                        <select class="form-select" id="stockInMedicine" required>
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å…¥åº“æ•°é‡</label>
                        <input type="number" class="form-control" id="stockInQuantity" min="1" placeholder="è¾“å…¥æ­£æ•´æ•°" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å…¥åº“ç±»å‹</label>
                        <select class="form-select" id="stockInReason">
                            <option value="é‡‡è´­å…¥åº“" selected>é‡‡è´­å…¥åº“</option>
                            <option value="ç›˜ç›ˆå…¥åº“">ç›˜ç›ˆå…¥åº“</option>
                            <option value="é€€è¯å…¥åº“">é€€è¯å…¥åº“</option>
                            <option value="å…¶ä»–">å…¶ä»–</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="processStockIn()">ç¡®è®¤å…¥åº“</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="adjustStockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">ğŸ“Š åº“å­˜è°ƒæ•´ (ç›˜ç‚¹/æŠ¥æŸ)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="adjustStockForm">
                    <div class="mb-3">
                        <label class="form-label">å½“å‰è¯å“</label>
                        <select class="form-select" id="adjustMedicine" required disabled>
                            <option value="">åŠ è½½ä¸­...</option>
                        </select>
                    </div>
                    <div class="alert alert-light border small">
                        æ­¤åŠŸèƒ½ç”¨äºä¿®æ­£åº“å­˜å·®å¼‚ã€‚å¦‚éœ€æ­£å¸¸è¿›è´§è¯·ä½¿ç”¨â€œå…¥åº“â€ã€‚
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">è°ƒæ•´æ–¹å‘</label>
                            <select class="form-select" id="adjustType">
                                <option value="increase">â• å¢åŠ åº“å­˜</option>
                                <option value="decrease">â– å‡å°‘åº“å­˜</option>
                            </select>
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">æ•°é‡</label>
                            <input type="number" class="form-control" id="adjustQuantity" min="1" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">è°ƒæ•´åŸå› </label>
                        <select class="form-select" id="adjustReason">
                            <option value="ç›˜ç‚¹å·®å¼‚">ç›˜ç‚¹å·®å¼‚</option>
                            <option value="æŠ¥æŸ">è¯å“æŠ¥æŸ/è¿‡æœŸ</option>
                            <option value="æ•°æ®ä¿®æ­£">æ•°æ®é”™è¯¯ä¿®æ­£</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-warning" onclick="processStockAdjust()">æäº¤è°ƒæ•´</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="stockDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ“‹ åº“å­˜æµæ°´ - <span id="detailMedicineName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-striped table-sm">
                    <thead>
                    <tr><th>æ—¶é—´</th><th>å˜åŠ¨ç±»å‹</th><th>æ•°é‡</th><th>å•å·</th></tr>
                    </thead>
                    <tbody id="stockHistory"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="../../utils/helpers.js"></script>

<script>
    let inventoryList = [];
    let displayedList = [];

    document.addEventListener('DOMContentLoaded', function() {
        loadNavbar();
        fetchInventory();

        document.getElementById('searchMedicine').addEventListener('input', applyFilters);
        document.getElementById('stockFilter').addEventListener('change', applyFilters);
    });

    async function fetchInventory() {
        const token = localStorage.getItem('token');
        if (!token) return window.location.href = 'login.html';

        try {
            const response = await fetch('http://localhost:8081/medicine?page=1&pageSize=100', {
                headers: { 'Authorization': token }
            });
            const result = await response.json();
            if (result.code === 200) {
                inventoryList = result.data.records;
                displayedList = inventoryList;
                renderAll();
            } else {
                showMessage(result.message, 'error');
            }
        } catch (e) {
            console.error(e);
            showMessage('ç½‘ç»œé”™è¯¯', 'error');
        }
    }

    function renderAll() {
        renderTable();

        updateStats();
        renderWarningItems();
    }

    function renderTable() {
        const tbody = document.getElementById('inventoryTable');
        if (displayedList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">æš‚æ— æ•°æ®</td></tr>';
            return;
        }

        tbody.innerHTML = displayedList.map(item => {
            const min = item.minStock || 20;
            let statusBadge = '<span class="badge bg-success">å……è¶³</span>';
            let rowClass = '';

            if (item.stockLevel <= 0) {
                statusBadge = '<span class="badge bg-danger">ç¼ºè´§</span>';
                rowClass = 'stock-critical';
            } else if (item.stockLevel < min) {
                statusBadge = '<span class="badge bg-warning text-dark">é¢„è­¦</span>';
                rowClass = 'stock-low';
            }

            return `
                <tr class="${rowClass}">
                    <td class="ps-3">${item.medicineId}</td>
                    <td>
                        <div class="fw-bold">${item.medicineName}</div>
                    </td>
                    <td>
                        <small class="d-block text-muted">${item.specification || '-'}</small>
                        <small class="text-secondary">${item.manufacturer || '-'}</small>
                    </td>
                    <td>Â¥${item.unitPrice}</td>
                    <td><span class="fs-5 fw-bold">${item.stockLevel}</span></td>
                    <td>${statusBadge}</td>
                    <td class="text-end pe-3">
                        <button class="btn btn-sm btn-outline-primary action-btn" onclick="openStockInModal(${item.medicineId})">å…¥åº“</button>
                        <button class="btn btn-sm btn-outline-warning action-btn" onclick="openAdjustStockModal(${item.medicineId})">è°ƒæ•´</button>
                        <button class="btn btn-sm btn-light border" onclick="viewLogs(${item.medicineId}, '${item.medicineName}')">æµæ°´</button>
                    </td>
                </tr>`;
        }).join('');
    }



    function updateStats() {
        document.getElementById('stat-total').textContent = inventoryList.length;
        document.getElementById('stat-value').textContent = 'Â¥' + inventoryList.reduce((s,i)=>s+i.unitPrice*i.stockLevel,0).toLocaleString();
        document.getElementById('stat-low').textContent = inventoryList.filter(i=>i.stockLevel>0 && i.stockLevel<(i.minStock||20)).length;
        document.getElementById('stat-out').textContent = inventoryList.filter(i=>i.stockLevel<=0).length;
    }

    function renderWarningItems() {
        const warningList = inventoryList.filter(i => i.stockLevel < (i.minStock||20));
        const container = document.getElementById('warningItems');
        const alertBox = document.getElementById('warningAlert');

        if(warningList.length === 0) {
            alertBox.classList.add('d-none');
            return;
        }

        alertBox.classList.remove('d-none');
        container.innerHTML = warningList.map(item => `
                <div class="col-md-3 mb-2">
                    <div class="d-flex justify-content-between border p-2 bg-white rounded">
                        <div>
                            <div class="fw-bold">${item.medicineName}</div>
                            <small class="text-danger">ä½™: ${item.stockLevel}</small>
                        </div>
                        <button class="btn btn-sm btn-link" onclick="openStockInModal(${item.medicineId})">è¡¥è´§</button>
                    </div>
                </div>
            `).join('');
    }

    // â˜…â˜…â˜… æ ¸å¿ƒé€»è¾‘ï¼šæ‰“å¼€å…¥åº“å¼¹çª— â˜…â˜…â˜…
    function openStockInModal(medicineId) {
        const select = document.getElementById('stockInMedicine');
        // å¡«å……ä¸‹æ‹‰æ¡†
        select.innerHTML = '<option value="">è¯·é€‰æ‹©è¯å“...</option>' +
            inventoryList.map(m => `<option value="${m.medicineId}">${m.medicineName} (ä½™: ${m.stockLevel})</option>`).join('');

        // å¦‚æœä¼ äº†IDï¼ˆä»è¡¨æ ¼ç‚¹å‡»ï¼‰ï¼Œåˆ™é€‰ä¸­å¹¶ç¦ç”¨ä¸‹æ‹‰æ¡†
        if(medicineId) {
            select.value = medicineId;
            select.disabled = true;
        } else {
            select.value = "";
            select.disabled = false; // é¡¶éƒ¨æŒ‰é’®ç‚¹å‡»ï¼Œå…è®¸è‡ªé€‰
        }

        document.getElementById('stockInQuantity').value = '';
        new bootstrap.Modal(document.getElementById('stockInModal')).show();
    }

    // â˜…â˜…â˜… æ ¸å¿ƒé€»è¾‘ï¼šæ‰“å¼€è°ƒæ•´å¼¹çª— â˜…â˜…â˜…
    function openAdjustStockModal(medicineId) {
        const select = document.getElementById('adjustMedicine');
        select.innerHTML = inventoryList.map(m => `<option value="${m.medicineId}">${m.medicineName}</option>`).join('');

        // è°ƒæ•´å¿…é¡»æŒ‡å®šè¯å“ï¼Œæ‰€ä»¥å¦‚æœæ˜¯ä»é¡¶éƒ¨ç‚¹çš„ï¼ˆæ²¡ä¼ IDï¼‰ï¼Œå…ˆé»˜è®¤é€‰ç¬¬ä¸€ä¸ªæˆ–è€…æç¤º
        if(medicineId) {
            select.value = medicineId;
        }
        select.disabled = true; // è°ƒæ•´é€šå¸¸é’ˆå¯¹å•å“ï¼Œç¦ç”¨ä¿®æ”¹é˜²æ­¢è¯¯æ“ä½œ

        document.getElementById('adjustQuantity').value = '';
        new bootstrap.Modal(document.getElementById('adjustStockModal')).show();
    }



    function applyFilters() {
        const kw = document.getElementById('searchMedicine').value.toLowerCase();
        const type = document.getElementById('stockFilter').value;

        displayedList = inventoryList.filter(item => {
            const matchName = item.medicineName.toLowerCase().includes(kw);
            const min = item.minStock || 20;
            let matchType = true;
            if(type === 'critical') matchType = item.stockLevel < min;
            if(type === 'good') matchType = item.stockLevel >= min;
            return matchName && matchType;
        });
        renderTable();

    }

    // å…¥åº“æäº¤
    async function processStockIn() {
        const id = document.getElementById('stockInMedicine').value;
        const qty = document.getElementById('stockInQuantity').value;
        const reason = document.getElementById('stockInReason').value;
        if(!id || !qty || qty<=0) { showMessage('æ— æ•ˆæ•°æ®', 'warning'); return; }

        try {
            await fetch('http://localhost:8081/inventory/inbound', {
                method: 'POST',
                headers: {'Content-Type':'application/json', 'Authorization': localStorage.getItem('token')},
                body: JSON.stringify({ medicineId: id, quantity: parseInt(qty), reason: reason })
            });
            showMessage('å…¥åº“æˆåŠŸ', 'success');
            bootstrap.Modal.getInstance(document.getElementById('stockInModal')).hide();
            fetchInventory();
        } catch(e) { showMessage('æ“ä½œå¤±è´¥', 'error'); }
    }

    // è°ƒæ•´æäº¤
    async function processStockAdjust() {
        const id = document.getElementById('adjustMedicine').value;
        const type = document.getElementById('adjustType').value; // 'increase' æˆ– 'decrease'
        let qty = parseInt(document.getElementById('adjustQuantity').value); // è·å–ç»å¯¹å€¼
        const reason = document.getElementById('adjustReason').value;

        // 1. åŸºç¡€æ ¡éªŒ
        if (!id || !qty || qty <= 0) {
            showMessage('è¯·å¡«å†™å®Œæ•´çš„è°ƒæ•´ä¿¡æ¯ï¼ˆæ•°é‡å¿…é¡»ä¸ºæ­£æ•´æ•°ï¼‰', 'warning');
            return;
        }

        // 2. å…³é”®é€»è¾‘ï¼šå¦‚æœæ˜¯â€œå‡å°‘åº“å­˜â€ï¼ŒæŠŠæ•°é‡è½¬ä¸ºè´Ÿæ•°
        if (type === 'decrease') {
            qty = -qty;
        }

        try {
            // 3. è°ƒç”¨åˆšæ‰å†™çš„åç«¯æ¥å£ /inventory/adjust
            const response = await fetch('http://localhost:8081/inventory/adjust', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': localStorage.getItem('token')
                },
                body: JSON.stringify({
                    medicineId: parseInt(id),
                    quantity: qty, // å‘é€å¸¦ç¬¦å·çš„æ•´æ•° (å¦‚ -5 æˆ– 5)
                    reason: reason
                })
            });

            const result = await response.json();

            if (result.code === 200) {
                showMessage('åº“å­˜è°ƒæ•´æˆåŠŸï¼', 'success');
                // å…³é—­å¼¹çª—
                bootstrap.Modal.getInstance(document.getElementById('adjustStockModal')).hide();
                // åˆ·æ–°åˆ—è¡¨
                fetchInventory();
            } else {
                showMessage('è°ƒæ•´å¤±è´¥: ' + result.message, 'error');
            }
        } catch (error) {
            console.error(error);
            showMessage('ç½‘ç»œè¿æ¥é”™è¯¯', 'error');
        }
    }

    // æŸ¥çœ‹æµæ°´
    async function viewLogs(id, name) {
        document.getElementById('detailMedicineName').textContent = name;
        const tbody = document.getElementById('stockHistory');
        tbody.innerHTML = '<tr><td colspan="4">åŠ è½½ä¸­...</td></tr>';
        new bootstrap.Modal(document.getElementById('stockDetailModal')).show();

        try {
            const res = await fetch(`http://localhost:8081/inventory/logs?medicineId=${id}`, {
                headers: {'Authorization': localStorage.getItem('token')}
            });
            const data = await res.json();
            const logs = data.data.records || [];
            tbody.innerHTML = logs.length ? logs.map(l => `
                    <tr>
                        <td>${l.createTime.replace('T',' ')}</td>
                        <td>${l.reason}</td>
                        <td class="${l.changeQuantity>0?'text-success':'text-danger'} fw-bold">${l.changeQuantity>0?'+':''}${l.changeQuantity}</td>
                        <td>${l.relatedId||'-'}</td>
                    </tr>`).join('') : '<tr><td colspan="4" class="text-center text-muted">æš‚æ— è®°å½•</td></tr>';
        } catch(e) { tbody.innerHTML = '<tr><td colspan="4">åŠ è½½å¤±è´¥</td></tr>'; }
    }
</script>
</body>
</html>